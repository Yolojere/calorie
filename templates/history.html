<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nutrition & Workout History</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Calibri&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        /* === MAIN STYLES === */
body {
    font-family: 'Calibri', sans-serif;
    font-size: 15px;
    background-color: #222 !important;
    color: #e0e0e0;
}

.bg-black, .modal-header, .modal-footer {
    background-color: #000 !important;
    border-color: #444;
}

.card, .list-group-item, .modal-content {
    background-color: #222;
    color: #e0e0e0;
    border: 1px solid #444;
}

.form-control, .form-select {
    background-color: #333;
    color: #e0e0e0;
    border: 1px solid #555;
    font-size: 14px !important;
    padding: 6px 8px !important;
    height: 36px !important;
}

.form-control:focus, .form-select:focus {
    background-color: #b4b4b4;
    color: #ffffff;
    border-color: #d1d1d1;
}

.nav-link-box {
    background-color: white !important;
    color: black !important;
    border-radius: 20px;
    padding: 10px !important;
    margin: 0 3px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    width: 45px;
    height: 45px;
}

.nav-link-box:hover {
    background-color: #f0f0f0 !important;
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
}

.nav-link-box i {
    font-size: 20px !important;
    margin: 0 !important;
}

.mobile-settings-btn {
    background-color: white !important;
    color: black !important;
    border-radius: 50%;
    padding: 10px !important;
    width: 45px;
    height: 45px;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    transition: all 0.3s ease;
    margin-left: 10px;
}

.mobile-settings-btn:hover {
    background-color: #f0f0f0 !important;
    transform: translateY(-4px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
}

.mobile-settings-btn i {
    font-size: 20px !important;
    margin: 0 !important;
}

/* === HISTORY PAGE SPECIFIC STYLES === */
.history-container {
    max-width: 1200px;
    margin: 20px auto;
    padding: 0 15px;
}

.card-header {
    font-size: 20px;
    padding: 15px 20px;
    background-color: #000 !important;
    border-bottom: 1px solid #444;
}

/* Tabs Styling */
.nav-tabs {
    border-bottom: 2px solid #ffffff;
    border-radius: 5px;
    padding: 0 15px;
}

.nav-tabs .nav-link {
    font-size: 18px;
    padding: 10px 20px;
    color: white;
    background-color: #222;
    border: 1px solid #444;
    margin-right: 5px;
    border-radius: 5px 5px 0 0;
    transition: all 0.3s;
}

.nav-tabs .nav-link:hover {
    background-color: #333;
    color: #fff;
    cursor: pointer;
}

.nav-tabs .nav-link.active {
    background: linear-gradient(to right, #ffffff, #b1b0b0);
    color: #000;
    font-weight: bold;
    border-bottom: 2px solid #d3d3d3;
}

.workout-tab {
    background: linear-gradient(to right, #4a4a4a, #222);
    color: #ffd166 !important;
}

.workout-tab.active {
    background: linear-gradient(to right, #ffd166, #ff9e6d) !important;
    color: #000 !important;
}

.week-range {
    font-weight: bold;
}

/* Period header row (week/month) */
.period-row td {
    background-color: #333 !important;
    font-weight: bold;
    text-align: left;
    color: #ffd166;
    font-size: 1.05em;
    border-top: 2px solid #666;
    border-bottom: 2px solid #444;
}
.period-row {
            cursor: pointer;
            background-color: #333;
            transition: background-color 0.3s;
        }
        .period-row:hover {
            background-color: #3a3a3a !important;
        }

/* Nested muscle rows */
.muscle-row td {
    padding-left: 20px;
    font-style: italic;
    background-color: #1a1a1a;
}

.muscle-row.collapse {
    display: none;
}

.muscle-row.collapse.show {
    display: table-row;
    background-color: #2a2a2a;
}

.muscle-row:hover td {
    background-color: #333;
    color: #fff;
}

.table-striped > tbody > tr.muscle-row:nth-of-type(odd) > * {
    background-color: #1f1f1f;
}

    .workout-volume {
    color: #ffd166;
    font-weight: bold;
    font-size: 1.05em;
}
.tab-pane {
            padding: 20px;
            }
.muscle-row {
            background-color: #2a2a2a;
            font-weight: bold;
        }

        .muscle-row:hover {
            background-color: #323232 !important;
        }

/* Daily tab animation */
#daily-workout-history tr {
    animation: fadeInRow 0.3s ease-out;
}

/* Nested workout tabs */
.workout-subtabs .nav-link {
    font-size: 16px;
    padding: 8px 15px;
}

.workout-subtabs .nav-link.active {
    background: linear-gradient(to right, #ffd166, #ff9e6d);
    color: #000;
}

/* Table general styling */
.table {
    color: #e0e0e0;
    margin-bottom: 0;
}

.table th,
.table td {
    vertical-align: middle;
    padding: 8px 12px;
    font-size: 15px;
}

.table th {
    font-weight: bold;
    text-align: center;
    cursor: pointer;
    transition: background-color 0.3s;
    position: sticky;
    top: 0;
    background-color: #000;
    border-bottom: 2px solid #444;
    z-index: 10;
}

.table th:hover {
    background-color: #333;
}

/* Right-align numeric columns (Sets, Reps, Volume) */
.table th:nth-child(4),
.table th:nth-child(5),
.table th:nth-child(6),
.table td:nth-child(4),
.table td:nth-child(5),
.table td:nth-child(6) {
    text-align: right !important;
    font-feature-settings: "tnum";
}

/* Highlight volume numbers */
.table td.workout-volume {
    color: #ffd166;
    font-weight: bold;
}

/* Header sort indicators */
.table th::after {
    content: "↕";
    margin-left: 5px;
    opacity: 0.5;
    font-size: 0.8em;
}

.table th.sorted-asc::after {
    content: "↑";
    opacity: 1;
}

.table th.sorted-desc::after {
    content: "↓";
    opacity: 1;
}


/* Position muscle group data under the header */
.muscle-row td:nth-child(3) {
    padding-left: 20px !important;
    text-align: center !important;
    font-style: italic;
}

/* Ensure numeric columns remain right-aligned */
.muscle-row td:nth-child(4),
.muscle-row td:nth-child(5),
.muscle-row td:nth-child(6) {
    text-align: right !important;
}

/* Add visual indicator for expandable rows */
.period-row td:first-child::after {
    content: " ▼";
    font-size: 0.8em;
    opacity: 0.7;
    margin-left: 5px;
}

.period-row.collapsed td:first-child::after {
    content: " ▲";
}

/* Adjust spacing for period rows */
.period-row td {
    padding: 12px 15px !important;
}

/* Period highlight on sorting */
.period-highlight {
    background-color: #444 !important;
    transition: background-color 0.5s ease;
}

@keyframes pulseArrow {
    0%   { transform: scale(1) translateY(0); opacity: 1; }
    50%  { transform: scale(1.2) translateY(-2px); opacity: 0.8; }
    100% { transform: scale(1) translateY(0); opacity: 1; }
}

.period-highlight.sorted-asc::after,
.period-highlight.sorted-desc::after {
    display: inline-block;
    margin-left: 5px;
    font-weight: bold;
    transition: transform 0.3s ease, opacity 0.3s ease;
    animation: pulseArrow 1s ease-in-out;
}

/* Table row fade animation */
@keyframes fadeInRow {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

.table tbody tr {
    animation: fadeInRow 0.3s ease-out;
}

/* Responsive adjustments */
@media (max-width: 768px) {
    .history-container {
        margin: 10px auto;
        padding: 0 10px;
    }

    .card-header {
        font-size: 18px;
        padding: 12px 15px;
    }

    .table th, .table td {
        vertical-align: middle;
        padding: 10px 12px;
        font-size: 14px;
    }

    .nav-tabs .nav-link {
        font-size: 16px;
        padding: 8px 15px;
    }
}

/* Expand/collapse buttons */
#expand-all, #collapse-all {
    font-size: 14px;
    padding: 5px 10px;
    border-radius: 5px;
    font-weight: bold;
}
/* Exercise tab specific styles */
.exercise-tab {
    background: linear-gradient(to right, #4a4a4a, #222);
    color: #06d6a0 !important;
}

.exercise-tab.active {
    background: linear-gradient(to right, #06d6a0, #118ab2) !important;
    color: #000 !important;
}

.card-summary {
    border-radius: 10px;
    transition: transform 0.3s ease;
}

.card-summary:hover {
    transform: translateY(-5px);
    box-shadow: 0 10px 20px rgba(0,0,0,0.3);
}
.text-muted {
  color: white !important;
}
    </style>
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-black">
        <div class="container">
            <a class="navbar-brand" href="/" style="font-size: 26px;">Track You</a>
            <a class="navbar-brand d-none d-md-inline" href="/" style="font-size: 15px;color: #ffffff; ">
                - Track, eat, repeat -
            </a>
            
            <!-- Mobile Settings Dropdown -->
            <div class="ms-auto d-block d-lg-none position-static d-flex align-items-center">
                <button class="mobile-settings-btn" data-bs-toggle="dropdown" aria-expanded="false">
                    <i class="bi bi-wrench-adjustable"></i>
                </button>
                <ul class="dropdown-menu dropdown-menu-end" 
                    aria-labelledby="navbarDropdownMobile"
                    style="position: absolute; background-color: #222; border: 1px solid #ffffff; border-radius: 5px; z-index: 1050; right: 15px; left: auto;">
                    <li>
                        <a class="dropdown-item" 
                           href="/custom_food"
                           style="color: #e0e0e0; padding: 8px 15px;">
                            <i class="fas fa-file-circle-plus me-2"></i>Add Food
                        </a>
                    </li>
                    <li>
                        <a class="dropdown-item" 
                           href="/history"
                           style="color: #e0e0e0; padding: 8px 15px;">
                            <i class="fas fa-chart-pie me-2"></i>History
                        </a>
                    </li>
                    <li>
        <a class="dropdown-item" 
           href="{{ url_for('workout') }}"
           style="color: #e0e0e0; padding: 8px 15px;">
            <i class="fas fa-dumbbell me-2"></i>Workouts
        </a>
    </li>
    <li>
                        <a class="dropdown-item" 
                           href="/activity"
                           style="color: #e0e0e0; padding: 8px 15px;">
                            <i class="fas fa-fire me-2"></i>Activity
                        </a>
                    </li>
                    <li>
                        <a class="dropdown-item" 
                           href="{{ url_for('profile') }}"
                           style="color: #e0e0e0; padding: 8px 15px; border-bottom: 1px solid #444;">
                            <i class="fas fa-user-circle me-2"></i>Profile
                        </a>
                    </li>
                    <li>
                        <a class="dropdown-item" 
                           href="{{ url_for('logout') }}"
                           style="color: #e0e0e0; padding: 8px 15px;">
                            <i class="fas fa-sign-out-alt me-2"></i>Logout
                        </a>
                    </li>
                    
                </ul>
            </div>
            
            <!-- Desktop Navigation -->
            <!-- Desktop Navigation -->
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link home-link nav-link-box" href="/" 
                           data-bs-toggle="tooltip" data-bs-placement="bottom" title="Home">
                            <i class="fa-solid fa-house-chimney-window"></i>
                        </a>
                        <li class="nav-item">
    <a class="nav-link workout-link nav-link-box" href="{{ url_for('workout') }}"
       data-bs-toggle="tooltip" data-bs-placement="bottom" title="Workouts">
        <i class="fa-solid fa-dumbbell"></i>
    </a>
</li>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link add-link nav-link-box" href="/custom_food"
                           data-bs-toggle="tooltip" data-bs-placement="bottom" title="Add Food">
                            <i class="fa-solid fa-file-circle-plus"></i>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link history-link nav-link-box" href="/history"
                           data-bs-toggle="tooltip" data-bs-placement="bottom" title="History">
                            <i class="fa-solid fa-chart-pie"></i>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link nav-link-box" href="/activity"
                           data-bs-toggle="tooltip" data-bs-placement="bottom" title="Activity">
                            <i class="fas fa-fire"></i>
                        </a>
                    </li>
                    
                    {% if current_user.is_authenticated %}
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle nav-link-box" 
                           href="#" 
                           id="navbarDropdownDesktop" 
                           role="button" 
                           data-bs-toggle="dropdown" 
                           aria-expanded="false"
                           data-bs-toggle="tooltip" data-bs-placement="bottom" title="Settings"
                           style="position: relative;">
                            <i class="bi bi-wrench-adjustable"></i>
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end" 
                            aria-labelledby="navbarDropdownDesktop"
                            style="background-color: #222; border: 1px solid #ffffff; border-radius: 5px;">
                            
                            <li>
                                <a class="dropdown-item" 
                                   href="{{ url_for('profile') }}"
                                   style="color: #e0e0e0; padding: 8px 15px; border-bottom: 1px solid #444;">
                                    <i class="fas fa-user-circle me-2"></i>Profile
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item" 
                                   href="{{ url_for('logout') }}"
                                   style="color: #e0e0e0; padding: 8px 15px;">
                                    <i class="fas fa-sign-out-alt me-2"></i>Logout
                                </a>
                            </li>
                        </ul>
                    </li>
                    {% endif %}
                </ul>
            </div>
        </div>
    </nav>

    <div class="history-container">
        <div class="card bg-dark">
            <div class="card-header bg-black text-light">
                <h5 class="mb-0">Nutrition & Workout History</h5>
            </div>
            <div class="card-body p-0">
                <ul class="nav nav-tabs" id="historyTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="daily-tab" data-bs-toggle="tab" data-bs-target="#daily" type="button" role="tab">Nutrition Daily</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="weekly-tab" data-bs-toggle="tab" data-bs-target="#weekly" type="button" role="tab">Nutrition Weekly</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link workout-tab" id="workouts-tab" data-bs-toggle="tab" data-bs-target="#workouts" type="button" role="tab">Workouts</button>
                    </li>
                    <li class="nav-item" role="presentation">
    <button class="nav-link exercise-tab" id="exercises-tab" data-bs-toggle="tab" data-bs-target="#exercises" type="button" role="tab">Exercises</button>
</li>
                </ul>
                
                
                <div class="tab-content">
                    <!-- Daily Nutrition Tab -->
                    <div class="tab-pane fade show active" id="daily" role="tabpanel">
                        <div class="table-responsive">
                            <table class="table table-dark table-striped table-hover mb-0">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Calories</th>
                                        <th>Protein (g)</th>
                                        <th>Carbs (g)</th>
                                        <th>Fats (g)</th>
                                        <th>Salt (g)</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for entry in history_data %}
                                    <tr>
                                        <td>{{ entry.date }}</td>
                                        <td>{{ entry.calories | round(1) }}</td>
                                        <td>{{ entry.proteins | round(1) }}</td>
                                        <td>{{ entry.carbs | round(1) }}</td>
                                        <td>{{ entry.fats | round(1) }}</td>
                                        <td>{{ entry.salt | round(1) }}</td>
                                    </tr>
                                    {% else %}
                                    <tr>
                                        <td colspan="6" class="text-center py-4">No daily data available</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <!-- Weekly Nutrition Tab -->
                    <div class="tab-pane fade" id="weekly" role="tabpanel">
                        <div class="table-responsive">
                            <table class="table table-dark table-striped table-hover mb-0">
                                <thead>
                                    <tr>
                                        <th>Week</th>
                                        <th>Avg Calories</th>
                                        <th>Avg Protein (g)</th>
                                        <th>Avg Carbs (g)</th>
                                        <th>Avg Fats (g)</th>
                                        <th>Avg Salt (g)</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for week in weekly_data %}
                                    <tr>
                                        <td>
                                            <span class="week-range">{{ week.week }}</span><br>
                                            <small>{{ week.start_date }} to {{ week.end_date }}</small>
                                        </td>
                                        <td>{{ week.avg_calories | round(1) }}</td>
                                        <td>{{ week.avg_proteins | round(1) }}</td>
                                        <td>{{ week.avg_carbs | round(1) }}</td>
                                        <td>{{ week.avg_fats | round(1) }}</td>
                                        <td>{{ week.avg_salt | round(1) }}</td>
                                    </tr>
                                    {% else %}
                                    <tr>
                                        <td colspan="6" class="text-center py-4">No weekly data available</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
<!-- Workout History Tab -->
<div class="tab-pane fade" id="workouts" role="tabpanel">
                        <div class="p-3">
                            <!-- Sub-tabs for Daily / Weekly / Monthly -->
            <ul class="nav nav-tabs workout-subtabs" id="workoutHistoryTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="daily-workout-tab" data-bs-toggle="tab" data-bs-target="#daily-workout" type="button" role="tab">Daily</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="weekly-workout-tab" data-bs-toggle="tab" data-bs-target="#weekly-workout" type="button" role="tab">Weekly</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="monthly-workout-tab" data-bs-toggle="tab" data-bs-target="#monthly-workout" type="button" role="tab">Monthly</button>
                </li>
            </ul>

            <!-- Expand / Collapse buttons -->
            <div class="my-3">
                <button id="expand-all" class="btn btn-sm btn-outline-warning me-2">Expand All</button>
                <button id="collapse-all" class="btn btn-sm btn-outline-warning">Collapse All</button>
            </div>

            <!-- Tab content -->
            <div class="tab-content mt-3">

                 <!-- DAILY -->
    <div class="tab-pane fade show active" id="daily-workout" role="tabpanel">
        <div class="table-responsive">
            <table class="table table-dark table-striped">
                <thead>
                    <tr>
                        <th>Date / Period</th>
                        <th class="text-end">Sessions</th>
                        <th>Muscle Group</th>
                        <th class="text-end">Sets</th>
                        <th class="text-end">Total Reps</th>
                        <th class="text-end">Volume (kg)</th>
                    </tr>
                </thead>
                <tbody id="daily-workout-history"></tbody>
            </table>
        </div>
    </div>

    <!-- WEEKLY -->
    <div class="tab-pane fade" id="weekly-workout" role="tabpanel">
        <div class="table-responsive">
            <table class="table table-dark table-striped">
                <thead>
                    <tr>
                        <th>Date / Period</th>
                        <th class="text-end">Sessions</th>
                        <th>Muscle Group</th>
                        <th class="text-end">Sets</th>
                        <th class="text-end">Total Reps</th>
                        <th class="text-end">Volume (kg)</th>
                    </tr>
                </thead>
                <tbody id="weekly-workout-history"></tbody>
            </table>
        </div>
    </div>

    <!-- MONTHLY -->
    <div class="tab-pane fade" id="monthly-workout" role="tabpanel">
        <div class="table-responsive">
            <table class="table table-dark table-striped">
                <thead>
                    <tr>
                        <th>Date / Period</th>
                        <th class="text-end">Sessions</th>
                        <th>Muscle Group</th>
                        <th class="text-end">Sets</th>
                        <th class="text-end">Total Reps</th>
                        <th class="text-end">Volume (kg)</th>
                    </tr>
                </thead>
                <tbody id="monthly-workout-history"></tbody>
            </table>
        </div>
    </div>

</div>
        </div>
    </div>
    <!-- New Exercises Tab Content -->
<div class="tab-pane fade" id="exercises" role="tabpanel">
    <div class="p-3">
        <div class="row mb-3">
            <div class="col-md-6">
                <div class="input-group">
                    <span class="input-group-text bg-dark text-light border-secondary">
                        <i class="fas fa-search"></i>
                    </span>
                    <input type="text" id="exercise-search" class="form-control bg-dark text-light border-secondary" placeholder="Search exercises...">
                </div>
            </div>
            <div class="col-md-6 text-end">
                <div class="btn-group">
                    <button class="btn btn-sm btn-outline-warning active" data-sort="name">Name</button>
                    <button class="btn btn-sm btn-outline-warning" data-sort="pb">Personal Best</button>
                    <button class="btn btn-sm btn-outline-warning" data-sort="recent">Most Recent</button>
                </div>
            </div>
        </div>
        
        <div class="table-responsive">
            <table class="table table-dark table-striped table-hover">
                <thead>
                    <tr>
                        <th>Exercise</th>
                        <th class="text-end">Personal Best</th>
                        <th class="text-end">Last Performed</th>
                        <th class="text-end">Total Volume</th>
                        <th class="text-end">Trend</th>
                    </tr>
                </thead>
                <tbody id="exercises-list">
                    <!-- Will be populated by JavaScript -->
                </tbody>
            </table>
        </div>
        
        <!-- Exercise Detail View (initially hidden) -->
        <div id="exercise-detail" class="mt-4" style="display: none;">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h4 id="exercise-name" class="mb-0"></h4>
                <button id="back-to-list" class="btn btn-sm btn-outline-warning">
                    <i class="fas fa-arrow-left me-1"></i> Back to List
                </button>
            </div>
            
            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="card bg-dark text-center py-3">
                        <div class="card-body">
                            <h5 class="text-warning mb-1" id="pb-value">0 kg</h5>
                            <small class="text-muted">PERSONAL BEST</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-dark text-center py-3">
                        <div class="card-body">
                            <h5 class="text-info mb-1" id="volume-trend">0%</h5>
                            <small class="text-muted">VOLUME TREND</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-dark text-center py-3">
                        <div class="card-body">
                            <h5 class="text-success mb-1" id="last-date">Never</h5>
                            <small class="text-muted">LAST PERFORMED</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-dark text-center py-3">
                        <div class="card-body">
                            <h5 class="text-primary mb-1" id="total-volume">0 kg</h5>
                            <small class="text-muted">TOTAL VOLUME</small>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="chart-container mb-4" style="position: relative; height: 250px;">
                <canvas id="exercise-chart"></canvas>
            </div>
            
            <h5 class="mb-3">Session History</h5>
            <div class="table-responsive">
                <table class="table table-dark table-striped">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th class="text-end">Sets</th>
                            <th class="text-end">Best Set</th>
                            <th class="text-end">Volume</th>
                            <th class="text-end">Progress</th>
                        </tr>
                    </thead>
                    <tbody id="exercise-sessions">
                        <!-- Will be populated by JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>


<!-- JS dependencies -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
$(document).ready(function() {
    let exerciseChart = null;
    let allExercises = []; // Store exercises for sorting

    // Initialize exercises tab
    $('#exercises-tab').on('shown.bs.tab', function() {
        loadExercises();
    });

    // Back to list button
    $('#back-to-list').click(function() {
        $('#exercise-detail').hide();
        $('#exercises-list').closest('.table-responsive').show();
    });

    // Search functionality
    $('#exercise-search').on('input', function() {
        const searchTerm = $(this).val().toLowerCase();
        $('.exercise-row').each(function() {
            const exerciseName = $(this).data('name').toLowerCase();
            $(this).toggle(exerciseName.includes(searchTerm));
        });
    });

    // Sorting functionality
    $('[data-sort]').click(function() {
        $('[data-sort]').removeClass('active');
        $(this).addClass('active');
        sortExercises($(this).data('sort'));
    });

    // Sort exercises based on criteria
    function sortExercises(criteria) {
        const sorted = [...allExercises];
        
        if (criteria === 'name') {
            sorted.sort((a, b) => a.name.localeCompare(b.name));
        } else if (criteria === 'pb') {
            sorted.sort((a, b) => b.personal_best - a.personal_best);
        } else if (criteria === 'recent') {
            sorted.sort((a, b) => {
                const dateA = a.last_performed ? new Date(a.last_performed) : new Date(0);
                const dateB = b.last_performed ? new Date(b.last_performed) : new Date(0);
                return dateB - dateA;
            });
        }
        
        renderExercisesList(sorted);
    }

    // Load exercises list
    function loadExercises() {
        $.get("/workout/exercises", function(data) {
            allExercises = data.exercises || [];
            renderExercisesList(allExercises);
        }).fail(function() {
            $("#exercises-list").html(`
                <tr>
                    <td colspan="5" class="text-center py-4 text-warning">
                        Failed to load exercises. Please try again.
                    </td>
                </tr>
            `);
        });
    }

    // Render exercises list
    function renderExercisesList(exercises) {
        const container = $("#exercises-list");
        container.empty();

        if (!exercises || exercises.length === 0) {
            container.append(`<tr><td colspan="5" class="text-center py-4">No exercises found</td></tr>`);
            return;
        }

        exercises.forEach(ex => {
            const trendClass = ex.volume_trend > 0 ? 'text-success' : 
                              ex.volume_trend < 0 ? 'text-danger' : 'text-muted';
            const trendIcon = ex.volume_trend > 0 ? 'fa-arrow-up' : 
                             ex.volume_trend < 0 ? 'fa-arrow-down' : 'fa-minus';
            
            const row = `
            <tr class="exercise-row" data-id="${ex.id}" data-name="${ex.name}">
                <td>
                    <strong>${ex.name}</strong><br>
                    <small class="text-muted">${ex.muscle_group || 'N/A'}</small>
                </td>
                <td class="text-end align-middle">
                    <span class="badge bg-warning text-dark">${(ex.personal_best || 0).toFixed(1)} kg</span>
                </td>
                <td class="text-end align-middle">${ex.last_performed || 'Never'}</td>
                <td class="text-end align-middle">${(ex.total_volume || 0).toFixed(1)} kg</td>
                <td class="text-end align-middle">
                    <span class="${trendClass}">
                        <i class="fas ${trendIcon} me-1"></i>
                        ${Math.abs(ex.volume_trend || 0).toFixed(1)}%
                    </span>
                </td>
            </tr>`;
            container.append(row);
        });

        // Add click handlers
        $('.exercise-row').click(function() {
            const exerciseId = $(this).data('id');
            loadExerciseDetail(exerciseId);
        });
    }

    // Load exercise detail
    function loadExerciseDetail(exerciseId) {
        $.get(`/workout/exercise/${exerciseId}`, function(data) {
            renderExerciseDetail(data);
        }).fail(function() {
            alert("Failed to load exercise details. Please try again.");
        });
    }

    // Render exercise detail
    function renderExerciseDetail(data) {
        // Update header info
        $('#exercise-name').text(data.name || 'Unknown Exercise');
        $('#pb-value').text(`${(data.personal_best || 0).toFixed(1)} kg`);
        $('#volume-trend').text(`${(data.volume_trend || 0) > 0 ? '+' : ''}${(data.volume_trend || 0).toFixed(1)}%`);
        $('#last-date').text(data.last_performed || 'Never');
        $('#total-volume').text(`${(data.total_volume || 0).toFixed(1)} kg`);
        
        // Render chart if we have history
        if (data.history && data.history.length > 0) {
            renderExerciseChart(data.history);
        } else {
            // Clear chart if no data
            if (exerciseChart) {
                exerciseChart.destroy();
                exerciseChart = null;
            }
            $('#exercise-chart').replaceWith('<canvas id="exercise-chart"></canvas>');
        }
        
        // Render sessions table
        const container = $("#exercise-sessions");
        container.empty();
        
        if (data.history && data.history.length > 0) {
            data.history.forEach(session => {
                const progress = session.progress || 0;
                const progressClass = progress > 0 ? 'text-success' : 
                                    progress < 0 ? 'text-danger' : 'text-muted';
                const progressIcon = progress > 0 ? 'fa-arrow-up' : 
                                   progress < 0 ? 'fa-arrow-down' : 'fa-minus';
                
                const row = `
                <tr>
                    <td>${session.date || ''}</td>
                    <td class="text-end">${session.sets || 0}</td>
                    <td class="text-end">${session.best_set || '-'}</td>
                    <td class="text-end">${(session.volume || 0).toFixed(1)} kg</td>
                    <td class="text-end ${progressClass}">
                        <i class="fas ${progressIcon} me-1"></i>
                        ${Math.abs(progress).toFixed(1)}%
                    </td>
                </tr>`;
                container.append(row);
            });
        } else {
            container.append(`
                <tr>
                    <td colspan="5" class="text-center py-4">No session history available</td>
                </tr>
            `);
        }
        
        // Show detail view
        $('#exercises-list').closest('.table-responsive').hide();
        $('#exercise-detail').show();
    }

    // Render exercise chart
    function renderExerciseChart(history) {
        const ctx = document.getElementById('exercise-chart').getContext('2d');
        
        // Destroy previous chart if exists
        if (exerciseChart) {
            exerciseChart.destroy();
        }
        
        // Prepare data
        const dates = history.map(h => h.date);
        const volumes = history.map(h => h.volume || 0);
        const bests = history.map(h => h.best_weight || 0);
        
        exerciseChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: dates,
                datasets: [
                    {
                        label: 'Volume (kg)',
                        data: volumes,
                        borderColor: '#ffd166',
                        backgroundColor: 'rgba(255, 209, 102, 0.1)',
                        borderWidth: 2,
                        tension: 0.3,
                        yAxisID: 'y'
                    },
                    {
                        label: 'Personal Best (kg)',
                        data: bests,
                        borderColor: '#ef476f',
                        backgroundColor: 'rgba(239, 71, 111, 0.1)',
                        borderWidth: 2,
                        tension: 0.3,
                        yAxisID: 'y1'
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        type: 'linear',
                        display: true,
                        position: 'left',
                        title: {
                            display: true,
                            text: 'Volume (kg)'
                        },
                        grid: {
                            color: 'rgba(255, 255, 255, 0.1)'
                        }
                    },
                    y1: {
                        type: 'linear',
                        display: true,
                        position: 'right',
                        title: {
                            display: true,
                            text: 'Weight (kg)'
                        },
                        grid: {
                            drawOnChartArea: false,
                            color: 'rgba(255, 255, 255, 0.1)'
                        }
                    },
                    x: {
                        grid: {
                            color: 'rgba(255, 255, 255, 0.1)'
                        }
                    }
                },
                plugins: {
                    legend: {
                        labels: {
                            color: '#e0e0e0'
                        }
                    }
                }
            }
        });
    }

    // Workout history functionality
    $('#workoutHistoryTabs button').click(function() {
        const period = $(this).attr('id').split('-')[0];
        loadWorkoutHistory(period);
    });

    $('#expand-all').click(() => $('.muscle-row').removeClass('d-none'));
    $('#collapse-all').click(() => $('.muscle-row').addClass('d-none'));

    $(document).on('click', '.period-row', function() {
        const wasCollapsed = $(this).hasClass('collapsed');
        $(this).toggleClass('collapsed', !wasCollapsed);
        $(this).nextUntil('.period-row').toggleClass('d-none');
    });

    // Initialize workout history if needed
    if(window.location.hash === '#workouts') {
        loadWorkoutHistory('daily');
    }
});

// Workout history functions
function loadWorkoutHistory(period) {
    $.get("/workout/history?period=" + period, function(data) {
        renderWorkoutHistory(data.history, period);
    }).fail(function() {
        const containerId = period + "-workout-history";
        $("#" + containerId).html(`
            <tr>
                <td colspan="6" class="text-center py-4 text-warning">
                    Failed to load workout data. Please try again.
                </td>
            </tr>
        `);
    });
}

function renderWorkoutHistory(history, period) {
    const container = $("#" + period + "-workout-history");
    container.empty();

    if (!history || history.length === 0) {
        container.append(`<tr><td colspan="6" class="text-center py-4">No workout data available</td></tr>`);
        return;
    }

    history.forEach(item => {
        let periodLabel = '';
        let periodRow = '';
        let muscleRows = '';

        if (period === 'daily') {
            periodLabel = new Date(item.date).toLocaleDateString('en-US', { 
                weekday: 'short', 
                month: 'short', 
                day: 'numeric' 
            });

            periodRow = `
            <tr class="period-row collapsed align-middle" style="cursor:pointer;">
                <td><strong>${periodLabel}</strong></td>
                <td class="text-end">${item.sessions_count || 0}</td>
                <td>&nbsp;</td>
                <td class="text-end">${item.total_sets || 0}</td>
                <td class="text-end">${item.total_reps || 0}</td>
                <td class="text-end">${parseFloat(item.total_volume || 0).toFixed(1)}</td>
            </tr>`;

            for (const [muscle, stats] of Object.entries(item.muscles || {})) {
                muscleRows += `
                <tr class="muscle-row d-none">
                    <td></td>
                    <td></td>
                    <td>${muscle}</td>
                    <td class="text-end">${stats.total_sets || 0}</td>
                    <td class="text-end">${stats.total_reps || 0}</td>
                    <td class="text-end">${parseFloat(stats.total_volume || 0).toFixed(1)}</td>
                </tr>`;
            }
        } else {
            const startDate = period === 'weekly' ? 
                new Date(item.week_start) : new Date(item.month_start);

            if (period === 'weekly') {
                const weekEnd = new Date(startDate);
                weekEnd.setDate(weekEnd.getDate() + 6);
                periodLabel = `${startDate.toLocaleDateString('en-US', { 
                    month: 'short', 
                    day: 'numeric' 
                })} - ${weekEnd.toLocaleDateString('en-US', { 
                    month: 'short', 
                    day: 'numeric' 
                })}`;
            } else {
                periodLabel = startDate.toLocaleDateString('en-US', { 
                    month: 'long', 
                    year: 'numeric' 
                });
            }

            periodRow = `
            <tr class="period-row align-middle" style="cursor:pointer;">
                <td><strong>${periodLabel}</strong></td>
                <td class="text-end">${item.sessions_count || 0}</td>
                <td>&nbsp;</td>
                <td class="text-end">${item.total_sets || 0}</td>
                <td class="text-end">${item.total_reps || 0}</td>
                <td class="text-end">${parseFloat(item.total_volume || 0).toFixed(1)}</td>
            </tr>`;

            for (const [muscle, stats] of Object.entries(item.muscles || {})) {
                muscleRows += `
                <tr class="muscle-row d-none">
                    <td></td>
                    <td></td>
                    <td>${muscle}</td>
                    <td class="text-end">${stats.total_sets || 0}</td>
                    <td class="text-end">${stats.total_reps || 0}</td>
                    <td class="text-end">${parseFloat(stats.total_volume || 0).toFixed(1)}</td>
                </tr>`;
            }
        }

        container.append(periodRow + muscleRows);
    });
}

// Initialize workout history when Workouts tab is activated
$('#workouts-tab').on('shown.bs.tab', function() {
    loadWorkoutHistory('daily');
});
</script>
</body>
</html>
