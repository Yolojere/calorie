<!DOCTYPE html>
<html lang="en">
<head>
    <meta name="csrf-token" content="{{ csrf_token() }}">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-i18n="nutrition_workout_history">TrackYou History</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Calibri&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <script src="/static/js/translationshistory.js"></script>

    <style>
        /* === MAIN STYLES === */
        body {
            font-family: 'Roboto', sans-serif;
            font-size: 12px;
            background-color: #161616 !important;
            color: #e0e0e0;
            padding-bottom: 20px;
        }
        
        .bg-black, .modal-header, .modal-footer {
            background-color: #0c0c0c !important;
            border-color: #444;
        }
        
        /* === NEW BUTTON STYLES === */
        .btn-jere {
            display: inline-block;
            background-color: #1b1b1b;
            color: #ffffff;
            border: 1px solid #444;
            border-radius: 20px;
            padding: 8px 12px;
            font-size: 12px;
            font-weight: 600;
            transition: all 0.1s ease;
            cursor: pointer;
        }

        .btn-jere:hover {
            background-color: #d4d4d4 !important;
            color: black !important;
            transform: scale(1.02);
        }

        .btn-jere.active {
            background: #858585 !important;
            color: #000000 !important;
        }
        
        /* Make tabs use the new button style */
        .nav-tabs .nav-link {
            display: inline-block;
            background-color: #1b1b1b;
            color: #ffffff;
            border: 1px solid #444;
            border-radius: 20px;
            padding: 8px 12px;
            font-size: 12px;
            font-weight: 600;
            transition: all 0.1s ease;
            margin-right: 5px;
            margin-bottom: 10px;
        }

        .nav-tabs .nav-link:hover {
            background-color: #d4d4d4 !important;
            color: black !important;
            transform: scale(1.02);
        }

        .nav-tabs .nav-link.active {
            background: #858585 !important;
            color: #000000 !important;
        }

        /* ===== NAV LINK BOX ===== */
        .nav-link-box {
            display: inline-block;
            background-color: #1b1b1b;
            color: #ffffff;
            border: 1px solid #444 !important;
            border-radius: 20px;
            padding: 0;
            margin: 0 3px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 35px;
            height: 35px;
        }

        .nav-link-box:hover {
            background-color: #f0f0f0 !important;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            color: black !important;
        }

        .nav-link-box i {
            font-size: 14px !important;
            margin: 0 !important;
        }
        
        .nav-logo-box {
            display:inline-block;
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            border-radius: 50px;
            padding: 2px;
            margin: 0 3px;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 55px;
            height: 55px;
            z-index: 1050 !important;
        }
        
        .nav-logo-box img.nav-logo {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }
        
        .btn-beta {
            display: inline-block;
            background-color: #8b34f6;
            color: #ffffff;
            border: 1px solid #000000 !important;
            border-radius: 30px;
            text-align: center;
            padding: 2px 20px;
            font-size: 12px;
            font-weight: bold;
            box-shadow: 0px 1px 5px rgb(179, 179, 180);
            cursor:auto !important;
        }
        
        /* ===== MOBILE NAVIGATION ===== */
        .mobile-settings-btn {
            display: inline-block;
            background-color: #1b1b1b;
            color: rgb(255, 255, 255) !important;
            border-radius: 50%;
            padding: 10px !important;
            width: 35px;
            height: 35px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
            margin-left: 10px
        }
        
        .mobile-settings-btn:hover {
            background-color: #f0f0f0 !important;
            transform: translateY(-4px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            color: #000 !important;
        }

        .mobile-settings-btn i {
            font-size: 20px !important;
            margin: 0 !important;
        }

        /* === HISTORY PAGE REDESIGN === */
        .history-container {
            max-width: 1200px;
            margin: 20px auto;
            padding: 0 15px;
        }

        /* Header with gradient */
        .page-header {
            background: linear-gradient(135deg, #1a1a1a 0%, #0c0c0c 100%);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 25px;
            border: 1px solid #444;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }

        .page-title {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 5px;
            background: linear-gradient(to right, #ffffff, #b1b0b0);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .page-subtitle {
            color: #b1b0b0;
            font-size: 14px;
        }

        /* Card styles */
        .history-card {
            background: linear-gradient(135deg, #1a1a1a 0%, #0c0c0c 100%);
            border-radius: 15px;
            border: 1px solid #444;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            margin-bottom: 20px;
            overflow: hidden;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .history-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.4);
        }

        .card-header-custom {
            background: linear-gradient(to right, #333, #222);
            border-bottom: 1px solid #444;
            padding: 15px 20px;
            font-weight: 600;
            font-size: 18px;
            color: #e0e0e0;
        }

        /* Tab styles - UPDATED with new button style */
        .nav-tabs {
            border-bottom: none;
            padding: 0 15px;
            margin-bottom: 20px;
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        /* Tooltip container */
        .tooltip {
            opacity: 1 !important; /* prevent Bootstrap fade weirdness */
        }

        /* Tooltip bubble */
        .tooltip .tooltip-inner {
            background-color: #1b1b1b; /* match nav-link-box background */
            color: #fff;
            font-size: 0.75rem;
            font-weight: 500;
            padding: 6px 10px;
            border-radius: 10px; /* softer pill look */
            border: 1px solid #444;
            box-shadow: 0 2px 6px rgba(0,0,0,0.4);
        }
        .period-row {
    background: linear-gradient(135deg, #2a2a2a 0%, #1a1a1a 100%) !important;
    border: 1px solid #444;
    border-radius: 8px;
    margin-bottom: 8px !important;
    cursor: pointer;
    transition: all 0.2s ease;
}

.period-row:hover {
    background: linear-gradient(135deg, #333 0%, #222 100%) !important;
    transform: translateY(-1px);
}

.period-row.collapsed .collapse-icon {
    transform: rotate(-90deg);
}

.muscle-row {
    background-color: #1a1a1a !important;
    border-left: 3px solid #ffd166;
    margin-left: 20px;
}

/* Compact metrics display */
.compact-metrics {
    display: flex;
    gap: 15px;
    flex-wrap: wrap;
    margin-bottom: 10px;
    padding: 8px 0;
}

.metric-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    min-width: 60px;
}

.metric-value {
    font-size: 16px;
    font-weight: 600;
    color: #ffd166;
}

.metric-label {
    font-size: 10px;
    color: #888;
    text-transform: uppercase;
}
        /* Tooltip arrow */
        .tooltip.bs-tooltip-top .tooltip-arrow::before {
            border-top-color: #1b1b1b;
        }
        
        .tooltip.bs-tooltip-bottom .tooltip-arrow::before {
            border-bottom-color: #1b1b1b;
        }
        
        .tooltip.bs-tooltip-start .tooltip-arrow::before {
            border-left-color: #1b1b1b;
        }
        
        .tooltip.bs-tooltip-end .tooltip-arrow::before {
            border-right-color: #1b1b1b;
        }
        
        /* ===== DROPDOWNS & MODALS ===== */
        .dropdown-menu {
            background-color: #1e1e1e;
            border: 1px solid #333;
            right: 0 !important;
            width: 120px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            position: absolute;
        }

        .dropdown-item {
            color: #fff;
        }

        .dropdown-item:hover {
            background-color: #333;
            color: #ffffff;
        }

        /* Table styles - UPDATED WITH BLACK BACKGROUND AND WHITE TEXT */
        .table-container {
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 20px;
            width: 100%;
            overflow-x: auto; /* Enable horizontal scrolling */
            -webkit-overflow-scrolling: touch; /* Smooth scrolling on iOS */
        }

        .table-custom {
            color: #ffffff; /* Changed to white */
            margin-bottom: 0;
            border-collapse: separate;
            border-spacing: 0;
            background-color: #060606; /* Added black background */
            min-width: 600px; /* Ensure table has minimum width */
        }

        .table-custom th {
            background: #0f0f0f; /* Changed to solid black */
            border-bottom: 2px solid #444;
            padding: 12px 15px;
            font-weight: 600;
            text-align: left;
            position: sticky;
            top: 0;
            z-index: 10;
            color: #ffffff; /* Added white text */
            white-space: nowrap;
        }

        .table-custom td {
            padding: 12px 15px;
            vertical-align: middle;
            border-bottom: 1px solid #333;
            background-color: #1b1b1b; /* Added black background */
            color: #ffffff; /* Added white text */
            white-space: nowrap;
        }

        .table-custom tbody tr {
            transition: background-color 0.2s ease;
        }

        .table-custom tbody tr:hover {
            background-color: #1a1a1a; /* Darker hover effect */
        }

        .table-custom tbody tr:hover td {
            background-color: #1a1a1a; /* Ensure hover effect applies to cells */
        }

        .table-custom tbody tr:last-child td {
            border-bottom: none;
        }

        /* Tab content - UPDATED WITH BLACK BACKGROUND */
        .tab-content {
            background-color: #000000; /* Added black background */
            color: #ffffff; /* Added white text */
            padding: 15px;
            border-radius: 0 0 10px 10px;
            overflow-x: auto; /* Enable horizontal scrolling */
        }

        /* Summary cards */
        .summary-card {
            background: linear-gradient(135deg, #1a1a1a 0%, #0c0c0c 100%);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid #444;
            text-align: center;
            transition: transform 0.3s ease;
            height: 100%;
        }

        .summary-card:hover {
            transform: translateY(-5px);
        }

        .summary-value {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .summary-label {
            font-size: 14px;
            color: #b1b0b0;
        }

        /* Button styles - REPLACED with btn-jere */
        .btn-custom {
            display: inline-block;
            background-color: #1b1b1b;
            color: #ffffff;
            border: 1px solid #444;
            border-radius: 20px;
            padding: 8px 12px;
            font-size: 12px;
            font-weight: 600;
            transition: all 0.1s ease;
        }

        .btn-custom:hover {
            background-color: #d4d4d4 !important;
            color: black !important;
            transform: scale(1.02);
        }

        .btn-custom.active {
            background: #858585 !important;
            color: #000000 !important;
        }

        /* Stats highlights */
        .stat-highlight {
            padding: 15px;
            border-radius: 10px;
            background: linear-gradient(135deg, #1a1a1a 0%, #0c0c0c 100%);
            border: 1px solid #444;
            margin-bottom: 15px;
        }

        .stat-value {
            font-size: 20px;
            font-weight: 700;
        }

        .stat-label {
            font-size: 14px;
            color: #b1b0b0;
        }
        
        .text-muted {
            color: white !important;
        }
        
        /* Progress bars */
        .progress {
            height: 8px;
            background-color: #2a2a2a;
            border-radius: 4px;
            margin-top: 5px;
        }

        .progress-bar-protein {
            background-color: #06d6a0;
        }

        .progress-bar-carbs {
            background-color: #118ab2;
        }

        .progress-bar-fats {
            background-color: #ef476f;
        }

        .progress-bar-salt {
            background-color: #ffd166;
        }

.exercise-search-container {
    position: relative;
    margin-bottom: 15px;
}

.exercise-filters {
    display: flex;
    gap: 8px;
    margin-bottom: 15px;
    overflow-x: auto;
    padding-bottom: 5px;
    -webkit-overflow-scrolling: touch;
}

.muscle-group-filter {
    flex-shrink: 0;
    padding: 4px 8px;
    font-size: 10px;
    border-radius: 12px;
    background: #1b1b1b;
    color: #fff;
    border: 1px solid #444;
    cursor: pointer;
    transition: all 0.2s ease;
    white-space: nowrap;
}

.muscle-group-filter.active {
    background: #ffd166;
    color: #000;
}

/* Enhanced exercise list items */
.exercise-row {
    transition: background-color 0.2s ease;
    cursor: pointer;
}

.exercise-row:hover {
    background-color: #1a1a1a !important;
}

.exercise-row:hover td {
    background-color: #1a1a1a !important;
}
        /* Empty state styling */
        .empty-state {
            padding: 40px 20px;
            text-align: center;
            color: #888;
        }

        .empty-state i {
            font-size: 50px;
            margin-bottom: 15px;
            opacity: 0.5;
        }
        .expandable-trigger {
    min-height: 44px;
    display: flex;
    align-items: center;
    padding: 8px 12px;
    cursor: pointer;
    border: 2px solid transparent;
    transition: border-color 0.2s ease;
    border-radius: 8px;
}

.expandable-trigger:active {
    border-color: #ffd166;
    background-color: rgba(255, 209, 102, 0.1);
}

/* Enhanced empty states */
.empty-state {
    padding: 30px 15px !important;
    text-align: center;
}

.empty-state i {
    font-size: 40px !important;
    margin-bottom: 12px !important;
    opacity: 0.6;
    color: #888;
}

.empty-state h4 {
    font-size: 16px;
    margin-bottom: 8px;
    color: #fff;
}

.empty-state p {
    font-size: 12px;
    color: #888;
    margin-bottom: 15px;
    line-height: 1.4;
}

/* Loading states */
.loading-state {
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 40px 20px;
}

.loading-spinner {
    width: 30px;
    height: 30px;
    border: 3px solid #333;
    border-top: 3px solid #ffd166;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin-bottom: 15px;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

.loading-text {
    font-size: 12px;
    color: #888;
}
        
        /* Mobile-specific styles for horizontal scrolling */
        @media (max-width: 768px) {
            .history-container {
                overflow-x: hidden; /* Prevent horizontal scroll on container */
                width: 100%;
            }
            
            .table-container {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                width: 100%;
            }
            
            .table-custom {
                min-width: 700px; /* Ensure table is wide enough to scroll */
            }
            
            .page-title {
                font-size: 22px;
            }
            
            .nav-tabs .nav-link {
                font-size: 12px;
                padding: 8px 12px;
            }
            
            .table-custom th, 
            .table-custom td {
                padding: 10px 8px;
                font-size: 12px;
            }
            
            .summary-value {
                font-size: 20px;
            }
            
            /* Make summary cards more compact on mobile */
            .summary-card {
                padding: 15px 10px;
            }
            
            /* Adjust tab layout for mobile */
            .nav-tabs {
                flex-wrap: nowrap;
                overflow-x: auto;
                padding-bottom: 5px;
            }
            
            .nav-tabs .nav-link {
                white-space: nowrap;
                flex-shrink: 0;
            }
                .table-custom th {
        position: sticky !important;
        top: 0 !important;
        z-index: 20 !important;
        background: #0f0f0f !important;
        padding: 8px 6px !important;
        font-size: 11px !important;
        white-space: nowrap;
        box-shadow: 0 2px 4px rgba(0,0,0,0.3);
    }
    
    .table-custom td {
        padding: 8px 6px !important;
        font-size: 11px !important;
        white-space: nowrap;
    }
    
    .expand-collapse-controls {
        position: sticky;
        top: 0;
        z-index: 15;
        background: #161616;
        padding: 10px 0;
        margin-bottom: 10px;
        display: flex;
        gap: 10px;
        justify-content: center;
        border-bottom: 1px solid #333;
    }
    
    #expand-all,
    #collapse-all {
        padding: 6px 12px !important;
        font-size: 11px !important;
        min-width: 80px;
    }
}
        

        /* Animation for tab content */
        .tab-pane {
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #1a1a1a;
        }

        ::-webkit-scrollbar-thumb {
            background: #444;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        /* Week range styling */
        .week-range {
            font-weight: bold;
            color: #ffd166;
        }

        /* Workout volume styling */
        .workout-volume {
            color: #ffd166;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-black">
        <div class="container">
            <div class="nav-logo-box">
                <a href="/">
                    <img src="static/images/trackyoulogo.png" alt="TrackYou Logo" class="nav-logo">
                </a>
            </div>
            <a class="navbar-brand d-md-inline" href="/" style="font-size: 13px; font-weight:600;">Track You</a>
            <a class="navbar-brand d-none d-md-inline" href="/" style="font-size: 12px;color: #ffffff; ">
                - Track, analyze, repeat -
            </a>
            <button class="btn-beta">BETA</button>
            <!-- Mobile Settings Dropdown (right-aligned) -->
            <div class="ms-auto d-block d-lg-none position-static d-flex align-items-center">
                <button class="mobile-settings-btn" data-bs-toggle="dropdown" aria-expanded="false">
                    <i class="bi bi-wrench-adjustable"></i>
                </button>
                <ul class="dropdown-menu dropdown-menu-end" 
                    aria-labelledby="navbarDropdownMobile"
                    style="position: absolute; background-color: #222; border: 1px solid #ffffff; border-radius: 5px; z-index: 1050; right: 15px; left: auto; font-size: 10;">
                    <li>
                        <a class="dropdown-item" 
                        href="/"
                        style="color: #e0e0e0; padding: 8px 15px;">
                            <i class="fa-solid fa-house-chimney-window me-2"></i><span data-i18n="home">Home</span>
                        </a>
                    </li>
                    <li>
                        <a class="dropdown-item" 
                        href="{{ url_for('workout') }}"
                        style="color: #e0e0e0; padding: 8px 15px;">
                            <i class="fas fa-dumbbell me-2"></i><span data-i18n="workouts">Workouts</span>
                        </a>
                    </li>
                    <li>
                        <a class="dropdown-item" 
                        href="/history"
                        style="color: #e0e0e0; padding: 8px 15px;">
                            <i class="fas fa-chart-pie me-2"></i><span data-i18n="history">History</span>
                        </a>
                    </li>
                    <li>
                        <a class="dropdown-item" 
                        href="{{ url_for('activity') }}"
                        style="color: #e0e0e0; padding: 8px 15px;">
                            <i class="fas fa-fire me-2"></i><span data-i18n="activity">Activity</span>
                        </a>
                    </li>
                    <li>
                        <a class="dropdown-item" 
                        href="/custom_food"
                        style="color: #e0e0e0; padding: 8px 15px;">
                            <i class="fas fa-file-circle-plus me-2"></i><span data-i18n="add_food">Add Food</span>
                        </a>
                    </li>
                    <li>
                        <a class="dropdown-item" 
                        href="{{ url_for('profile') }}"
                        style="color: #e0e0e0; padding: 8px 15px; border-bottom: 1px solid #444;">
                            <i class="fas fa-user-circle me-2"></i><span data-i18n="profile">Profile</span>
                        </a>
                    </li>
                    <li>
                        <a class="dropdown-item" 
                        href="{{ url_for('logout') }}"
                        style="color: #e0e0e0; padding: 8px 15px;">
                            <i class="fas fa-sign-out-alt me-2"></i><span data-i18n="logout">Logout</span>
                        </a>
                    </li>
                </ul>
            </div>
            
            <!-- Desktop Navigation -->
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link home-link nav-link-box" href="/" 
                        data-bs-toggle="tooltip" data-bs-placement="bottom" title="Home" data-i18n="tooltip_home" >
                            <i class="fa-solid fa-house-chimney-window"></i>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link workout-link nav-link-box" href="{{ url_for('workout') }}"
                        data-bs-toggle="tooltip" data-bs-placement="bottom" title="Workouts" data-i18n="tooltip_workouts">
                            <i class="fa-solid fa-dumbbell"></i>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link add-link nav-link-box" href="/custom_food"
                        data-bs-toggle="tooltip" data-bs-placement="bottom" title="Add Food" data-i18n="tooltip_add_food">
                            <i class="fa-solid fa-file-circle-plus"></i>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link history-link nav-link-box" href="/history"
                        data-bs-toggle="tooltip" data-bs-placement="bottom" title="History" data-i18n="tooltip_history">
                            <i class="fa-solid fa-chart-pie"></i>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link nav-link-box" href="/activity"
                        data-bs-toggle="tooltip" data-bs-placement="bottom" title="Activity" data-i18n="tooltip_activity">
                            <i class="fas fa-fire"></i>
                        </a>
                    </li>
                    
                    {% if current_user.is_authenticated %}
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle nav-link-box" 
                        href="#" 
                        id="navbarDropdownDesktop" 
                        role="button" 
                        data-bs-toggle="dropdown" 
                        aria-expanded="false"
                        data-bs-toggle="tooltip" data-bs-placement="bottom" title="Settings" data-i18n="tooltip_settings"
                        style="position: relative;">
                            <i class="bi bi-wrench-adjustable"></i>
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end" 
                            aria-labelledby="navbarDropdownDesktop"
                            style="background-color: #222; border: 1px solid #ffffff; border-radius: 5px;">
                            
                            <li>
                                <a class="dropdown-item" 
                                href="{{ url_for('profile') }}"
                                style="color: #e0e0e0; padding: 8px 15px; border-bottom: 1px solid #444;">
                                    <i class="fas fa-user-circle me-2"></i><span data-i18n="profile">Profile</span>
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item" 
                                href="{{ url_for('logout') }}"
                                style="color: #e0e0e0; padding: 8px 15px;">
                                    <i class="fas fa-sign-out-alt me-2"></i><span data-i18n="logout">Logout</span>
                                </a>
                            </li>
                        </ul>
                    </li>
                    {% endif %}
                </ul>
            </div>
        </div>
    </nav>

    <div class="history-container">
        <!-- Page Header -->
        <div class="page-header">
            <h1 class="page-title" data-i18n="nutrition_workout_history">Nutrition & Workout History</h1>
            <p class="page-subtitle" data-i18n="history_subtitle">Track your progress and analyze your performance over time</p>
        </div>

   <!-- Summary Stats Row -->
<div class="row mb-4">
  <!-- ✅ Today's Calories -->
<div class="col-md-3 col-6 mb-3">
    <div class="summary-card">
        <div class="summary-value text-warning">
            {% if today_calories >= 10000 %}
                {{ "%.1fk"|format(today_calories / 1000) }}
            {% else %}
                {{ today_calories | round(0) | int }}
            {% endif %}
        </div>
        <div class="summary-label" data-i18n="today_calories">Today's Calories</div>
    </div>
</div>

<!-- ✅ Today's Protein -->
<div class="col-md-3 col-6 mb-3">
    <div class="summary-card">
        <div class="summary-value text-info">
            {% if today_protein >= 10000 %}
                {{ "%.1fk"|format(today_protein / 1000) }}g
            {% else %}
                {{ today_protein | round(0) | int }}g
            {% endif %}
        </div>
        <div class="summary-label" data-i18n="today_protein">Today's Protein</div>
    </div>
</div>

    <!-- ✅ Weekly Avg Calories + Current Balance (combined) -->
    <div class="col-md-3 col-6 mb-3">
        <div class="summary-card">
            <!-- Weekly Avg Calories -->
            <div class="summary-value text-success">
                {% if weekly_data %}
                    {% set avg_cals = weekly_data[0].avg_calories %}
                    {% if avg_cals >= 10000 %}
                        {% set val = (avg_cals / 1000) | round(1) %}
                        {{ (val|string).replace('.0','') }}k
                    {% else %}
                        {{ avg_cals | round(0) }}
                    {% endif %}
                {% else %}
                    0
                {% endif %}
            </div>
            <div class="summary-label" data-i18n="weekly_avg_calories">Weekly Avg Calories</div>

            <!-- Current Balance -->
            <div class="summary-value {% if daily_balance > 0 %}text-danger{% elif daily_balance < 0 %}text-success{% else %}text-muted{% endif %}">
                {% if daily_balance > 0 %}
                    +{% if daily_balance | abs >= 1000 %}
                        {% set val = (daily_balance / 1000) | round(1) %}
                        {{ (val|string).replace('.0','') }}k
                    {% else %}
                        {{ daily_balance | round(0) }}
                    {% endif %}
                {% elif daily_balance < 0 %}
                    {% if daily_balance | abs >= 1000 %}
                        {% set val = (daily_balance / 1000) | round(1) %}
                        {{ (val|string).replace('.0','') }}k
                    {% else %}
                        {{ daily_balance | round(0) }}
                    {% endif %}
                {% else %}
                    0
                {% endif %}
            </div>
            <div class="summary-label">
                {% if daily_balance > 0 %}
                    Kaloria yli kulutuksen
                {% elif daily_balance < 0 %}
                    Kaloria alle kulutuksen
                {% else %}
                    Ylläpitää painoa
                {% endif %}
            </div>
        </div>
    </div>

    <!-- ✅ Projected Weight Change -->
    <div class="col-md-3 col-6 mb-3">
        <div class="summary-card">
            <div class="summary-value {% if projected_change_kg > 0 %}text-warning{% elif projected_change_kg < 0 %}text-success{% else %}text-muted{% endif %}">
                {% if projected_change_kg > 0 %}
                    +{% if projected_change_kg | abs < 10 %}
                        {{ "%.1f"|format(projected_change_kg) }}kg
                    {% else %}
                        {{ projected_change_kg | round(0) | int }}kg
                    {% endif %}
                {% elif projected_change_kg < 0 %}
                    {% if projected_change_kg | abs < 10 %}
                        {{ "%.1f"|format(projected_change_kg) }}kg
                    {% else %}
                        {{ projected_change_kg | round(0) | int }}kg
                    {% endif %}
                {% else %}
                    0kg
                {% endif %}
            </div>
            <div class="summary-label">
                {% if projected_change_kg > 0 %}
                    Arvioitu painon nousu / viikko
                {% elif projected_change_kg < 0 %}
                    Arvioitu painon lasku / viikko
                {% else %}
                    Ei muutoksia odotettavissa
                {% endif %}
            </div>
        </div>
    </div>
</div>


        <!-- Main Content Card -->
        <div class="history-card">
            <div class="card-header-custom">
                <i class="fas fa-chart-line me-2"></i><span data-i18n="progress_tracking">Progress Tracking</span>
            </div>
            <div class="card-body">
                <ul class="nav nav-tabs" id="historyTabs" role="tablist">
                    <!-- Updated tab names as requested -->
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active btn-jere" id="nutrition-tab" data-bs-toggle="tab" data-bs-target="#nutrition" type="button" role="tab">
                             <i class="fas fa-utensils me-1"></i> <span data-i18n="nutrition">Nutrition</span>
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link btn-jere" id="workouts-tab" data-bs-toggle="tab" data-bs-target="#workouts" type="button" role="tab">
                            <i class="fas fa-dumbbell me-1"></i> <span data-i18n="workouts">Workouts</span>
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link btn-jere" id="exercises-tab" data-bs-toggle="tab" data-bs-target="#exercises" type="button" role="tab">
                            <i class="fas fa-running me-1"></i> <span data-i18n="exercises">Exercises</span>
                        </button>
                    </li>
                </ul>
                
                <div class="tab-content">
                    <!-- Nutrition Tab (with nested tabs) -->
                    <div class="tab-pane fade show active" id="nutrition" role="tabpanel">
                        <ul class="nav nav-tabs" id="nutritionSubTabs" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active btn-jere" id="daily-nutrition-tab" data-bs-toggle="tab" data-bs-target="#daily-nutrition" type="button" role="tab">
                                    <i class="fas fa-calendar-day me-1"></i> <span data-i18n="daily">Daily</span>
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link btn-jere" id="weekly-nutrition-tab" data-bs-toggle="tab" data-bs-target="#weekly-nutrition" type="button" role="tab">
                                     <i class="fas fa-calendar-week me-1"></i> <span data-i18n="weekly">Weekly</span>
                                </button>
                            </li>
                        </ul>
                        
                        <div class="tab-content mt-3">
                            <!-- Daily Nutrition Sub-tab -->
                            <div class="tab-pane fade show active" id="daily-nutrition" role="tabpanel">
                                {% if history_data and history_data|length > 0 %}
                                <div class="table-container">
                                    <table class="table table-custom table-hover">
                                        <thead>
                                            <tr>
                                                <th data-i18n="date">Date</th>
                                                <th data-i18n="calories">Calories</th>
                                                <th data-i18n="protein_g">Protein (g)</th>
                                                <th data-i18n="carbs_g">Carbs (g)</th>
                                                <th data-i18n="fats_g">Fats (g)</th>
                                                <th data-i18n="salt_g">Salt (g)</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for entry in history_data %}
                                            <tr>
                                               <td data-raw-date="{{ entry.date_raw }}">{{ entry.date }}</td>
                                                <td>{{ entry.calories | round(0) }}</td>
                                                <td>
                                                    {{ entry.proteins | round(0) }}
                                                    <div class="progress">
                                                        <div class="progress-bar progress-bar-protein" data-value="{{ entry.proteins }}"></div>
                                                    </div>
                                                </td>
                                                <td>
                                                    {{ entry.carbs | round(1) }}
                                                    <div class="progress">
                                                        <div class="progress-bar progress-bar-carbs" data-value="{{ entry.carbs }}"></div>
                                                    </div>
                                                </td>
                                                <td>
                                                    {{ entry.fats | round(1) }}
                                                    <div class="progress">
                                                        <div class="progress-bar progress-bar-fats" data-value="{{ entry.fats }}"></div>
                                                    </div>
                                                </td>
                                                <td>
                                                    {{ entry.salt | round(1) }}
                                                    <div class="progress">
                                                        <div class="progress-bar progress-bar-salt" data-value="{{ entry.salt }}"></div>
                                                    </div>
                                                </td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                                {% else %}
                                <div class="empty-state">
                                    <i class="fas fa-utensils"></i>
                                    <h4 data-i18n="no_nutrition_data">No nutrition data available</h4>
                                    <p data-i18n="start_tracking_nutrition">Start tracking your meals to see your daily nutrition history</p>
                                    <a href="/custom_food" class="btn-jere mt-2" data-i18n="add_food">Add Food</a>
                                </div>
                                {% endif %}
                            </div>
                            
                            <!-- Weekly Nutrition Sub-tab -->
                            <div class="tab-pane fade" id="weekly-nutrition" role="tabpanel">
                                {% if weekly_data and weekly_data|length > 0 %}
                                <div class="table-container">
                                    <table class="table table-custom table-hover">
                                        <thead>
                                            <tr>
                                                <th data-i18n="week">Week</th>
                                                <th data-i18n="avg_calories">Avg Calories</th>
                                                <th data-i18n="avg_protein_g">Avg Protein (g)</th>
                                                <th data-i18n="avg_carbs_g">Avg Carbs (g)</th>
                                                <th data-i18n="avg_fats_g">Avg Fats (g)</th>
                                                <th data-i18n="avg_salt_g">Avg Salt (g)</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for week in weekly_data %}
                                            <tr>
                                                <td>
                                                    <span class="week-range">{{ week.week }}</span><br>
                                                    <small>{{ week.start_date }} to {{ week.end_date }}</small>
                                                </td>
                                                <td>{{ week.avg_calories | round(1) }}</td>
                                                <td>{{ week.avg_proteins | round(1) }}</td>
                                                <td>{{ week.avg_carbs | round(1) }}</td>
                                                <td>{{ week.avg_fats | round(1) }}</td>
                                                <td>{{ week.avg_salt | round(1) }}</td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                                {% else %}
                                <div class="empty-state">
                                    <i class="fas fa-chart-bar"></i>
                                    <h4 data-i18n="no_weekly_data">No weekly data available</h4>
                                    <p data-i18n="keep_tracking_weekly">Keep tracking your meals to see weekly nutrition trends</p>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                           
                    <!-- Workout History Tab -->
                    <div class="tab-pane fade" id="workouts" role="tabpanel">
                        <div class="p-3">
                            <!-- Sub-tabs for Daily / Weekly / Monthly -->
                            <ul class="nav nav-tabs workout-subtabs" id="workoutHistoryTabs" role="tablist">
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link active btn-jere" id="daily-workout-tab" data-bs-toggle="tab" data-bs-target="#daily-workout" type="button" role="tab" data-i18n="daily">Daily</button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link btn-jere" id="weekly-workout-tab" data-bs-toggle="tab" data-bs-target="#weekly-workout" type="button" role="tab" data-i18n="weekly">Weekly</button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link btn-jere" id="monthly-workout-tab" data-bs-toggle="tab" data-bs-target="#monthly-workout" type="button" role="tab" data-i18n="monthly">Monthly</button>
                                </li>
                            </ul>

                            <!-- Expand / Collapse buttons -->
                            <div class="expand-collapse-controls">
    <button id="expand-all" class="btn-jere me-2" data-i18n="expand_all">Expand All</button>
    <button id="collapse-all" class="btn-jere" data-i18n="collapse_all">Collapse All</button>
</div>

                            <!-- Tab content -->
                            <div class="tab-content mt-3">
                                <!-- DAILY -->
                                <div class="tab-pane fade show active" id="daily-workout" role="tabpanel">
                                    <div class="table-responsive">
                                        <table class="table table-custom">
                                            <thead>
                                                <tr>
                                                    <th data-i18n="date_period">Date / Period</th>
                                                    <th class="text-end" data-i18n="sessions">Sessions</th>
                                                    <th data-i18n="muscle_group">Muscle Group</th>
                                                    <th class="text-end" data-i18n="sets">Sets</th>
                                                    <th class="text-end" data-i18n="total_reps">Total Reps</th>
                                                    <th class="text-end" data-i18n="volume_kg">Volume (kg)</th>
                                                </tr>
                                            </thead>
                                            <tbody id="daily-workout-history"></tbody>
                                        </table>
                                    </div>
                                </div>

                                <!-- WEEKLY -->
                                <div class="tab-pane fade" id="weekly-workout" role="tabpanel">
                                    <div class="table-responsive">
                                        <table class="table table-custom">
                                            <thead>
                                                <tr>
                                                    <th>Date / Period</th>
                                                    <th class="text-end">Sessions</th>
                                                    <th>Muscle Group</th>
                                                    <th class="text-end">Sets</th>
                                                    <th class="text-end">Total Reps</th>
                                                    <th class="text-end">Volume (kg)</th>
                                                </tr>
                                            </thead>
                                            <tbody id="weekly-workout-history"></tbody>
                                        </table>
                                    </div>
                                </div>

                                <!-- MONTHLY -->
                                <div class="tab-pane fade" id="monthly-workout" role="tabpanel">
                                    <div class="table-responsive">
                                        <table class="table table-custom">
                                            <thead>
                                                <tr>
                                                    <th>Date / Period</th>
                                                    <th class="text-end">Sessions</th>
                                                    <th>Muscle Group</th>
                                                    <th class="text-end">Sets</th>
                                                    <th class="text-end">Total Reps</th>
                                                    <th class="text-end">Volume (kg)</th>
                                                </tr>
                                            </thead>
                                            <tbody id="monthly-workout-history"></tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Exercises Tab -->
                    <div class="tab-pane fade" id="exercises" role="tabpanel">
                        <div class="p-3">
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <div class="exercise-filters" id="muscle-group-filters">
    <button class="muscle-group-filter active" data-muscle="all" data-i18n="all">All</button>
    <button class="muscle-group-filter" data-muscle="chest" data-i18n="chest">Chest</button>
    <button class="muscle-group-filter" data-muscle="back" data-i18n="back">Back</button>
    <button class="muscle-group-filter" data-muscle="shoulders" data-i18n="shoulders">Shoulders</button>
    <button class="muscle-group-filter" data-muscle="arms" data-i18n="arms">Arms</button>
    <button class="muscle-group-filter" data-muscle="legs" data-i18n="legs">Legs</button>
    <button class="muscle-group-filter" data-muscle="core" data-i18n="core">Core</button>
</div>
                                    <div class="input-group">
                                        <span class="input-group-text bg-dark text-light border-secondary">
                                            <i class="fas fa-search"></i>
                                        </span>
                                        <input type="text" id="exercise-search" class="form-control bg-dark text-light border-secondary" placeholder="Search exercises..." data-i18n="search_exercises_placeholder">
                                    </div>
                                </div>
                                
                                <div class="col-md-6 text-end">
                                    <div class="btn-group">
                                        <button class="btn-jere active" data-sort="name" data-i18n="name">Name</button>
                                        <button class="btn-jere" data-sort="pb">Personal Best</button>
                                        <button class="btn-jere" data-sort="recent" data-i18n="most_recent">Most Recent</button>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="table-responsive">
                                <table class="table table-custom table-hover">
                                    <thead>
                                        <tr>
                                            <th data-i18n="exercise">Exercise</th>
                                           <th class="text-end">Personal Best</th>
                                            <th class="text-end" data-i18n="last_performed">Last Performed</th>
                                            <th class="text-end" data-i18n="total_volume">Total Volume</th>
                                            <th class="text-end" data-i18n="trend">Trend</th>
                                        </tr>
                                    </thead>
                                    <tbody id="exercises-list">
                                        <!-- Will be populated by JavaScript -->
                                    </tbody>
                                </table>
                            </div>
                            
                            <!-- Exercise Detail View (initially hidden) -->
                            <div id="exercise-detail" class="mt-4" style="display: none;">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <h4 id="exercise-detail-name" class="mb-0"></h4>
                                    <button id="back-to-list" class="btn-jere">
                                        <i class="fas fa-arrow-left me-1"></i> <span data-i18n="back_to_list">Back to List</span>
                                    </button>
                                </div>

                                <!-- Summary Cards - REORDERED AS REQUESTED -->
                                <div class="row mb-4">
                                    <!-- Volume Card -->
                                    <div class="col-md-3 mb-3">
                                        <div class="summary-card">
                                            <div class="summary-value text-primary" id="exercise-monthly-volume">0 kg</div>
                                           <div class="summary-label" data-i18n="monthly_volume">MONTHLY VOLUME</div>
                                        </div>
                                    </div>
                                    <!-- Personal Best Card -->
                                    <div class="col-md-3 mb-3">
                                        <div class="summary-card">
                                            <div class="summary-value text-warning" id="exercise-personal-best">0 kg</div>
                                            <div class="summary-label" data-i18n="personal_best">PERSONAL BEST</div>
                                        </div>
                                    </div>
                                    <!-- Best Set Card -->
                                    <div class="col-md-3 mb-3">
                                        <div class="summary-card">
                                            <div class="summary-value text-info" id="exercise-best-set">-</div>
                                         <div class="summary-label" data-i18n="best_set">BEST SET</div>
                                        </div>
                                    </div>
                                    <!-- Ranking Card with 1RM -->
                                    <div class="col-md-3 mb-3">
                                        <div class="summary-card">
                                            <div class="summary-value text-success" id="exercise-ranking">-</div>
                                          <div class="summary-label" data-i18n="estimated_1rm">ESTIMATED 1 RM</div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Chart -->
                                <div class="chart-container mb-4" style="position: relative; height: 250px;">
                                    <canvas id="exercise-chart"></canvas>
                                </div>

                                <!-- Session History -->
                                <h5 class="mb-3" data-i18n="session_history">Session History</h5>
                                <div class="table-responsive">
                                    <table class="table table-custom">
                                        <thead>
                                            <tr>
                                               <th data-i18n="date">Date</th>
                                             <th class="text-end" data-i18n="sets">Sets</th>
                                         <th class="text-end" data-i18n="best_set">Best Set</th>
                                          <th class="text-end" data-i18n="volume">Volume</th>
                                            </tr>
                                        </thead>
                                        <tbody id="exercise-sessions">
                                            <!-- Populated by JS -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- JS dependencies -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
         let exerciseChart = null;
         let allExercises = [];
         
    $(document).ready(function() {
        

            setTimeout(function() {
        localiseNutritionDates();
    }, 100);

        function formatDateLocalized(dateString) {
    const date = new Date(dateString);
    if (isNaN(date)) return dateString;

    const weekdayKey = date.toLocaleDateString('en-US', { weekday: 'short' }).toLowerCase();
    const monthKey = date.toLocaleDateString('en-US', { month: 'long' }).toLowerCase();

    console.log('Date:', dateString, 'WeekdayKey:', weekdayKey, 'MonthKey:', monthKey);
    
    const weekday = translateWeekday(weekdayKey);
    const month = translateMonth(monthKey);
    
    console.log('Translated weekday:', weekday, 'Translated month:', month);

    return `${weekday} ${date.getDate()} ${month} ${date.getFullYear()}`;
}

function localiseNutritionDates() {
    $('#daily-nutrition tbody tr').each(function () {
        const $first = $(this).find('td:first');
        const rawDate = $first.data('raw-date');  // Get raw date from data attribute
        if (rawDate) {
            $first.text(formatDateLocalized(rawDate));
        }
    });
    /* --- Weekly nutrition table --- */
    $('#weekly-nutrition tbody tr').each(function () {
        const $range = $(this).find('small'); // contains “2025-09-01 to 2025-09-07”
        if ($range.length === 0) return;

        const raw      = $range.text().trim();
        const [startRaw, endRaw] = raw.split(' to ');
        if (!endRaw) return; // unexpected format – skip

        const startLocal = formatDateLocalized(startRaw.trim());
        const endLocal   = formatDateLocalized(endRaw.trim());

        $range.text(`${startLocal} – ${endLocal}`); // en-dash between dates
    });
}
    // --- Update progress bars & localize dates when nutrition tab is shown ---
   $('#nutrition-tab').on('shown.bs.tab', function() {
    updateProgressBarsWithTargets();
    setTimeout(function() {
        localiseNutritionDates();
    }, 50);
});

// --- On page load if nutrition tab is active ---
if ($('#nutrition-tab').hasClass('active')) {
    updateProgressBarsWithTargets();
    setTimeout(function() {
        localiseNutritionDates();
    }, 100);
}

// --- Update progress bars & localize dates when switching daily/weekly sub-tabs ---
$('#daily-nutrition-tab, #weekly-nutrition-tab').on('shown.bs.tab', function() {
    updateProgressBarsWithTargets();
    setTimeout(function() {
        localiseNutritionDates();
    }, 50);
});
});
        
        // Helper function to translate exercise names
        function translateExerciseName(exerciseName) {
            return t(exerciseName) !== exerciseName ? t(exerciseName) : exerciseName;
        }

        // Helper function to translate muscle groups
        function translateMuscleGroup(muscleGroup) {
    if (!muscleGroup) return 'N/A';
    const lowercased = muscleGroup.toLowerCase().trim();
    
    // Map common muscle group variations to translation keys
    const muscleMap = {
        'chest': 'chest',
        'back': 'back',
        'legs': 'legs',
        'shoulders': 'shoulders',
        'arms': 'arms',
        'core': 'core',
        'rinta': 'chest',
        'selkä': 'back', 
        'jalat': 'legs',
        'olkapäät': 'shoulders',
        'kädet': 'arms',
        'vatsa': 'core'
    };
    
    const key = muscleMap[lowercased];
    return key ? t(key) : muscleGroup;
}


        // CSRF TOKEN //
        $.ajaxSetup({
            beforeSend: function(xhr, settings) {
                let token = $('meta[name="csrf-token"]').attr('content');
                if (token) {
                    xhr.setRequestHeader("X-CSRFToken", token);
                }
            }
        });
        
        // Initialize workout history when Workouts tab is activated
        $('#workouts-tab').on('shown.bs.tab', function() {
            loadWorkoutHistory('daily');
        });
        
        // Initialize exercises tab
        $('#exercises-tab').on('shown.bs.tab', function() {
            loadExercises();
        });

        // Back to list button
        $('#back-to-list').click(function() {
            $('#exercise-detail').hide();
            $('#exercises-list').closest('.table-responsive').show();
        });
        function smartKg(value) {
    if (value == null) return '0 kg';
    const rounded = Math.round(value * 10) / 10; // 1 decimal
    return (Number.isInteger(rounded) ? rounded : rounded.toFixed(1)) + ' kg';
}
function smartPercent(value) {
    if (value == null) return '0%';
    const rounded = Math.round(value * 10) / 10; // 1 decimal
    return (Number.isInteger(rounded) ? rounded : rounded.toFixed(1)) + '%';
}
       // Muscle group filter handler
let currentMuscleFilter = 'all';

$('.muscle-group-filter').click(function() {
    $('.muscle-group-filter').removeClass('active');
    $(this).addClass('active');

    currentMuscleFilter = $(this).data('muscle').toLowerCase().trim();
    applyMuscleFilter();
});

function applyMuscleFilter() {
    $('.exercise-row').each(function() {
        const muscle = $(this).data('muscle').toLowerCase().trim();

        if (currentMuscleFilter === 'all' || muscle === currentMuscleFilter) {
            $(this).show();
        } else {
            $(this).hide();
        }
    });
}
        // Search functionality
        $('#exercise-search').on('input', function() {
            const searchTerm = $(this).val().toLowerCase();
            $('.exercise-row').each(function() {
                const exerciseName = $(this).data('name').toLowerCase();
                $(this).toggle(exerciseName.includes(searchTerm));
            });
        });

        // Sorting functionality
        $('[data-sort]').click(function() {
            $('[data-sort]').removeClass('active');
            $(this).addClass('active');
            sortExercises($(this).data('sort'));
        });
        
        // Sort exercises based on criteria
        function sortExercises(criteria) {
            const sorted = [...allExercises];
            
            if (criteria === 'name') {
                sorted.sort((a, b) => a.name.localeCompare(b.name));
            } else if (criteria === 'pb') {
                sorted.sort((a, b) => b.personal_best - a.personal_best);
            } else if (criteria === 'recent') {
                sorted.sort((a, b) => {
                    const dateA = a.last_performed ? new Date(a.last_performed) : new Date(0);
                    const dateB = b.last_performed ? new Date(b.last_performed) : new Date(0);
                    return dateB - dateA;
                });
            }
            
            renderExercisesList(sorted);
        }

        // Load exercises list
        function loadExercises() {
            $.get("/workout/exercises", function(data) {
                allExercises = data.exercises || [];
                renderExercisesList(allExercises);
            }).fail(function() {
                $("#exercises-list").html(`
                    <tr>
                        <td colspan="5" class="text-center py-4 text-warning">
                            ${t("failed_load_exercises")}
                        </td>
                    </tr>
                `);
            });
        }

        // Render exercises list
        function renderExercisesList(exercises) {
    const container = $("#exercises-list");
    container.empty();

    if (!exercises || exercises.length === 0) {
        container.append(`<tr><td colspan="5" class="text-center py-4">${t("no_exercises_found")}</td></tr>`);
        return;
    }

    exercises.forEach(ex => {
        const trendClass = ex.volume_trend > 0 ? 'text-success' : 
                            ex.volume_trend < 0 ? 'text-danger' : 'text-muted';
        const trendIcon = ex.volume_trend > 0 ? 'fa-arrow-up' : 
                          ex.volume_trend < 0 ? 'fa-arrow-down' : 'fa-minus';
        
        const row = `
<tr class="exercise-row" data-id="${ex.id}" data-name="${ex.name}" data-muscle="${ex.muscle_group || 'N/A'}">
    <td>
        <strong>${translateExerciseName(ex.name)}</strong><br>
        <small class="text-muted">${translateMuscleGroup(ex.muscle_group)}</small>
    </td>
            <td class="text-end align-middle">
                <span class="badge bg-warning text-dark">${Math.round(ex.personal_best || 0)} kg</span>
            </td>
            <td class="text-end align-middle">${ex.last_performed || t('never')}</td>
            <td class="text-end align-middle">${(ex.total_volume || 0).toFixed(1)} kg</td>
            <td class="text-end align-middle">
                <span class="${trendClass}">
                    <i class="fas ${trendIcon} me-1"></i>
                    ${Math.abs(ex.volume_trend || 0).toFixed(1)}%
                </span>
            </td>
        </tr>`;
        container.append(row);
    });

    // Apply the active muscle filter after rendering
    applyMuscleFilter();


            // Add click handlers
            $('.exercise-row').click(function() {
                const exerciseId = $(this).data('id');
                loadExerciseDetail(exerciseId);
            });
        }

        // Load exercise detail
        function loadExerciseDetail(exerciseId) {
            $.get(`/workout/exercise/${exerciseId}`, function(data) {
                renderExerciseDetail(data);
            }).fail(function() {
                alert(t("failed_load_exercise_details"));
            });
        }

        // Safe parsing of weight/reps from strings like "64kg" or "10"
        function parseBestSet(rawSet) {
            if (!rawSet) return null;

            // If already object
            if (typeof rawSet === 'object' && rawSet.weight && rawSet.reps) {
                const weight = parseFloat(rawSet.weight);
                const reps = parseInt(rawSet.reps);
                if (isNaN(weight) || isNaN(reps) || reps <= 0) return null;
                return { weight, reps };
            }

            if (typeof rawSet === 'string') {
                // Match formats like "180kg × 5" or "180kg x 5"
                const match = rawSet.match(/(\d+(\.\d+)?)\s*kg\s*[×x]\s*(\d+)/i);
                if (!match) return null;
                const weight = parseFloat(match[1]);
                const reps = parseInt(match[3]);
                if (isNaN(weight) || isNaN(reps) || reps <= 0) return null;
                return { weight, reps };
            }

            return null;
        }
        
        function calculateOneRepMax(weight, reps) {
            weight = parseFloat(weight);
            reps = parseInt(reps);
            if (isNaN(weight) || isNaN(reps) || reps <= 0) return 0;

            if (reps === 1) return weight;

            const denom = 1.0278 - 0.0278 * reps;
            if (denom <= 0) return 0; // prevent negative or zero denominator
            return weight / denom;
        }
        function enhancePeriodRows() {
        $(document).on('click', '.period-row', function(e) {
            e.preventDefault();
            
            const $this = $(this);
            const isCollapsed = $this.hasClass('collapsed');
            
            // Toggle collapsed state
            $this.toggleClass('collapsed');
            
            // Add collapse icon if it doesn't exist
            if ($this.find('.collapse-icon').length === 0) {
                $this.find('td:first').append(' <i class="fas fa-chevron-down collapse-icon"></i>');
            }
            
            // Toggle visibility of muscle group rows
            let $nextRow = $this.next();
            while ($nextRow.length && $nextRow.hasClass('muscle-row')) {
                $nextRow.toggleClass('d-none');
                $nextRow = $nextRow.next();
            }
        });
    }
    
        // Render exercise detail (chart + session table)
        // ---------- Smart formatting helpers ----------
function smartKg(value) {
    if (value == null) return '0 kg';
    const rounded = Math.round(value * 10) / 10; // 1 decimal
    return (Number.isInteger(rounded) ? rounded : rounded.toFixed(1)) + ' kg';
}

function smartPercent(value) {
    if (value == null) return '0%';
    const rounded = Math.round(value * 10) / 10; // 1 decimal
    return (Number.isInteger(rounded) ? rounded : rounded.toFixed(1)) + '%';
}

// ---------- Render exercise detail ----------
function renderExerciseDetail(data) {
    // Exercise name
    $('#exercise-detail-name').text(translateExerciseName(data.name));

    // Summary cards
    $('#exercise-personal-best').text(smartKg(data.personal_best || 0));
    $('#exercise-monthly-volume').text(smartKg(data.monthly_volume || 0));
    $('#exercise-best-set').text(data.best_set || '-');

    // 1RM
    const bestSetData = parseBestSet(data.best_set);
    if (bestSetData) {
        const oneRepMax = calculateOneRepMax(bestSetData.weight, bestSetData.reps);
        $('#exercise-ranking').text(smartKg(oneRepMax));
    } else {
        $('#exercise-ranking').text('-');
    }

    // Chart
    renderExerciseChart(data.history);

    // Session table
    renderSessionsTable(data.history);

    // Show detail view and hide exercises list
    $('#exercises-list').closest('.table-responsive').hide();
    $('#exercise-detail').show();
}

// ---------- Render exercise chart ----------
function renderExerciseChart(history) {
    const ctx = document.getElementById('exercise-chart').getContext('2d');

    if (exerciseChart) exerciseChart.destroy();

    const sortedHistory = [...history].sort((a, b) => {
        const [dA, mA, yA] = a.date.split('.');
        const [dB, mB, yB] = b.date.split('.');
        return new Date(`${yA}-${mA}-${dA}`) - new Date(`${yB}-${mB}-${dB}`);
    });

    const dates = sortedHistory.map(h => h.date);
    const volumes = sortedHistory.map(h => h.volume || 0);
    const bestWeights = sortedHistory.map(h => h.best_weight || 0);
    const volumePointColors = sortedHistory.map(h => h.is_pr ? '#ffd166' : '#4cc9f0');
    const volumePointRadius = sortedHistory.map(h => h.is_pr ? 6 : 3);
    const weightPointColors = sortedHistory.map(h => h.is_pr ? '#ffd166' : '#f72585');
    const weightPointRadius = sortedHistory.map(h => h.is_pr ? 6 : 3);

    // Precompute trend percentages
    const trendValues = sortedHistory.map((h, i) => {
        if (i === 0) return null;
        const prevVolume = sortedHistory[i-1].volume || 0;
        return prevVolume ? ((h.volume - prevVolume) / prevVolume) * 100 : null;
    });

    exerciseChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: dates,
            datasets: [
                {
                    label: 'Volume (kg)',
                    data: volumes,
                    borderColor: '#4cc9f0',
                    backgroundColor: 'rgba(76,201,240,0.1)',
                    borderWidth: 2,
                    tension: 0.3,
                    yAxisID: 'y',
                    pointBackgroundColor: volumePointColors,
                    pointRadius: volumePointRadius,
                },
                {
                    label: 'Best Weight (kg)',
                    data: bestWeights,
                    borderColor: '#f72585',
                    backgroundColor: 'rgba(247,37,133,0.1)',
                    borderWidth: 2,
                    tension: 0.3,
                    yAxisID: 'y1',
                    pointBackgroundColor: weightPointColors,
                    pointRadius: weightPointRadius,
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                x: { grid: { color: 'rgba(255,255,255,0.1)' }, ticks: { color: '#e0e0e0' } },
                y: { 
                    type: 'linear', 
                    display: true, 
                    position: 'left', 
                    title: { display: true, text: 'Volume (kg)', color: '#e0e0e0' },
                    grid: { color: 'rgba(255,255,255,0.1)' }, 
                    ticks: { color: '#e0e0e0' } 
                },
                y1: { 
                    type: 'linear', 
                    display: true, 
                    position: 'right', 
                    title: { display: true, text: 'Weight (kg)', color: '#e0e0e0' },
                    grid: { drawOnChartArea: false, color: 'rgba(255,255,255,0.1)' }, 
                    ticks: { color: '#e0e0e0' } 
                }
            },
            plugins: {
                legend: { labels: { color: '#e0e0e0' } },
                tooltip: {
                    callbacks: {
                        afterLabel: function(context) {
                            const index = context.dataIndex;
                            if (trendValues[index] !== null) {
                                const trend = trendValues[index];
                                return `Trend: ${trend >= 0 ? '+' : ''}${smartPercent(trend)} from previous`;
                            }
                            return null;
                        }
                    }
                }
            }
        }
    });
}
        
        // Render sessions table
        function renderSessionsTable(history) {
            const container = $("#exercise-sessions");
            container.empty();

            // Sort ascending by date (oldest first)
            const ascendingHistory = [...history].sort((a, b) => {
                const [dA, mA, yA] = a.date.split('-');
                const [dB, mB, yB] = b.date.split('-');
                return new Date(`${yA}-${mA}-${dA}`) - new Date(`${yB}-${mB}-${dB}`);
            });

            let runningBest = 0;
            ascendingHistory.forEach(session => {
                if (session.best_weight > runningBest) {
                    session.is_pr = true;
                    runningBest = session.best_weight;
                } else {
                    session.is_pr = false;
                }
            });

            // Now display in descending order
            const sortedHistory = [...ascendingHistory]

            if (sortedHistory.length === 0) {
                container.append(`<tr><td colspan="4" class="text-center py-4">${t("no_session_history")}</td></tr>`);
                return;
            }

            sortedHistory.forEach(session => {
                let prIndicator = '';
                if (session.is_pr) {
                    prIndicator = ` <i class="fa-solid fa-trophy text-warning" title="Personal Record: ${session.best_weight} kg"></i>`;
                }

                const row = `
                    <tr>
                        <td>${session.date}${prIndicator}</td>
                        <td class="text-end">${session.sets || 0}</td>
                        <td class="text-end">${session.best_set || '-'}</td>
                        <td class="text-end">${(session.volume || 0).toFixed(1)} kg</td>
                    </tr>`;
                container.append(row);
            });
        }

        // Workout history tab functionality
        $('#workoutHistoryTabs button').click(function() {
            const period = $(this).attr('id').split('-')[0];
            loadWorkoutHistory(period);
        });
        
        $('#expand-all').click(() => $('.muscle-row').removeClass('d-none'));
        $('#collapse-all').click(() => $('.muscle-row').addClass('d-none'));
        
        $(document).on('click', '.period-row', function() {
            const wasCollapsed = $(this).hasClass('collapsed');
            $(this).toggleClass('collapsed', !wasCollapsed);
            $(this).nextUntil('.period-row').toggleClass('d-none');
        });

        // Initialize workout history if needed
        if (window.location.hash === '#workouts') loadWorkoutHistory('daily');

        // Workout history functions
        function loadWorkoutHistory(period) {
            $.get("/workout/history?period=" + period, function(data) {
                renderWorkoutHistory(data.history, period);
            }).fail(function() {
                const containerId = period + "-workout-history";
                $("#" + containerId).html(`
                    <tr>
                        <td colspan="6" class="text-center py-4 text-warning">Failed to load workout data. Please try again.</td>
                    </tr>`);
            });
        }
        
        // Render workout history
       function renderWorkoutHistory(history, period) {
    const container = $("#" + period + "-workout-history");
    container.empty();

    if (!history || history.length === 0) {
        container.append(`<tr><td colspan="6" class="text-center py-4">No workout data available</td></tr>`);
        return;
    }

    history.forEach(item => {
        let periodLabel = '';
        let periodRow = '';
        let muscleRows = '';

        if (period === 'daily') {
            const date = new Date(item.date);
            const weekday = date.toLocaleDateString('en-US', { weekday: 'short' }).toLowerCase();
            const translatedWeekday = translateWeekday(weekday);
            periodLabel = `${translatedWeekday}, ${date.getDate()}/${date.getMonth() + 1}`;
            
            periodRow = `<tr class="period-row collapsed align-middle" style="cursor:pointer;">
                            <td><strong>${periodLabel}</strong></td>
                            <td class="text-end">${item.sessions_count || 0}</td>
                            <td>&nbsp;</td>
                            <td class="text-end">${item.total_sets || 0}</td>
                            <td class="text-end">${item.total_reps || 0}</td>
                            <td class="text-end">${parseFloat(item.total_volume || 0).toFixed(1)}</td>
                        </tr>`;
        } else {
            const startDate = period === 'weekly' ? new Date(item.week_start) : new Date(item.month_start);
            
            if (period === 'weekly') {
                const weekEnd = new Date(startDate); 
                weekEnd.setDate(weekEnd.getDate() + 6);
                const startMonth = translateMonth(startDate.toLocaleDateString('en-US', {month:'long'}).toLowerCase());
                const endMonth = translateMonth(weekEnd.toLocaleDateString('en-US', {month:'long'}).toLowerCase());
                periodLabel = `${startDate.getDate()} ${startMonth} - ${weekEnd.getDate()} ${endMonth}`;
            } else {
                const monthName = translateMonth(startDate.toLocaleDateString('en-US', {month:'long'}).toLowerCase());
                periodLabel = `${monthName} ${startDate.getFullYear()}`;
            }

            periodRow = `<tr class="period-row align-middle" style="cursor:pointer;">
                            <td><strong>${periodLabel}</strong></td>
                            <td class="text-end">${item.sessions_count || 0}</td>
                            <td>&nbsp;</td>
                            <td class="text-end">${item.total_sets || 0}</td>
                            <td class="text-end">${item.total_reps || 0}</td>
                            <td class="text-end">${parseFloat(item.total_volume || 0).toFixed(1)}</td>
                        </tr>`;
        }

        for (const [muscle, stats] of Object.entries(item.muscles || {})) {
            muscleRows += `<tr class="muscle-row d-none">
                            <td></td><td></td><td>${translateMuscleGroup(muscle)}</td>
                            <td class="text-end">${stats.total_sets || 0}</td>
                            <td class="text-end">${stats.total_reps || 0}</td>
                            <td class="text-end">${parseFloat(stats.total_volume || 0).toFixed(1)}</td>
                        </tr>`;
        }

        container.append(periodRow + muscleRows);
    });
}
        
        // Function to update progress bars with targets from server
        function updateProgressBarsWithTargets() {
            $.get('/get_nutrition_targets', function(targets) {
                // Update protein progress bars
                $('.progress-bar-protein').each(function() {
                    const value = $(this).data('value');
                    const percentage = Math.min(100, (value / targets.proteins) * 100);
                    $(this).css('width', percentage + '%');
                });
                
                // Update fats progress bars
                $('.progress-bar-fats').each(function() {
                    const value = $(this).data('value');
                    const percentage = Math.min(100, (value / targets.fats) * 100);
                    $(this).css('width', percentage + '%');
                });
                
                // Update salt progress bars
                $('.progress-bar-salt').each(function() {
                    const value = $(this).data('value');
                    const percentage = Math.min(100, (value / targets.salt) * 100);
                    $(this).css('width', percentage + '%');
                });
                
                // Carbs target is not in the API response, keeping the original logic
                $('.progress-bar-carbs').each(function() {
                    const value = $(this).data('value');
                    const percentage = Math.min(100, (value / 250) * 100);
                    $(this).css('width', percentage + '%');
                });
            }).fail(function() {
                console.error('Failed to fetch nutrition targets');
                // Fallback to original values if API fails
                $('.progress-bar-protein').each(function() {
                    const value = $(this).data('value');
                    const percentage = Math.min(100, (value / 150) * 100);
                    $(this).css('width', percentage + '%');
                });
                $('.progress-bar-fats').each(function() {
                    const value = $(this).data('value');
                    const percentage = Math.min(100, (value / 70) * 100);
                    $(this).css('width', percentage + '%');
                });
                $('.progress-bar-salt').each(function() {
                    const value = $(this).data('value');
                    const percentage = Math.min(100, (value / 5) * 100);
                    $(this).css('width', percentage + '%');
                });
                $('.progress-bar-carbs').each(function() {
                    const value = $(this).data('value');
                    const percentage = Math.min(100, (value / 250) * 100);
                    $(this).css('width', percentage + '%');
                });
            });
        }
        
   
    </script>
    
    <script>
        // Initialize tooltips globally
        document.addEventListener("DOMContentLoaded", function () {
            const tooltipTriggerList = [].slice.call(
                document.querySelectorAll('[data-bs-toggle="tooltip"]')
            )
            tooltipTriggerList.map(el => new bootstrap.Tooltip(el))
        })
    </script>
</body>
</html>
