    <!DOCTYPE html>
    <html lang="en">
    <head>
        <meta name="csrf-token" content="{{ csrf_token() }}">
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
        <title>TrackYou Kalorilaskuri</title>
        <meta name="description" content="TrackYou Kalorilaskuri — moderni, ilmainen ravinnon ja kaloreiden seurantasovellus verkossa.">
        <meta property="og:title" content="TrackYou Kalorilaskuri">
        <meta property="og:description" content="Seuraa kaloreita, makroja ja aterioita helposti.">
        <meta property="og:type" content="website">
        <meta property="og:url" content="https://trackyou.fi">
        <meta property="og:image" content="https://trackyou.fi/static/images/favicon-48x48.png">
        <meta name="twitter:card" content="summary">
        <meta name="twitter:title" content="TrackYou Kalorilaskuri">
        <meta name="theme-color" content="#8b34f6">
        <meta name="twitter:description" content="Moderni kalorilaskuri ja ravintopäiväkirja verkossa.">
        <link rel="icon" type="image/png" sizes="16x16" href="{{ url_for('static', filename='images/favicon-16x16.png') }}">
        <link rel="icon" type="image/png" sizes="32x32" href="{{ url_for('static', filename='images/favicon-32x32.png') }}">
        <link rel="icon" type="image/png" sizes="48x48" href="{{ url_for('static', filename='images/favicon-48x48.png') }}">
        <link rel="icon" href="{{ url_for('static', filename='favicon.ico') }}" type="image/x-icon">
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
        <link href="https://fonts.googleapis.com/css2?family=Calibri&display=swap" rel="stylesheet">
        <link rel="preload" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/webfonts/fa-solid-900.woff2" as="font" type="font/woff2" crossorigin="anonymous">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
        <link rel="preload" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" as="style">
        <link rel="preconnect" href="https://cdn.jsdelivr.net">
        <link rel="preconnect" href="https://fonts.googleapis.com">
        <link rel="preconnect" href="https://cdnjs.cloudflare.com">
        <link rel="manifest" href="/manifest.json">
        <script src="https://unpkg.com/@zxing/library@latest"></script>
        <script src="/static/js/translations.js"></script>
        <style>
            /* ===== BASE STYLES ===== */
            body {
                font-family: 'Roboto', sans-serif;
                font-size: 12px;
                background-color: #161616 !important;
                color: #e0e0e0;
            }
            
            .bg-black, .modal-header, .modal-footer {
        background-color: #0c0c0c !important;
        border-color: #444;
    }
            
            .card, .list-group-item, .modal-content {
                background-color: #1d1d1d;
                color: #e0e0e0;
                border: 1px solid #444;

            }
            
            .card-header {
                background: rgba(39, 39, 39, 0.7);
                border-bottom: 1px solid rgba(100, 100, 200, 0.3);
                padding: 20px;
                font-weight: 600;
                font-size: 1.4rem;
                color: #e0e0e0;
            }
            
            .form-control, .form-select {
            background-color: #121212 !important;
            border: 1px solid #333 !important;
            color: #eee;
            border-radius: 20px !important;
            font-size: 14px !important;
            padding: 6px 12px !important;
            height: 36px !important;
            transition: background-color 0.3s ease, border-color 0.3s ease;
            }

            .form-control:focus, .form-select:focus {
                border-color: #555 !important;
                box-shadow: none !important;
                background-color: #181818 !important;
                color: #eee !important;
            }

            .form-control::placeholder, .form-select::placeholder {
                color: #ddd !important;
                opacity: 0.6;
            }
            
            /* ===== ANIMATIONS & KEYFRAMES ===== */
            @keyframes rotate {
                100% {
                    transform: rotate(360deg);
                }
            }
            
            @keyframes spin {
                to { 
                    transform: rotate(360deg); 
                }
            }
            
            @keyframes fadeIn {
                from { 
                    opacity: 0; 
                    transform: translateY(10px); 
                }
                to { 
                    opacity: 1; 
                    transform: translateY(0); 
                }
            }
            
            @keyframes scan {
                0% { top: 30%; }
                50% { top: 50%; }
                100% { top: 30%; }
            }
            
            .spinner-delete {
                display: inline-block;
                width: 16px;
                height: 16px;
                border: 2px solid rgba(255,255,255,0.3);
                border-radius: 50%;
                border-top-color: #fff;
                animation: spin 1s ease-in-out infinite;
            }
            
            /* ===== LAYOUT & COMPONENTS ===== */
            .container-main {
                display: auto;
                grid-template-columns: 1180px;
                grid-template-rows: 500px 740px;
                gap: 15;
                margin: 0 auto;
                width: 1180px;
                position: relative;
            }
        /* glass effect on cards */
            .grid-panel {
                border: 1px solid rgba(255, 255, 255, 0.1) !important;
                display: flex;
                flex-direction: column;
                flex: 1;
                min-height: 0;
                overflow: hidden;
                border-radius: 16px !important; /* Rounded corners */
                background: rgba(30, 30, 30, 0.7) !important; /* Semi-transparent background */
                backdrop-filter: blur(10px); /* Glass effect */
                -webkit-backdrop-filter: blur(10px); /* Safari support */
                box-shadow: 
            0 8px 32px rgba(0, 0, 0, 0.3),
            inset 0 1px 1px rgba(255, 255, 255, 0.1); /* Depth and inner highlight */
            }
            .grid-panel .card {
        border-radius: 16px;
        background: transparent;
        border: none;
            }
            .grid-panel .card-header {
        border-radius: 16px 16px 0 0 !important;
        background: rgba(39, 39, 39, 0.6) !important;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1) !important;
    }
    .grid-panel .card-body {
        border-radius: 0 0 16px 16px;
    }
    .group-header {
        user-select: none !important;
        border-radius: 8px 8px 0 0 !important;
        background: linear-gradient(135deg, var(--group-color), rgba(0,0,0,0.6)) !important;
    }
    .group-items {
        border-radius: 0 0 8px 8px !important;
    }

            .top-panel {
                grid-column: 1;
            }
            
            .card-body {
                flex: 1;
                padding: 10px;
                overflow: auto;
            }
            
            .modal-dialog-centered {
                display: flex;
                align-items: center;
                min-height: calc(100% - 1rem);
            }
            
            #search-results {
                max-height: 450px;
                overflow-y: auto;
                border: 1px solid #444;
                border-radius: 4px;
                background-color: #2b2b2b;
                font-size: 15px;
                font-weight: 600 !important;
            }
            
            .food-log-container {
                display: flex;
                flex-direction: column;
                height: 100%;
            }
            
            .form-row {
                display: flex;
                flex-wrap: wrap;
                margin-right: -5px;
                margin-left: -5px;
            }
            
            .form-col {
                padding-right: 5px;
                padding-left: 5px;
                flex: 1 0 0%;
            }
            
            .position-relative {
                position: relative;
            }
            
            /* ===== FOOD GROUPS ===== */
            
            .collapsed-group {
                height: auto !important;
                min-height: unset !important;
            }
        
            
            .group-header {
                background: linear-gradient(135deg, var(--group-color), rgba(0,0,0,0.8)) !important;
                padding: 8px 12px !important;
                border-radius: 8px 8px 0 0 !important;
                margin: 8px 0 0 0 !important;
                border: none !important;
                cursor: pointer;
                line-height: 12px !important;
                transition: all 0.3s ease;
            }
            
            .group-header:hover {
                position: relative;
                filter: brightness(1.15);
                z-index: 1;
                box-shadow: 0 0 10px rgba(255,255,255,0.5);
                z-index: 2;
                border: 2px solid white;
                color: black;
                font-weight: bold;
            }
            
            .group-icon {
                flex-shrink: 0;
                width: 26px;
                height: 26px;
                background: rgba(255, 255, 255, 0.2);
                border-radius: 50%;
                display: flex;
                align-items: center;
                justify-content: center;
                margin-right: 8px;
                font-size: 12px;
                color: white;
                border: 2px solid var(--group-color);
                box-shadow: 0 3px 6px rgba(0,0,0,0.2) inset, 0 0 0 1px rgba(0,0,0,0.3);
            }
            
            .group-title {
                font-weight: bold;
                font-size: 14px !important;
                text-transform: uppercase;
                letter-spacing: 1px;
                color: white;
                width: 200px;
                text-shadow: 0 1px 3px rgba(0,0,0,0.3);
                flex: 1;
                min-width: 0;
            
            }
            
            .group-items {
                max-height: none !important;
                font-size: 12px;
                flex: 1;
                overflow-anchor: none;
                overflow: visible !important;
                min-height: auto;
                overflow-y: visible !important;
                border-left: 3px solid #00000079;
                border-right: 3px solid #00000079;
                border-bottom: 3px solid #00000079;
                border-radius: 0 0 6px 6px;
                line-height: 12px;
                transition: none !important;
            }
            .group-items.list-group-flush {
    border-radius: 0 0 var(--radius-base) var(--radius-base) !important;
    margin-bottom: 0;
}
            
            .toggle-group {
                padding: 2px 4px !important;
                font-size: 14px !important;
                margin-left: 10px !important;
                flex-shrink: 0;
                height: 24px;
                background-color: rgba(47, 47, 47, 0.2) !important;
                color: white !important;
                border: 1px solid rgba(255, 255, 255, 0.3) !important;
                transition: all 0.2s ease;
            }
            
            .toggle-group:hover {
                background-color: rgba(255, 255, 255, 0.3) !important;
            }
            
            /* ===== FOOD ITEMS ===== */
            .food-item-container {
                min-width: 40% !important;
                padding-right: 8px !important;
                display:flex;
                flex-grow: 1;
                transition: transform 0.1s ease;
            }
            
            .food-item-container:hover {
                transform: translateX(5px);
            }
            
            .list-group-item.selected {
                background-color: #444 !important;
                border: 2px solid #424242 !important;
                box-shadow: 0 0 0 2px #636363, 0 0 10px rgba(53, 53, 53, 0.5) !important;
                transform: scale(0.99);
                transition: all 0.1s ease;
                background-color: #2a2a2a !important;
            }
            
            
            .nutrition-and-actions {
                display: flex;
                align-items: center;
            }
            
            .nutrition-values-container {
                display: flex;
                align-items: center;
                justify-content: flex-end;
                flex-grow: 1;
                gap: 0px;
            }
            
            .group-nutrition-container {
                display: flex;
                align-items: center;
                justify-content: flex-end;
                flex-grow: 1;
                background: transparent !important;
            }
            
            .group-nutrition {
                display: flex;
                margin-right: 4px;
            }
            
            /* ===== NUTRITION VALUES ===== */
            .nutrition-value-xxs {
                border-radius: 6px;
                min-width: 70px;
                padding: 2px 2px !important;
                display: flex;
                text-align: center;
                justify-content: center;
                align-items: center;
                box-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
                font-weight: bold !important;
            }
            
            .nutrition-value-xxs{
                background: var(--group-color) !important;
                color: #000 !important;
            }
            
            .nutrition-value-xxs.nutrition-calories {
                background: linear-gradient(135deg, #ffffff, #e0e0e0) !important;
                color: #000 !important;
            }
            
            .group-nutrition-container .nutrition-value-xxs {
                box-shadow: 0 2px 4px rgba(0,0,0,0.3);
                font-weight: bold;
                transition: transform 0.2s ease;
            }
            
            .group-nutrition-container .nutrition-value-xxs:hover {
                transform: scale(1.05);
            }
            /* alerts */
            #ean-alert {
        background-color: #2f2f2f; /* dark background */
        color: #fff;               /* white text */
        border: 1px solid #a62aff; /* gold border */
        border-radius: 20px;
    }
            /* ===== REAL-TIME BREAKDOWN ===== */
            #rt-breakdown-container {
                margin: 15px 0;
                padding: 8px !important;
                border: 1px solid #444;
                border-radius: 4px;
                background-color: #000000;
                background: linear-gradient(to bottom, #1a1a1a, #2a2a2a) !important;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
                height: auto !important;
                width: 100%;
            }
            
            .rtb-yay {
                position: relative;
                overflow: hidden;
                color: rgb(0, 0, 0);
                min-width: 22% !important;
                padding: 5px 8px;
                display: flex;
                justify-content: center;
                align-items: center;
                font-weight: bold;
                height: 70px !important;
                min-width: 80px !important;
                box-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
                margin-bottom: 5px;
                border-radius: 10px !important;
            }
            
            .rtb-yay:hover {
                transform: scale(1.05) !important;
                box-shadow: 0 4px 8px rgba(0, 0, 0, 0.4) !important;
                filter: brightness(1.1) !important;
                z-index: 2;
            }
            
            .icon-bg {
                position: absolute;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                font-size: 30px !important;
                color: rgba(0, 0, 0, 0.3) !important;
                z-index: 1;
                opacity: 0.9;
                pointer-events: none;
            }
            
            .rtb-text-container {
                position: relative;
                z-index: 2;
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                width: 100%;
            }
            
            .rtb-value {
                display: block;
                font-weight: bold;
                text-align: center;
                transition: font-size 0.2s ease;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
                padding: 0 2px;
                width: 100%;
                font-size: 18px !important;
                line-height: 1;
            }
            
            .rtb-label {
                display: block;
                font-size: 8px !important;
                font-weight: bold;
                text-transform: uppercase;
                letter-spacing: 0.5px;
                opacity: 0.9;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
                width: 100%;
                text-align: center;
                line-height: 1.2;
                margin-top: 1px;
            }
            /* TOAST STYLING */
            .toast {
            --toast-bg: #1f1f1f;
            --toast-text: #f1f1f1;
            --toast-success: #00c853;
            --toast-error: #ff5252;
            --toast-warning: #ffb300;
            --toast-info: #29b6f6;

            background-color: var(--toast-bg);
            color: var(--toast-text);
            border-radius: 0.75rem;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
            opacity: 0;
            transform: translateY(-10px);
            transition: opacity 0.4s ease, transform 0.3s ease;
            overflow: hidden;
            border-left: 4px solid var(--toast-info);
            backdrop-filter: blur(10px);
            font-family: 'Inter', sans-serif;
            }

            .toast.show {
            opacity: 1;
            transform: translateY(0);
            }

            .toast .toast-body {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.85rem 1rem;
            }

            .toast .toast-body i {
            font-size: 1.25rem;
            }

            /* Type colors */
            .toast-success { border-left-color: var(--toast-success); }
            .toast-error { border-left-color: var(--toast-error); }
            .toast-warning { border-left-color: var(--toast-warning); }
            .toast-info { border-left-color: var(--toast-info); }
            .toast-container .toast {
            margin-top: 0.5rem;
            }
            .toast-container .toast.show {
            animation: slideIn 0.35s ease;
            }
            @keyframes slideIn {
            from { transform: translateY(-15px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
            }
            /* ===== BUTTONS ===== */
            .highlight-temp {
            background-color: #666 !important; /* slightly lighter than your bg-secondary */
            transition: background-color 0.1s ease-in-out;
            }
            .btn-beta {
                display: inline-block;
                background-color: #8b34f6;
                color: #ffffff;
                border: 1px solid #000000 !important;
                border-radius: 30px;
                text-align: center;
                padding: 2px 20px;
                font-size: 12px;
                font-weight: bold;
                box-shadow: 0px 1px 5px rgb(179, 179, 180);
                cursor:auto !important;
            }
            #search-results .calorie-badge {
                align-items:center;
                display: block;
                justify-content: flex-end;
                overflow: hidden;
                flex-direction: row;
            }
            #clear-search {
                background-color: #121212;
                color: #ffffff !important;
                font-size: 16px;
                margin-left: 5px;
                box-shadow: 0 2px 4px rgba(0,0,0,0.2);
                border: none;
                border-radius: 16px;
                width: 20px;
                height: 20px;
                display: flex;
                align-items: center;
                justify-content: center;
                font-weight: bold;
                transition: all 0.3s ease;
                padding: 16px;
            }
            
            #clear-search:hover {
                background-color: #ffffff !important;
                color: rgb(0, 0, 0) !important;
                box-shadow: 0 4px 6px rgba(0,0,0,0.3);
                color: rgb(0, 0, 0) !important;
            }
            
            .delete-item {
                background: none !important;
                border: none;
                color: #ffffff !important;
                padding: 0;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 16px;
                transition: all 0.3s ease;
                border-radius: 50%;
                opacity: 0.7;
            }
            
            .delete-item:hover {
                color: #ff0000 !important;
                transform: scale(1.1);
                opacity: 1;
                background-color: rgba(255, 0, 0, 0.1) !important;
            }
            
            .delete-item i {
                font-size: 12px !important;
                color: white !important;
            }
            
            .edit-grams {
                padding: 1px 7px !important;
                font-size: 12px !important;
                min-width: 48px;
                height: 14px !important;
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                border-radius: 4px;
                transition: all 0.2s ease;
                background-color: #ffffff;
                color: black;
            }
            .edit-grams-btn {
        font-size: 12px !important;
    }
            
            .edit-grams:hover {
                transform: scale(1.02);
                box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            }
            
            .edit-grams-input {
                padding: 1px 6px !important;
                font-size: 12px !important;
                width: 45px !important;
                height: 16px !important;
                border-radius: 2px;
                background-color: #ffffff;
                color: black !important;
                border: 1px solid #ffffff;
                font-weight: 500 !important;
                text-align: center;
                outline: none;
                transition: all 0.2s ease;
                box-sizing: border-box;
                
            }
            
            .edit-grams-input:hover,
            .edit-grams-input:focus {
                transform: scale(1.00);
                box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            }
            /* Chrome, Edge, Safari remove arrows for desktop */
            .edit-grams-input::-webkit-outer-spin-button,
            .edit-grams-input::-webkit-inner-spin-button {
                -webkit-appearance: none;
                margin: 0;
            }

            /* Firefox */
            .edit-grams-input[type=number] {
                -moz-appearance: textfield;
            }
            
                        #add-food {
                    display: block;
                    width: 100%; /* Default mobile: full width */
                    max-width: 500px;
                    margin: 0 auto;
                    
                    background-color: #1b1b1b !important;
                    color: #ffffff !important;
                    border: 1px solid #ad88f1 !important;
                    border-radius: 20px;
                    padding: 12px 20px;
                    font-size: 16px;
                    font-weight: 700;
                    transition: all 0.3s ease;
                    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
                }

                #add-food:hover {
                    background-color: #f0f0f0;
                    color: #000000;
                    transform: scale(1.02);
                    box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3);
    }
            
            .modal-content .btn:not(.btn-close) {
                transition: all 0.3s ease;
            }
            
            .modal-content .btn:not(.btn-close):hover {
                transform: scale(1.05);
                box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
            }
            
            .modal-btn {
                display: inline-block;
                background-color: #1b1b1b;
                color: #ffffff;
                border: 1px solid #444 !important;
                border-radius: 20px;
                padding: 8px 12px;
                font-size: 12px;
                font-weight: 600;
                transition: all 0.3s ease;
            }
            
            .modal-btn:hover, 
            .modal-btn:focus {
                background-color: #d4d4d4 !important;
                color: black !important;
                transform: scale(1.02);
            }
            
            .modal-btn.active {
                background: #858585 !important;
                color: #000000 !important;
                transform: translateY(0);
            }
            /* food items animations */




            /* portion buttons */
            #portion-buttons .portion-btn {
             margin: 3px; /* spacing between buttons */
            }
            .portion-btn {
                display: inline-block;
                background-color: #1b1b1b;
                color: #ffffff;
                border: 1px solid #444 !important;
                border-radius: 20px;
                padding: 8px 12px;
                font-size: 12px;
                font-weight: 600;
                transition: all 0.3s ease;
            }
            
            .portion-btn:hover {
                background-color: #f0f0f0;
                color: #000000;
                transform: scale(1.02);
            }
            
            .portion-btn.active {
                background-color: #ffffff !important;
                color: #000000 !important;
                border: solid 2px;
                transform: scale(1.02);
                box-shadow: 0 0 10px rgba(255, 255, 255, 0.3);
            }
            /* Favorite portion button */
            .favourite-btn {
                background: linear-gradient(135deg, #ffd700, #ffa500) !important;
                color: #000 !important;
                border: 1px solid #ffa500 !important;
            }

            .favourite-btn:hover {
                background: linear-gradient(135deg, #ffa500, #ff8c00) !important;
            }

            .favourite-btn.active {
                background: linear-gradient(135deg, #ff8c00, #ff7700) !important;
                border: 2px solid #000 !important;
            }
            #action-move, #action-copy {
                background: #1b1b1b !important;
                color: #fff !important;
                border: 1px solid #888 !important;
            }
            
            #action-move:hover, 
            #action-move:focus,
            #action-copy:hover,
            #action-copy:focus {
                background: #ffffff !important;
                color: #000000 !important;
                border-color: #888 !important;
                transform: none !important;
                box-shadow: none !important;
            }
            
            #action-move.active, 
            #action-copy.active {
                background: #ffffff !important;
                color: #000000 !important;
            }
            
            #move-items, #clear-session {
                display: inline-block;
                background-color: #1b1b1b;
                color: #ffffff;
                border: 1px solid #444 !important;
                border-radius: 20px;
                padding: 8px 12px;
                font-size: 12px;
                font-weight: 600;
                transition: all 0.3s ease;
            }
            
            #move-items:hover, #clear-session:hover {
                background-color: #d4d4d4 !important;
                color: black !important;
                transform: scale(1.02);
            }
            
            #move-items:active, #clear-session:active {
                background: #ffffff !important;
                color: #000000 !important;
                box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
                transform: translateY(0);
            }
            
            #save-template-btn, #apply-template-btn {
                display: inline-block;
                background-color: #1b1b1b;
                color: #ffffff;
                border: 1px solid #444 !important;
                border-radius: 20px;
                padding: 8px 12px;
                font-size: 12px;
                font-weight: 600;
                transition: all 0.3s ease;
            }
            
            #save-template-btn:hover, #apply-template-btn:hover {
                background-color: #d4d4d4 !important;
                color: black !important;
                transform: scale(1.02);
            }
            
            #save-template-btn:active, #apply-template-btn:active {
                background: #858585 !important;
                color: #000000 !important;
                transform: translateY(0);
            }
            
            #save-template-btn:disabled {
                opacity: 0.5;
                cursor: not-allowed;
                transform: none;
            }
            
            #save-template-btn:disabled:hover {
                background: linear-gradient(to bottom, #353535, #5c5c5c) !important;
                transform: none;
                box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            }
            
            .btn-custom {
                display: flex;
                align-items: center;
                justify-content: center;
                padding: 6px 12px;
                font-size: 14px;
            }
            
            .btn-custom .btn-label {
                font-size: 12px;
                margin-top: 2px;
            }
    #date-selector option:hover,
    #date-selector option:focus,
    #date-selector option:checked {
        background-color: #444 !important;
        color: #fff !important;
    }
    #date-selector:focus {
        border-color: #888;
        box-shadow: 0 0 0 2px rgba(255,255,255,0.2);
    }


            /* ===== MEAL GROUP COLORS ===== */
            .breakfast {
                --group-color: #ff9e6d;
            }
            
            .lunch {
                --group-color: #6dc0d5;
            }
            
            .dinner {
                --group-color: #b989f0;
            }
            
            .snack {
                --group-color: #ffd166;
            }
            
            .other {
                --group-color: #7bc8a4;
            }
            
            /* ===== NUTRITION GRID ===== */
            .nutrition-grid-container {
                position: fixed;
                top: 100px;
                left: calc(50% + 590px) !important;
                width: 120px;
                height: 900px;
                z-index: 100;
                max-height: 85vh;
                overflow-y: auto;
                transform-origin: top left;
                transform: scale(0.8);
                transform: scale(calc(0.8 + 0.2 * (100vw - 1200px) / 400));
            }
            
            .nutrition-grid {
                display: grid;
                grid-template-rows: repeat(9, 1fr);
                height: 100%;
                width: 100%;
                background-color: #1a1a1a;
                border: 1px solid #2b2b2b;
                border-radius: 12px;
                overflow: hidden;
                box-shadow: 0 4px 12px rgba(0,0,0,0.4);
            }
            
            .grid-cell {
                display: flex;
                flex-direction: column;
                justify-content: center;
                align-items: center;
                padding: 12px 5px;
                font-size: 1.3vh !important;
                text-align: center;
                border-bottom: 1px solid #2b2b2b;
                min-height: 55px !important;
                box-sizing: border-box;
                transition: all 0.3s ease;
            }
            
            .grid-cell:last-child {
                border-bottom: none;
            }
            
            .grid-cell:hover {
                transform: scale(1.03);
                z-index: 2;
                box-shadow: 0 4px 8px rgba(0,0,0,0.3);
            }
            
            .grid-cell i {
                font-size: 1.4vh !important;
                margin-bottom: 3px !important;
            }
            
            .grid-value {
                font-weight: bold;
                font-size: 1.4vh !important;
                margin-top: 2px;
            }
            
            .grid-cell:nth-child(1) {     
                color: #fffefe;
                font-weight: bold;
                font-size: 14px;
            }
            
            .grid-cell:nth-child(2) {
                background-color: #ffffff;
                color: #000000;
            }
            
            .grid-cell:nth-child(3),
            .grid-cell:nth-child(4),
            .grid-cell:nth-child(5) {
                color: #000000;
            }
            
            .grid-cell:nth-child(6),
            .grid-cell:nth-child(7),
            .grid-cell:nth-child(8),
            .grid-cell:nth-child(9) {
                background-color: #ffffff;
                color: #000000;
            }
            
            .grid-header {
                background: linear-gradient(135deg, #494949, #080808);
                color: white;
                font-weight: bold;
                font-size: 16px;
                border: none !important;
                outline: none !important;
                box-shadow: none !important;
            }
            
            .grid-calories, .grid-calories-mobile {
                background: linear-gradient(135deg, #ffffff, #929292);
                color: #000;
            }
            
            .grid-proteins, .grid-proteins-mobile {
                background: linear-gradient(135deg, #b989f0, #929292);
                color: #000;
            }
            
            .grid-carbs, .grid-carbs-mobile {
                background: linear-gradient(135deg, #6dc0d5, #929292);
                color: #000;
            }
            
            .grid-fats, .grid-fats-mobile {
                background: linear-gradient(135deg, #ff9e6d, #929292);
                color: #000;
            }
            
            .grid-saturated, .grid-saturated-mobile {
                background: linear-gradient(135deg, #ffd166, #929292);
                color: #000;
            }
            .grid-sugars, .grid-sugars-mobile {
                background: linear-gradient(135deg, #7bc8a4, #929292);
                color: #000;
            }
            .grid-fiber, .grid-fiber-mobile {
                background: linear-gradient(135deg, #ffbe9e, #929292);
                color: #000;
            }
            .grid-salt, .grid-salt-mobile {
                background: linear-gradient(135deg, #6dc0d5, #929292);
                color: #000;
            }
            /* ===== ACTIVITY GRID ===== */
            .activity-grid-container {
                position: fixed;
                top: 100px;
                left: calc(50% - 590px - 109px);
                width: 120px;
                height: 330px;
                z-index: 100;
                max-height: 85vh;
                overflow-y: auto;
                transform: scale(0.8);
            }
            .activity-grid {
                display: grid;
                grid-template-rows: repeat(2, 1fr);
                height: 100%;
                width: 100%;
                background-color: #1a1a1a;
                border: 1px solid #2b2b2b;
                border-radius: 12px;
                overflow: hidden;
                box-shadow: 0 4px 12px rgba(0,0,0,0.4);
            }
            .grid-activity {
                background: linear-gradient(135deg, #202020, #000000);
                color: #ffffff;
                font-size: 0.8rem !important;
                font-weight: bold;
            }
            .grid-today {
                background: linear-gradient(135deg, #ffffff, #737473);
                color: #000;
                font-size: 0.8rem !important;
                font-weight: bold;
            }
            .grid-status {
                font-size: 0.8rem;
                font-weight: bold;
                margin-top: 5px;
                padding: 3px 8px;
                border-radius: 10px;
            }
            .status-maintain {
                background-color: rgba(160, 76, 160, 0.7);
                color: #000;
            }
            .status-gain {
                background-color: rgba(255, 100, 100, 0.7);
                color: #000000;
            }
            .status-loss {
                background-color: rgba(100, 200, 100, 0.7);
                color: #000000;
            }
            .calorie-diff {
                font-weight: bold;
                font-size: 1.4rem;
            }
            .calorie-positive {
                color: #ff0000;
            }    
            .calorie-negative {
                color: #00ff00;        }
            
            
        /* ===== TOGGLE GRID BUTTON ===== */
            #toggle-grid-btn {
                position: relative;
                border-radius: 50%;
                width: 40px;
                height: 40px;
                display: flex;
                align-items: center;
                justify-content: center;
                padding: 0;
                transition: all 0.3s ease;
                border: none;
                overflow: hidden;
                z-index: 2;
                background-color: #838383;
            }
            
            #toggle-grid-btn.active {
                background: linear-gradient(135deg, #6a0dad, #8a2be2) !important;
            }
            
            #toggle-grid-btn.active::before {
                content: '';
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: conic-gradient(
                    transparent 120deg,
                    #ffffff 120deg,
                    #ffffff 240deg,
                    transparent 240deg
                );
                border-radius: 50%;
                animation: rotate 2s linear infinite;
                z-index: -1;
            }
            
            #toggle-grid-btn.active::after {
                content: '';
                position: absolute;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                width: 36px;
                height: 36px;
                background: linear-gradient(135deg, #9164fa, #9e54ff);
                border-radius: 50%;
                box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.5);
                z-index: -1;
            }
            
            #toggle-grid-btn i {
                font-size: 1.5rem;
                color: white;
                z-index: 2;
                transition: transform 0.3s ease;
            }
            
            #toggle-grid-btn.active i {
                transform: rotate(360deg);
            }
            
            #toggle-grid-btn:hover {
                transform: scale(1.1);
                box-shadow: 0 0 15px rgba(138, 43, 226, 0.5);
            }
            /* ===== DROPDOWNS & MODALS ===== */
        .dropdown-menu {
            background-color: #1e1e1e;
            border: 1px solid #333;
            right: 0 !important;
            width: 120px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            position: absolute;
        }

        .dropdown-item {
            color: #fff;
        }

        .dropdown-item:hover {
            background-color: #333;
            color: #ffffff;
        }
            
            /* ===== FONT FACE ===== */
            @font-face {
                font-family: 'Font Awesome';
                font-style: normal;
                font-weight: 400;
                font-display: swap;
                src: url(https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/webfonts/fa-solid-900.woff2) format('woff2');
            }
            
            /* ===== INPUT UNIT ===== */


            .input-unit {
                position: absolute;
                right: 12px;
                top: 50%;
                transform: translateY(-50%);
                color: #ffffff;
                pointer-events: none;
                font-size: 14px;
                z-index: 10;
            }
        /* Hide number input arrows (Chrome, Safari, Edge, Opera) */
        input[type=number]::-webkit-inner-spin-button,
    input[type=number]::-webkit-outer-spin-button {
        -webkit-appearance: none;
        margin: 0;
    }

    /* For Firefox */
    input[type=number] {
        -moz-appearance: textfield;
    }
        /* Make hr/min spans match seamlessly */
        .input-group .input-group-text {
            border: none;
            border-radius: 0;
            background-color: #121212;
            color: #bbb; /* slightly lighter text */
            font-size: 14px;
            padding: 6px 10px;
            height: 36px;
    }
            
            #grams {
                padding-right: 50px !important;
            }
            
            /* ===== EMPTY STATE ===== */
            .empty-state {
                border: none !important;
                background-color: transparent !important;
                color: #777 !important;
                font-style: italic;
                padding: 30px 0 !important;
                text-align: center;
            }
            
            /* ===== ADMIN MODE ===== */
            #admin-toggle {
                position: absolute;
                top: 15px;
                right: 15px;
                background-color: #ff0000;
                color: white;
                border: none;
                padding: 8px 15px;
                font-size: 16px;
                border-radius: 4px;
                z-index: 1000;
                box-shadow: 0 2px 8px rgba(255, 0, 0, 0.5);
                display: none;
            }
            
            .delete-food-btn {
                display: none;
                background-color: #ff0000;
                color: white;
                border: none;
                padding: 3px 8px;
                border-radius: 3px;
                margin-left: 10px;
                font-size: 12px;
                cursor: pointer;
            }
            
            .admin-active .delete-food-btn {
                display: inline-block;
            }
            
            /* ===== NAV LINK BOX ===== */
                    .nav-link-box {
                display: inline-block;
                background-color: #1b1b1b;
                color: #ffffff;
                border: 1px solid #444 !important;
                border-radius: 20px;
                padding: 0;
                margin: 0 3px;
                box-shadow: 0 2px 4px rgba(0,0,0,0.2);
                transition: all 0.3s ease;
                display: flex;
                align-items: center;
                justify-content: center;
                width: 35px;
                height: 35px;
                
            }

            .nav-link-box:hover {
                background-color: #f0f0f0 !important;
                transform: translateY(-2px);
                box-shadow: 0 4px 8px rgba(0,0,0,0.2);
                color: black !important;
            }

            .nav-link-box i {
                font-size: 14px !important;
                margin: 0 !important;
            }
            .nav-logo-box {
                display:inline-block;
                position: absolute;
                left: 50%;
                top: 50%;
                transform: translate(-50%, -50%);
                border-radius: 50px;
                padding: 2px;
                margin: 0 3px;
                display: flex;
                align-items: center;
                justify-content: center;
                width: 55px;
                height: 55px;
                z-index: 1050 !important;
                }
                    .nav-logo-box img.nav-logo {
                max-width: 100%;   /* scale the logo down */
                max-height: 100%;  /* maintain aspect ratio */
                object-fit: contain;
            }

            /* date selector */
            #date-selector:disabled {
    opacity: 0.7;
    cursor: wait;
}

#date-selector.loading {
    background-image: url("data:image/svg+xml,%3csvg width='16' height='16' viewBox='0 0 16 16' fill='none' xmlns='http://www.w3.org/2000/svg'%3e%3cpath d='m.5 8a7.5 7.5 0 0 1 7.5-7.5' stroke='%23fff' stroke-opacity='0.75' stroke-linecap='round' stroke-width='2'/%3e%3cpath d='m.5 8a7.5 7.5 0 0 1 7.5-7.5' stroke='%23fff' stroke-opacity='0.25' stroke-linecap='round' stroke-width='2' transform='rotate(90 8 8)'/%3e%3c/svg%3e");
    background-repeat: no-repeat;
    background-position: right 8px center;
    animation: spin 1s linear infinite;
}
            /* Tooltip container */
    .tooltip {
    opacity: 1 !important; /* prevent Bootstrap fade weirdness */
    }

    /* Tooltip bubble */
    .tooltip .tooltip-inner {
    background-color: #1b1b1b; /* match nav-link-box background */
    color: #fff;
    font-size: 0.75rem;
    font-weight: 500;
    padding: 6px 10px;
    border-radius: 10px; /* softer pill look */
    border: 1px solid #444;
    box-shadow: 0 2px 6px rgba(0,0,0,0.4);
    }

    /* Tooltip arrow */
    .tooltip.bs-tooltip-top .tooltip-arrow::before {
    border-top-color: #1b1b1b;
    }
    .tooltip.bs-tooltip-bottom .tooltip-arrow::before {
    border-bottom-color: #1b1b1b;
    }
    .tooltip.bs-tooltip-start .tooltip-arrow::before {
    border-left-color: #1b1b1b;
    }
    .tooltip.bs-tooltip-end .tooltip-arrow::before {
    border-right-color: #1b1b1b;
    }
            /* ===== MOBILE TAB BAR ===== */
            .mobile-tab-bar {
                position: fixed;
                bottom: 0;
                left: 0;
                right: 0;
                background: #000;
                z-index: 1000;
                padding: 10px 0;
                border-top: 1px solid #444;
                display: flex;
                justify-content: center;
                height: 45px;
            }
            
            .mobile-tab-btn {
                border: none;
                color: white;
                padding: 0;
                border-radius: 50%;
                font-size: 18px;
                width: 50px !important;
                height: 50px !important;
                display: flex;
                align-items: center;
                justify-content: center;
                transition: all 0.2s ease;
                box-shadow: 0 2px 4px rgba(0,0,0,0.3);
                position: absolute;
                bottom: 2px;
            }
            
            .mobile-tab-btn:nth-child(1) {
                left: calc(50% - 70px);
            }
            
            .mobile-tab-btn:nth-child(2) {
                left: 50%;
                margin-left: -25px;
            }
            
            .mobile-tab-btn:nth-child(3) {
                left: calc(50% + 55px);
                margin-left: -35px;
            }
            
            .mobile-tab-btn.active {
                box-shadow: 0 0 10px rgba(255,255,255,0.5);
                z-index: 2;
                border: 2px solid white;
                color: black;
                font-weight: bold;
            }
            
            .mobile-panel:not(.active) {
                display: none !important;
            }
            
            .mobile-panel.active {
                display: block;
            }
            
            /* ===== MOBILE SETTINGS ===== */
            .mobile-settings-btn {
                display: inline-block;
                background-color: #1b1b1b;
                color: rgb(255, 255, 255) !important;
                border-radius: 50%;
                padding: 10px !important;
                width: 35px;
                height: 35px;
                display: flex;
                align-items: center;
                justify-content: center;
                box-shadow: 0 2px 4px rgba(0,0,0,0.2);
                transition: all 0.3s ease;
                margin-left: 10px
                    }
            
                .mobile-settings-btn:hover {
                background-color: #f0f0f0 !important;
                transform: translateY(-4px);
                box-shadow: 0 4px 8px rgba(0,0,0,0.2);
                color: #000 !important;
            }

            .mobile-settings-btn i {
                font-size: 20px !important;
                margin: 0 !important;
            }
            /* ===== COMBINED CARD MOBILE ====*/
            
            .combined-card {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 15px;
            background: linear-gradient(135deg, #202020, #000000);
            color: white;
            border-radius: 12px;
            margin-bottom: 15px;
            gap: 15px;
            flex-wrap: wrap;
}

.card-section {
            display: flex;
            flex-direction: column;
            align-items: center;
            font-size: 12px;
            min-width: 60px;
}

.card-section i {
    font-size: 16px;
    margin-bottom: 4px;
    color: #ffb74d; /* optional accent color for icons */
}

.card-section .value {
    font-weight: bold;
    font-size: 14px;
}

.today-section {
            text-align: center;
            margin: 10px 0;
            flex: 1;

}
.today-value {
            font-size: 24px;
            font-weight: bold;
            color: var(--today-color);
            margin-bottom: 5px;
}
.status-text {
            font-size: 12px;
            padding: 3px 10px;
            border-radius: 10px;
            display: inline-block;
}

.today-section .value {
    font-size: 16px;
    font-weight: bold;
}

.today-section #mobile-status-text {
    font-size: 12px;
    margin-top: 2px;
    color: #000000; /* or dynamic based on status_class */
    font-weight: 600;
}
.combined-card .card-section i {
    color: #ffffff;
}
            /* ===== CAMERA SCANNER ===== */
            #camera-preview {
                width: 100%;
                max-height: 60vh;
                overflow: hidden;
                position: relative;
            }
            
            #camera-preview video {
                width: 100%;
                height: auto;
                transform-origin: center center;
            }
            
            #scanner-overlay {
                pointer-events: none;
                z-index: 10;
            }
            
            .scan-guide {
                position: absolute;
                top: 30%;
                left: 15%;
                width: 70%;
                height: 20%;
                border: 2px solid rgba(255, 255, 255, 0.8);
                border-radius: 8px;
                box-shadow: 0 0 0 100vmax rgba(0, 0, 0, 0.7);
            }
            
            .scan-line {
                position: absolute;
                top: 30%;
                width: 70%;
                left: 15%;
                height: 3px;
                background: #ff0000;
                animation: scan 2s infinite linear;
                box-shadow: 0 0 10px rgba(255, 0, 0, 0.8);
            }
            
            .scanning-text {
                position: absolute;
                top: 20%;
                left: 0;
                width: 100%;
                text-align: center;
                color: white;
                font-weight: bold;
                font-size: 16px;
                text-shadow: 0 1px 3px rgba(0,0,0,0.8);
            }
            
            .scanned-result {
                position: absolute;
                bottom: 25%;
                left: 0;
                width: 100%;
                text-align: center;
                color: white;
                font-weight: bold;
                font-size: 18px;
                text-shadow: 0 1px 3px rgba(0,0,0,0.8);
                background: rgba(0, 0, 0, 0.7);
                padding: 10px;
                z-index: 100;
            }
            
            #toggle-camera, #resume-scan {
                background: rgba(0, 0, 0, 0.7) !important;
                border: 1px solid white !important;
                padding: 8px 15px !important;
                font-size: 14px !important;
            }
            .mobile-settings-btn i {
        font-size: 20px !important;
    }
            /* ===== VERTICAL PROGRESS BAR STYLES ===== */
            .vertical-progress-container {
                display: flex;
                flex-direction: column;
                gap: 15px;
                margin-top: 20px;
                width: 100%;
            }

            .progress-item {
                display: flex;
                align-items: center;
                gap: 10px;
                padding: 8px 12px;
                background: rgba(30, 30, 30, 0.7);
                border-radius: 12px;
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
            }

            .progress-icon {
                width: 32px;
                height: 32px;
                display: flex;
                align-items: center;
                justify-content: center;
                border-radius: 50%;
                background: rgba(255, 255, 255, 0.1);
                flex-shrink: 0;
            }

            .progress-details {
                flex: 1;
                min-width: 0;
            }

            .progress-info {
                display: flex;
                justify-content: space-between;
                margin-bottom: 5px;
            }

            .progress-label {
                font-size: 12px;
                font-weight: bold;
                text-transform: uppercase;
                color: #e0e0e0;
            }

            .progress-values {
                font-size: 11px !important;
                color: #c3c3c3 !important;
                font-weight: 500;
            }

            .progress-bar-bg {
                position: relative;
                height: 7px;
                background-color: #333;
                border-radius: 10px;
                overflow: hidden;
                margin-top: 5px;
                height: 12px;
            }

            .progress-bar-fill {
                height: 100%;
                border-radius: 3px;
                    border-radius: 10px 0 0 10px;
             position: relative;
            }
                    .progress-bar-fill .percentage-text {
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            font-size: 11px;
            font-weight: 600;
            color: #fff;
            white-space: nowrap;
            color: #000000 !important;
        }
        
        .progress-proteins .progress-icon {
            background: linear-gradient(to right, #b989f0, #835fac); color:#000000; }
        .progress-carbs .progress-icon { background: linear-gradient(to right, #6dc0d5, #929292); color:#000000; }
        .progress-fats .progress-icon { background: linear-gradient(to right, #ff9e6d, #8f5639); color:#000000; }
        .progress-salt .progress-icon { background: linear-gradient(to right, #6dc0d5, #3f7481); color:#000000; }
        .progress-saturated .progress-icon { background: linear-gradient(to right, #ffd166, #b39347); color:#000000; }
        .progress-sugars .progress-icon { background: linear-gradient(to right, #7bc8a4, #4e8e71); color:#000000; }
        .progress-fiber .progress-icon { background: linear-gradient(to right, #ffbe9e, #b3846e); color:#000000; }

            /* Specific colors for each nutrient */
            .progress-proteins .progress-bar-fill { background: linear-gradient(to right, #b989f0, #835fac); }
            .progress-carbs .progress-bar-fill { background: linear-gradient(to right, #6dc0d5, #929292); }
            .progress-fats .progress-bar-fill { background: linear-gradient(to right, #ff9e6d, #8f5639); }
            .progress-salt .progress-bar-fill { background: linear-gradient(to right, #6dc0d5, #3f7481); }
            .progress-saturated .progress-bar-fill { background: linear-gradient(to right, #ffd166, #b39347); }
            .progress-sugars .progress-bar-fill { background: linear-gradient(to right, #7bc8a4, #4e8e71); }
            .progress-fiber .progress-bar-fill { background: linear-gradient(to right, #ffbe9e, #b3846e); }
            
            /* ===== MEDIA QUERIES ===== */
            @media (max-width: 1400px) {
                            .combined-card {
                flex-direction: row;
                justify-content: space-around;
            }
            
            .today-section {
                border-left: 1px solid #444;
                border-right: 1px solid #444;
                padding: 0 15px;
            }
                .container-main {
                display: auto;
                grid-template-columns: 1180px;
                grid-template-rows: 500px 740px;
                gap: 15;
                margin: 0 auto;
                width: 700px;
                position: relative;
            }
                .nutrition-grid-container {
                    left: calc(50% + 350px) !important;
                    transform: scale(0.9) !important;
                    width: 11vw !important;
                }
                
                .activity-grid-container {
                    position: fixed;
                    left: calc(50% - 390px - 7vw) !important;
                    transform: scale(0.85) !important;
                    width: 11vw !important;
                }
                
                .grid-cell {
                    font-size: 14px !important;
                }
                
                .grid-value {
                    font-size: 16px !important;
                }
            }
            
            @media (max-width: 1200px) {
                .container-main {
                display: auto;
                grid-template-columns: 1180px;
                grid-template-rows: 500px 740px;
                gap: 15;
                margin: 0 auto;
                width: 700px;
                position: relative;
            }
                .nutrition-grid-container {
                    left: calc(50% + 440px);
                    transform: scale(0.9);
                }
                
                .activity-grid-container {
                    left: calc(50% - 390px - 8vw);
                    transform: scale(0.9);
                }
            }
            
            @media (max-width: 1100px) {
                .container-main {
                display: auto;
                grid-template-columns: 1180px;
                grid-template-rows: 500px 740px;
                gap: 15;
                margin: 0 auto;
                width: 770px;
                position: relative;
            }
            .activity-grid-container {
                display: none;
            }
            .nutrition-grid-container {
                display: none;
            }
                
            }
            
            @media (max-height: 800px) {
                .grid-cell {
                    padding: 4px 1px !important;
                    min-height: 50px !important;
                }
                
                .grid-cell i {
                    font-size: 1.5vh !important;
                }
                
                .grid-value {
                    font-size: 1.3vh !important;
                }
            }
            
            @media (min-width: 992px) {
                .mobile-tab-bar {
                    display: none !important;
                }
                .mobile-panel {
                    display: flex !important;
                }
                .navbar-nav .nav-link {
                    font-size: 14px !important;
                }
                
                #nutrition-panel {
                    display: none !important;
                }
                
                .rtb-yay {
                    min-width: 24% !important;
                    height: 65px !important;
                    min-width: 95px !important; 
                }
                
                .rtb-value {
                    font-size: 20px !important;
                }
                
                .rtb-label {
                    font-size: 9px !important;
                }
                
                .icon-bg {
                    font-size: 32px !important;
                }
                .scan-ean-btn {
                    display: none !important;
                }
                .container-main {
                    grid-template-rows: 570px 670px !important;
                }
                #food-log-panel {
                    display: flex !important;
                }
                #add-food-panel {
                    display: flex !important;
                }
                #add-food {
            width: 50%;
        }
            }
            
            @media (max-width: 991px) {
                .combined-card {
                flex-direction: row;
                justify-content: space-around;
            }
            
            .today-section {
                border-left: 1px solid #444;
                border-right: 1px solid #444;
                padding: 0 15px;
            }
                body {
                    display: flex;
                    flex-direction: column;
                    height: 110vh;
                    padding-bottom: 0px;
                }
                
                html, body {
                    height: auto;
                    min-height: 100vh;
                    overflow: visible;
                }
                
                .container-main {
                    height: auto;
                    min-height: calc(100vh - 190px);
                    overflow: visible;
                    display: flex;
                    flex-direction: column;
                    height: calc(100% - 1px);
                    min-height: 0;
                    grid-template-columns: 1fr;
                    grid-template-rows: auto auto auto;
                    width: 100%;
                    max-width: 100%;
                    padding: 0;
                    gap: 10px;
                    padding-bottom: 80px;
                }
                
                .nutrition-grid-container, 
                .activity-grid-container {
                    display: none !important;
                }
                
                .food-group {
                    flex: none !important;
                }
                
                .mobile-tab-bar {
                    display: flex;
                    position: fixed;
                    bottom: 0;
                    left: 0;
                    right: 0;
                    background: #000000;
                    z-index: 1000;
                    padding: 10px;
                    justify-content: center;
                    align-items: center;
                    border-top: 1px solid #444;
                    flex-direction: row;
                }
                
                .mobile-tab-btn {
                    border: none;
                    color: white;
                    padding: 12px;
                    border-radius: 50%;
                    font-size: 20px;
                    width: 60px;
                    height: 60px;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    transition: all 0.3s ease;
                    box-shadow: 0 3px 6px rgba(0,0,0,0.3);
                }
                .list-group-item {
        padding-left: 0.1rem; /* or 0 for flush left */
        padding-right: 0.6rem;
    }
                .mobile-tab-btn i {
                    font-size: 28px;
                }
                
                .mobile-tab-btn.active {
                    transform: translateY(-10px);
                    box-shadow: 0 5px 15px rgba(0,0,0,0.4);
                }
                
                .mobile-tab-btn:not(.active):hover {
                    opacity: 0.9;
                    transform: scale(1.05);
                }
                
                .grid-panel {
                    flex: unset;
                    overflow: visible;
                }
                
                .grid-panel.active {
                    display: flex;
                    flex-direction: column;
                }
                
                .grid-panel.active .card {
                    flex: 1;
                    display: flex;
                    flex-direction: column;
                    height: auto;
                    min-height: 300px;
                }
                
                .card-body {
                    overflow: visible;
                }
                
                #rt-breakdown-container {
                    width: 100%;
                }
                
                .nutrition-values-container, .group-nutrition-container {
                    flex-wrap: wrap;
                    justify-content: flex-end;
                }
                
                .nutrition-value-xxs {
                    font-size: 8px !important;
                    min-width: 35px !important;
                    height: 14px !important;
                    padding: 2px 4px !important;
                    margin: 0 1px !important;
                }
                
                .group-title {
                    font-size: 12px !important;
                }
                
                .card-header h6 {
                    font-size: 18px !important;
                }
                
    
    .food-item-container {
        display: flex;
        flex-direction: row;
        align-items: center;
        justify-content: flex-start;
        min-width: 0; /* important for ellipsis inside flex */
        flex: 1 1 auto; /* allow to shrink */
        gap: 1px;
    }
    /* Food name with ellipsis */
    .food-name {
        flex: 1 1 auto;     /* take remaining space */
        min-width: 0;       /* required for text-overflow in flexbox */
    }  
    .food-name strong {
        display: block;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        font-size: 12px;
        line-height: 1.2;
        max-width: 99% !important;
    }
.food-name strong:hover {
    white-space: normal;
    text-overflow: unset;
    overflow: visible;
    z-index: 10;
    position: relative;
}
    .food-item-container > div {
        flex: 1 !important;
        overflow: hidden !important;
    }
    
    .edit-grams {
        flex-shrink: 0;
        font-size: 11px;
        padding: 2px 4px;
        height: 14px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: #ffffff;
        border-radius: 4px;
    }
    .edit-grams-btn {
        font-size: 11px !important;
        height: 11px !important;
        width: 11px !important;
    }
        .nutrition-values-container {
        flex-wrap: nowrap !important;
        display: block;
        align-items: center !important;
        justify-content: center !important;
        font-size: 14px !important;

    }   
    .nutrition-and-actions {
        flex-shrink: 0;
        display: flex;
        align-items: center;
    }
        

                #date-selector {
                    font-size: 12px !important;
                    height: 36px !important;
                    width: 160px;
                }
                
                
                #meal-group {
                    width: 100%;
                }
                

                
                .group-nutrition > div:not(.nutrition-calories),
                .nutrition-values-container > div:not(.nutrition-calories) {
                    display: none !important;
                }
                
                .group-header {
                    flex-wrap: nowrap !important;
                    padding: 6px 8px !important;
                }
                
                .group-title {
                    font-size: 12px !important;
                    max-width: 70%;
                    white-space: nowrap;
                    overflow: hidden;
                    text-overflow: ellipsis;
                    flex-grow: 1;
                    min-width: 0;
                }
                
                .group-nutrition-container {
                    flex-shrink: 0;
                    justify-content: flex-end !important;
                    margin-left: auto !important;
                    width: auto !important;
                    padding: 2px 5px;
                }
                
                .group-nutrition .nutrition-calories,
                .nutrition-values-container .nutrition-calories {
                    min-width: 65px !important;
                    font-size: 12px !important;
                    padding: 4px 4px 10px 4px !important;
                    line-height: 0.6;
                }
                
                #move-items span {
                    display: none;
                }
                
                
                #clear-search {
                    position: absolute;
                    right: 0px;
                    top: 50%;
                    transform: translateY(-50%);
                    z-index: 10;
                    height: 36px;
                    width: 36px;
                    padding: 0;
                    transition: background-color 0.2s ease, transform 0.2s ease;
                }
                
                #clear-search .fas {
                    font-size: 16px;
                }
                
  #search-results .food-item {
    flex-direction: row;
    align-items: center;
    justify-content: space-between;
    min-height: 44px; /* Minimum touch target size */
    padding: 8px 10px;
    gap: 8px;
  }
                
                
                #search-results .calorie-badge {
                    font-size: 13px !important;
                    padding: 3px 6px;
                    min-width: 90px;
                    align-items:flex-end !important;
                    display: block;
                    flex-direction:row !important;
                    text-align: end;
                }
                
                #search-results .list-group-item {
                    padding: 8px 10px;
                    font-family: 600;
                }
                
                
                .card-footer {
                    display: none !important;
                }
                
                #food-log-panel .card {
                    display: flex;
                    flex-direction: column;
                    min-height: auto;
                }
                
                #food-log-panel .card-body {
                    flex: 1;
                    display: flex;
                    flex-direction: column;
                    padding: 0;
                    overflow: hidden;
                }
                
                #food-log {
                    flex: 1;
                    overflow-y: auto;
                    padding: 10px;
                }
                
                .food-group {
                    margin-bottom: 0;
                }
                
                .group-items {
                    margin-bottom: 0;
                }
                
                .mobile-settings-dropdown .dropdown-menu {
                    position: absolute !important;
                    top: 100% !important;
                    right: 15px !important;
                    left: auto !important;
                    z-index: 1050;
                    transform: none !important;
                    margin-top: 0 !important;
                    font: 12px !important;
                }
                
                #add-food-panel .card-header h6 {
                    font-size: 18px !important;
                }
                #food-log-panel {
                    grid-column: unset;
                    grid-row: unset;
                }
                
                #food-search {
                    font-size: 14px !important;
                }
                
                #rt-breakdown-container .rtb-value {
                    font-size: 16px !important;
                }
                
                #rt-breakdown-container .rtb-label {
                    font-size: 7px !important;
                }
                
                #grams,
                #meal-group {
                    font-size: 13px !important;
                }
                
                #add-food {
                    font-size: 16px !important;
                    padding: 10px !important;
                }
                
                .portion-btn {
                    font-size: 12px !important;
                    padding: 6px 8px !important;
                }
                
                #add-food i,
                .portion-btn i,
                .calorie-badge i {
                    font-size: 14px !important;
                }
                
                .position-static {
                    position: static !important;
                }
                
                #save-template-btn, #apply-template-btn {
                    font-size: 12px;
                    padding: 6px 10px;
                    margin-left: 4px;
                }
                
                #save-template-btn span, #apply-template-btn span {
                    display: none;
                }
                
                #save-template-btn i, #apply-template-btn i {
                    margin-right: 0 !important;
                }
                
                #nutrition-panel {
                    display: block;
                }
                
                #toggle-grid-btn {
                    display: none;
                }
                
                .mobile-panel:not(#food-log-panel) .mobile-footer {
                    display: none !important;
                }
            }
            
            @media (max-width: 768px) {
                            .progress-item {
                    padding: 6px 10px;
                }
                
                .progress-icon {
                    width: 28px;
                    height: 28px;
                }
                
                .progress-label {
                    font-size: 11px;
                }
                
                .progress-values {
                    font-size: 10px;
                }
                .form-row {
                    flex-direction: column;
                }
                
                .form-col {
                    margin-bottom: 15px;
                }
                
                .nutrition-value-xxs.nutrition-calories {
                    background: transparent !important;
                    color: #ffffff !important;
                }
                
                .btn-custom {
                    flex-direction: column;
                    flex: 1;
                    font-size: 12px;
                    padding: 6px 4px;
                }
                
                .btn-custom i {
                    font-size: 10px;
                    margin-top: 2px;
                }
                
                .grid-cell-mobile {
                    padding: 14px 8px;
                    min-height: 90px;
                }
                
                .grid-cell-mobile div {
                    font-size: 14px;
                }
                
                .grid-cell-mobile .grid-value {
                    font-size: 20px;
                }
                
                #rt-breakdown-container .d-flex {
                    display: grid !important;
                    grid-template-columns: repeat(4, 1fr);
                    gap: 4px !important;
                    width: 100%;
                    padding: 0 !important;
                    margin: 0 !important;
                }
                
                .rtb-yay {
                    width: 100% !important;
                    min-width: unset !important;
                    max-width: unset !important;
                    height: 60px !important;
                    padding: 3px !important;
                    margin: 0 !important;
                    border-radius: 8px !important;
                    box-sizing: border-box;
                }
                
                .rtb-value {
                    font-size: 14px !important;
                    line-height: 1.1 !important;
                    padding-top: 0 !important;
                    margin-top: -2px !important;
                }
                
                .rtb-label {
                    font-size: 7px !important;
                    line-height: 1.1 !important;
                    margin-top: -2px !important;
                }
                
                .icon-bg {
                    font-size: 20px !important;
                    opacity: 0.7 !important;
                    margin-top: -5px !important;
                }

                /* Mobile footer container */
                .mobile-footer {
                background-color: #222; /* match dark theme */
                height: 42px;              /* fixed compact height */           /* tighter side padding */
                display: flex;
                border-radius: 15px;
                flex: 1 1;
                align-items: center;       /* vertically center buttons */
                position: relative;
                z-index: 1055;
                justify-content:space-evenly;
                }

                /* Footer buttons */
                .mobile-footer .btn {
                    background-color: #1b1b1b !important;
                    color: #ffffff !important;
                    border: 1px solid #444 !important;
                    border-radius: 10px;       /* slightly rounded */
                    padding: 1px;              /* super tight padding */
                    font-size: 11px;           /* compact labels */
                    font-weight: 600;
                    line-height: 1.1;
                    min-width: 0;
                    height: 27px; 
                    width: 82px;             /* fits inside footer */
                    flex: 1;                   /* all buttons equal width */
                    display: flex;
                    flex-direction: row;    /* icon above text */
                    align-items: center;
                    justify-content: center;     /* tiny gap between icon + text */
                    margin: 0 2px;             /* spacing between buttons */
                }

                /* Icons smaller */
                .mobile-footer .btn i {
                    font-size: 12px;
                    margin: 0;
                }

                /* Label text */
                .mobile-footer .btn .btn-label {
                    font-size: 9px;  /* small but readable */
                    font-weight: 500;
                }

                /* Disabled state */
                .mobile-footer .btn:disabled {
                    opacity: 0.4;
                    color: #aaa !important;
                    border-color: #333 !important;
                }
            }
            
            @media (max-width: 360px) {
                .rtb-yay {
                    height: 55px !important;
                }
                
                .rtb-value {
                    font-size: 12px !important;
                }
                
                .rtb-label {
                    font-size: 6px !important;
                }
                
                .icon-bg {
                    font-size: 18px !important;
                }
            }
            
            @media (max-width: 320px) {
                .rtb-yay {
                    height: 50px !important;
                }
                
                .rtb-value {
                    font-size: 11px !important;
                }
                
                .rtb-label {
                    font-size: 5.5px !important;
                }
                
                .icon-bg {
                    font-size: 16px !important;
                }
            }
            
            @media (max-height: 900px) {
                .nutrition-grid-container {
                    transform: scale(0.8);
                    height: 80vh;
                }
                
                .grid-cell {
                    padding: 8px 3px !important;
                }
                
                .grid-cell i {
                    font-size: 16px !important;
                }
                
                .grid-value {
                    font-size: 14px !important;
                }
            }
            
            @media (max-height: 768px) {
                .nutrition-grid-container {
                    transform: scale(0.75);
                    height: 75vh;
                }
                
                .grid-cell {
                    padding: 6px 2px !important;
                    font-size: 13px !important;
                }
                
                .grid-cell i {
                    font-size: 14px !important;
                }
                
                .grid-value {
                    font-size: 12px !important;
                }
            }
            
            /* ===== SPECIFIC OVERRIDES ===== */
            #add-food-panel .card,
            #food-log-panel .card {
                background: #252525 !important;
            }
            #food-log-panel {
                grid-column: 1;
                grid-row: 2;
                width: 100%;
                grid-column: unset;
                }
            
            #food-log {
                flex: 1;
                min-height: 0;
                overflow: auto;
                display: flex;
                flex-direction: column;
                overflow-anchor: none;
            }
            
            .card-footer .btn {
                background: none !important;
                color: white !important;
            }
            
            .buttons-container {
                position: relative;
                z-index: 1000;
            }
            
            #camera-video {
                z-index: 5;
                position: relative;
            }
            @media (max-width: 360px) {
    .navbar-brand.d-md-inline {
        display: none !important; /* Hide brand text completely */
    }
}
        </style>
    </head>
    <body>
        <!-- Admin toggle button -->
        <button id="admin-toggle" class="btn">ADMIN MODE</button>
        
    <nav class="navbar navbar-expand-lg navbar-dark bg-black">
            <div class="container">
                <div class="nav-logo-box">
                    <a href="/">
        <img src="static/images/trackyoulogo.png" alt="TrackYou Logo" class="nav-logo">
                </a>
    </div>
                <a class="navbar-brand d-md-inline" href="/" style="font-size: 13px; font-weight:600;">Track You</a>
                <a class="navbar-brand d-none d-md-inline" href="/" style="font-size: 12px;color: #ffffff; ">
                    - Track, eat, repeat -
                </a>
                <button class="btn-beta">BETA</button>
                <!-- Mobile Settings Dropdown (right-aligned) -->
                <div class="ms-auto d-block d-lg-none position-static d-flex align-items-center">
                    <button class="mobile-settings-btn" data-bs-toggle="dropdown" aria-expanded="false">
                        <i class="bi bi-wrench-adjustable"></i>
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end" 
                        aria-labelledby="navbarDropdownMobile"
                        style="position: absolute; background-color: #222; border: 1px solid #ffffff; border-radius: 5px; z-index: 1050; right: 15px; left: auto; font-size: 10;">
                        <li>
                            <a class="dropdown-item" 
                            href="/"
                            style="color: #e0e0e0; padding: 8px 15px;">
                                <i class="fa-solid fa-house-chimney-window me-2"></i><span data-i18n="home">Koti</span>
                            </a>
                        </li>
                            <li>
                            <a class="dropdown-item" 
                            href="{{ url_for('workout') }}"
                            style="color: #e0e0e0; padding: 8px 15px;">
                                <i class="fas fa-dumbbell me-2"></i><span data-i18n="workouts">Harjoitukset</span>
                            </a>
                            </li>
                            <li>
                                        <a class="dropdown-item" 
                            href="/history"
                            style="color: #e0e0e0; padding: 8px 15px;">
                                <i class="fas fa-chart-pie me-2"></i><span data-i18n="history">Historia</span>
                            </a>
                        </li>
                            <li>
                            <a class="dropdown-item" 
                            href="{{ url_for('activity') }}"
                            style="color: #e0e0e0; padding: 8px 15px;">
                                <i class="fas fa-fire me-2"></i><span data-i18n="activity">Aktiivisuus</span>
                            </a>
                        </li>
                                 <li>
                        <a class="dropdown-item" 
                        href="/custom_food"
                        style="color: #e0e0e0; padding: 8px 15px;">
                            <i class="fas fa-file-circle-plus me-2"></i><span data-i18n="add_food">Add Food</span>
                        </a>
                    </li>
                        <li>
                            <a class="dropdown-item" 
                            href="{{ url_for('profile') }}"
                            style="color: #e0e0e0; padding: 8px 15px; border-bottom: 1px solid #444;">
                                <i class="fas fa-user-circle me-2"></i><span data-i18n="profile">Profiili</span>
                            </a>
                        </li>
                        <li>
                            <a class="dropdown-item" 
                            href="{{ url_for('logout') }}"
                            style="color: #e0e0e0; padding: 8px 15px;">
                                <i class="fas fa-sign-out-alt me-2"></i><span data-i18n="logout">Kirjaudu Ulos</span>
                            </a>
                        </li>
                        
                    </ul>
                </div>
                
                <!-- Desktop Navigation -->
                <div class="collapse navbar-collapse" id="navbarNav">
                    <ul class="navbar-nav ms-auto">
                        <li class="nav-item">
                            <a class="nav-link home-link nav-link-box" href="/" 
                            data-bs-toggle="tooltip" data-bs-placement="bottom" title="Home" data-i18n="tooltip_home" >
                                <i class="fa-solid fa-house-chimney-window"></i>
                            </a>
                            <li class="nav-item">
        <a class="nav-link workout-link nav-link-box" href="{{ url_for('workout') }}"
        data-bs-toggle="tooltip" data-bs-placement="bottom" title="Workouts" data-i18n="tooltip_workouts">
            <i class="fa-solid fa-dumbbell"></i>
        </a>
    </li>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link add-link nav-link-box" href="/custom_food"
                            data-bs-toggle="tooltip" data-bs-placement="bottom" title="Add Food" data-i18n="tooltip_add_food">
                                <i class="fa-solid fa-file-circle-plus"></i>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link history-link nav-link-box" href="/history"
                            data-bs-toggle="tooltip" data-bs-placement="bottom" title="History" data-i18n="tooltip_history">
                                <i class="fa-solid fa-chart-pie"></i>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link nav-link-box" href="/activity"
                            data-bs-toggle="tooltip" data-bs-placement="bottom" title="Activity" data-i18n="tooltip_activity">
                                <i class="fas fa-fire"></i>
                            </a>
                        </li>
                        
                        {% if current_user.is_authenticated %}
                        <li class="nav-item dropdown">
                            <a class="nav-link dropdown-toggle nav-link-box" 
                            href="#" 
                            id="navbarDropdownDesktop" 
                            role="button" 
                            data-bs-toggle="dropdown" 
                            aria-expanded="false"
                            data-bs-toggle="tooltip" data-bs-placement="bottom" title="Settings" data-i18n="tooltip_settings"
                            style="position: relative;">
                                <i class="bi bi-wrench-adjustable"></i>
                            </a>
                            <ul class="dropdown-menu dropdown-menu-end" 
                                aria-labelledby="navbarDropdownDesktop"
                                style="background-color: #222; border: 1px solid #ffffff; border-radius: 5px;">
                                
                                <li>
                                    <a class="dropdown-item" 
                                    href="{{ url_for('profile') }}"
                                    style="color: #e0e0e0; padding: 8px 15px; border-bottom: 1px solid #444;">
                                        <i class="fas fa-user-circle me-2"></i><span data-i18n="profile">Profiili</span>
                                    </a>
                                </li>
                                <li>
                                    <a class="dropdown-item" 
                                    href="{{ url_for('logout') }}"
                                    style="color: #e0e0e0; padding: 8px 15px;">
                                        <i class="fas fa-sign-out-alt me-2"></i><span data-i18n="logout">Kirjaudu Ulos</span>
                                    </a>
                                </li>
                            </ul>
                        </li>
                        {% endif %}
                    </ul>
                </div>
            </div>
        </nav>

    <!-- Update mobile tab bar -->
    <div class="mobile-tab-bar d-block d-lg-none">
        <button class="mobile-tab-btn active" data-panel="add-food-panel" style="background-color: #ff9e6d;">
            <i class="fas fa-plus-circle"></i>
        </button>
        <button class="mobile-tab-btn" data-panel="food-log-panel" style="background-color: #6dc0d5;">
            <i class="fas fa-utensils"></i>
        </button>
        <button class="mobile-tab-btn" data-panel="nutrition-panel" style="background-color: #b989f0;">
            <i class="fas fa-chart-pie"></i>
        </button>
    </div>

        <div class="container-main">
            <!-- Activity Grid (Left side) -->
            <div class="activity-grid-container">
                <div class="activity-grid">
                    <div class="grid-cell grid-activity">
                        <i class="fas fa-running"></i>
                        <span data-i18n="activity">Aktiivisuus</span>
                        <div class="grid-value" id="tdee-value">{% if current_tdee %}
                                    {{ current_tdee|round(0) }} kcal
                                {% else %}
                                    Not calculated
                                {% endif %}</div>
                    </div>
                    <div class="grid-cell grid-today">
                        <i class="fas fa-balance-scale"></i>
                        <span data-i18n="today">Tänään</span>
                        <div class="calorie-diff" id="calorie-difference">{{ calorie_difference }}</div>
                        <div class="grid-status status-loss" id="calorie-status">{{ calorie_status }}</div>
                    </div>
                </div>
            </div>
            <!-- Top: Add Food (Full Width) -->
        <div class="grid-panel top-panel mobile-panel active" id="add-food-panel">
            <div class="card bg-dark h-100">
                <div class="card-header bg-black text-light">
                        <h6 data-i18n="add_food">Lisää Ruoka</h6>
                    </div>
                <div class="card-body">
                    <div class="input-group mb-3 position-relative">
        <input type="text" id="food-search" class="form-control bg-secondary text-light" placeholder="Search food..." data-i18n="search_food_placeholder">
        <div class="position-absolute" style="right: 50px; top: 50%; transform: translateY(-50%); z-index: 10;">
            <button id="scan-ean" class="btn p-1 scan-ean-btn" type="button" 
            style="background-color: #111111; height: 32px; width: 32px; display: flex; align-items: center; justify-content: center;">
        <i class="fa-solid fa-camera" style="color: #ffffff; font-size: 20px;"></i>
    </button>
        </div>
        <div class="position-absolute" style="right: 10px; top: 50%; transform: translateY(-50%); z-index: 10;">
            <button id="clear-search" class="btn p-1" type="button" style="height: 32px; width: 32px;">
                <i class="fas fa-times"></i>
            </button>
        </div>
    </div>
                        <div id="search-results" class="mt-3"></div>
                        <!-- UPDATED FOOD DETAILS SECTION -->
                    <div id="food-details" class="d-none mt-3">
                        <!-- Real-time breakdown -->
                        <div id="rt-breakdown-container" class="d-none">
    <div class="d-flex justify-content-center gap-1 mb-2 flex-wrap">
            <div class="rtb-yay" style="background: linear-gradient(to right, #ffffff, #ffffff, #636161);">
                <i class="fas fa-fire icon-bg"></i>
                <div class="rtb-text-container">
                    <span id="rt-calories" class="rtb-value">0 Cal</span>
                    <span class="rtb-label" data-i18n="calories">Kalorit</span>
                </div>
            </div>
        <div class="rtb-yay" style="background: linear-gradient(to right, #b989f0, #b989f0, #835fac);">
                <i class="fas fa-drumstick-bite icon-bg"></i>
                <div class="rtb-text-container">
                    <span id="rt-proteins" class="rtb-value">0g</span>
                    <span class="rtb-label" data-i18n="proteins">Proteiini</span>
                </div>
            </div>
            <div class="rtb-yay" style="background: linear-gradient(to right, #6dc0d5, #6dc0d5, #3f7481);">
                <i class="fas fa-bread-slice icon-bg"></i>
                <div class="rtb-text-container">
                    <span id="rt-carbs" class="rtb-value">0g</span>
                    <span class="rtb-label" data-i18n="carbs">Hiilari</span>
                </div>
            </div>
        <div class="rtb-yay" style="background: linear-gradient(to right, #ff9e6d, #ff9e6d, #8f5639);">
                <i class="fas fa-oil-can icon-bg"></i>
                <div class="rtb-text-container">
                    <span id="rt-fats" class="rtb-value">0g</span>
                    <span class="rtb-label" data-i18n="fats">Rasva</span>
                </div>
            </div>
    </div>
                
                            <div class="mt-3 text-center" style="font-size: 15px;">
                                <span>Per: </span>
                                <strong id="rt-grams" style="font-size: 15px;">0g</strong>
                            </div>
                        </div>

                        <!-- Portion buttons (centered) -->
                <div class="d-flex flex-wrap justify-content-center mb-3" id="portion-buttons">
                            <!-- Buttons will be added dynamically -->
                                </div>
                            

                        <!-- Grams and Meal Group in a row -->
                        <div class="row mb-3 g-2">
            <div class="col-7 position-relative">
                <input type="number" id="grams" class="form-control bg-secondary text-light" 
                    value="100" min="0.1" step="0.1" placeholder="Insert Yourself" data-i18n="insert_yourself">
                <span class="input-unit" data-i18n="grams">Grams</span>
                            </div>
                            <div class="col-5">
                                <select id="meal-group" class="form-select bg-secondary text-light">
                                    <option data-i18n="breakfast"value="breakfast">Aamiainen</option>
                                    <option data-i18n="lunch"value="lunch">Lounas</option>
                                    <option data-i18n="dinner"value="dinner">Päivällinen</option>
                                    <option data-i18n="snack"value="snack">Välipala</option>
                                    <option data-i18n="other"value="other">Muu</option>
                                </select>
                            </div>
                        </div>
                            
            <!-- Add Food Button -->
    <div class="d-grid">
                            <button id="add-food" class="btn w-100" 
                                    style="background-color: #c0bfbf; color: black; padding: 10px; font-size: 18px;">
                                    <i class="fa-solid fa-circle-plus"></i>
                                <span data-i18n="add_food">Lisää Ruoka</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
            
            <div class="grid-panel mobile-panel" id="food-log-panel">
                <div class="card bg-dark h-100 d-flex flex-column">
                    <div class="card-header bg-black text-light d-flex justify-content-between align-items-center">
                        <div class="d-flex align-items-center">
                            <h7 data-i18n="food_log">Ruokapäiväkirja</h7>
                            <!-- Toggle Grid Button -->
                            <button id="toggle-grid-btn" class="btn active ms-3 p-1">
                                <i class="bi bi-file-bar-graph"></i>
                            </button>
                        </div>
                        <div>
            <select id="date-selector" class="form-select bg-dark text-light border-secondary" style="font-size: 16px;">
                        {% for date_str, formatted in dates %}
                        <option value="{{ date_str }}" {% if date_str == current_date %}selected{% endif %}>{{ formatted }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
                    <div class="card-body p-0 d-flex flex-column">
                <div id="food-log" class="flex-grow-1">
                            {% if group_breakdown %}
                                {% for group, group_data in group_breakdown.items() %}
                                <div class="food-group {{ group }}" data-group="{{ group }}">
                                 <div class="group-header d-flex justify-content-between align-items-center">
                                        <div class="d-flex align-items-center">
                                            <div class="group-icon">
                                                {% if group == 'breakfast' %}
                                                    <i class="fas fa-sun"></i>
                                                {% elif group == 'lunch' %}
                                                    <i class="fas fa-utensils"></i>
                                                {% elif group == 'dinner' %}
                                                    <i class="fas fa-moon"></i>
                                                {% elif group == 'snack' %}
                                                    <i class="fas fa-apple-alt"></i>
                                                {% else %}
                                                    <i class="fas fa-question"></i>
                                                {% endif %}
                                            </div>
                                            <span class="group-title">{{ group | upper }}</span>
                                        </div>
                                        <div class="group-nutrition-container">
                                            <div class="group-nutrition">
                                                <div class="nutrition-value-xxs d-inline-block m-1 nutrition-calories">
                                                    <span>{{ group_data['calories']|round(1) }} kcal</span>
                                                </div>
                                                <div class="nutrition-value-xxs d-inline-block m-1">
                                                    <span>{{ group_data['proteins']|round(1) }}g P</span>
                                                </div>
                                                <div class="nutrition-value-xxs d-inline-block m-1">
                                                    <span>{{ group_data['carbs']|round(1) }}g C</span>
                                                </div>
                                                <div class="nutrition-value-xxs d-inline-block m-1">
                                                    <span>{{ group_data['fats']|round(1) }}g F</span>
                                                </div>
                                            </div>
                                            <button class="btn btn-sm toggle-group ms-1">+</button>
                                        </div>
                                    </div>
                                     <ul class="group-items list-group list-group-flush" style="display:none;">
                                               {% for item in group_data['items'] %}
                                        <li class="list-group-item bg-dark text-light d-flex justify-content-between align-items-center" data-id="{{ item.id }}" 
        data-key="{{ item.key }}">
                                            <div class="food-item-container">
                                                <div>
                                                    <div class="d-flex align-items-center">
                                                        <strong>{{ item.name }}</strong>
                                                    </div>
                                                </div>

                                            <div class="nutrition-and-actions">
                                                <div class="nutrition-values-container d-flex">
                                                    <div class="nutrition-value-xxs d-inline-block mx-1 nutrition-calories" style="background-color: #ffffff;color: black;">
                                                        <span>{{ item.calories|round(1) }} kcal</span>
                                                    </div>
                                                    <div class="nutrition-value-xxs d-inline-block mx-1" style="background-color: #b61336; color: black;">
                                                        <span>{{ item.proteins|round(1) }}g P</span>
                                                    </div>
                                                    <div class="nutrition-value-xxs d-inline-block mx-1" style="background-color: #b61336;color: black;">
                                                        <span>{{ item.carbs|round(1) }}g C</span>
                                                    </div>
                                                    <div class="nutrition-value-xxs d-inline-block mx-1" style="background-color: #b61336;color: black;">
                                                        <span>{{ item.fats|round(1) }}g F</span>
                                                    </div>
                                                </div>
                                                <button class="btn delete-item" data-id="${item.id}">
        <i class="fa-solid fa-circle-xmark"></i>
                                            </div>
                                        </li>
                                        {% endfor %}
                                    </ul>
                                </div>
                                {% endfor %}
                            {% else %}
                                <div class="empty-state" data-i18n="no_food_message">No food logged yet</div>
                            {% endif %}
                        </div>
                    </div>
                    
        <!-- Desktop Footer -->
                <div class="card-footer py-2 d-none d-lg-block">
                    <div class="d-flex justify-content-between gap-2 flex-wrap flex-md-nowrap">
                        <!-- Move button -->
                        <button id="move-items" class="btn-custom flex-fill text-center">
                            <i class="fa-solid fa-copy fa-lg"></i>
                            <span class="btn-label d-block d-md-inline" data-i18n="move">Move</span>
                        </button>

                        <!-- Save template -->
                        <button id="save-template-btn" class="btn-custom flex-fill text-center" disabled>
                            <i class="fas fa-save fa-lg"></i>
                            <span class="btn-label d-block d-md-inline" data-i18n="save">Save</span>
                        </button>

                        <!-- Apply template -->
                        <button id="apply-template-btn" class="btn-custom flex-fill text-center">
                            <i class="fas fa-layer-group fa-lg"></i>
                            <span class="btn-label d-block d-md-inline" data-i18n="apply">Apply</span>
                        </button>

                        <!-- Clear button -->
                        <button id="clear-session" class="btn-custom flex-fill text-center">
                            <i class="fas fa-trash fa-lg"></i>
                            <span class="btn-label d-block d-md-inline" data-i18n="clear">Clear</span>
                        </button>
                    </div>
                </div>
                
                <!-- Mobile Footer (now inside food log panel) -->
                <div class="d-lg-none mobile-footer p-2">
                    <div class="d-flex justify-content-between gap-2">
                        <!-- Move button -->
                        <button id="move-items-mobile" class="btn btn-dark flex-fill text-center">
                            <i class="fa-solid fa-copy"></i>
                            <span class="btn-label d-block" data-i18n="move">&nbsp;Move</span>
                        </button>

                        <!-- Save template -->
                        <button id="save-template-btn-mobile" class="btn btn-dark flex-fill text-center" disabled>
                            <i class="fas fa-save"></i>
                            <span class="btn-label d-block" data-i18n="save">&nbsp;Save</span>
                        </button>

                        <!-- Apply template -->
                        <button id="apply-template-btn-mobile" class="btn btn-dark flex-fill text-center">
                            <i class="fas fa-layer-group"></i>
                            <span class="btn-label d-block" data-i18n="apply">&nbsp;Apply</span>
                        </button>

                        <!-- Clear button -->
                        <button id="clear-session-mobile" class="btn btn-dark flex-fill text-center">
                            <i class="fas fa-trash"></i>
                            <span class="btn-label d-block" data-i18n="clear">&nbsp;Clear</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    <!-- Nutrition Panel (Mobile) -->
     <div class="grid-panel mobile-panel" id="nutrition-panel">
        <div class="combined-card">
            <div class="card-section">
                <i class="fas fa-running"></i>
                <div class="label" data-i18n="activity">Aktiivisuus</div>
                <div class="value" id="mobile-activity-value">
                    {% if current_tdee %}{{ current_tdee|round(0) }} kcal{% else %}Not calculated{% endif %}
                </div>
            </div>
            <div class="card-section today-section">
                <i class="fas fa-balance-scale"></i>
                <div class="label" data-i18n="today">Tänään</div>
                <div class="today-value" id="mobile-today-value">{{ calorie_difference }}</div>
                <div id="mobile-status-text" class="status-text {{ status_class }}">{{ calorie_status }}</div>
            </div>
            <div class="card-section">
                <i class="fas fa-fire"></i>
                <div class="label" data-i18n="calories">Kalorit</div>
                <div class="value" id="mobile-calories-value">{{ totals.calories | round(0) }} kcal</div>
            </div>
        </div>
                    
                    <!-- VERTICAL PROGRESS BARS SECTION -->
                    <div class="vertical-progress-container" id="nutrition-progress-bars">
                        <!-- Progress bars will be populated by JavaScript -->
                    </div>
                </div>
            </div>
        </div>
        
    <!-- Updated nutrition grid with all 9 metrics -->
    <div class="nutrition-grid-container">
        <div class="nutrition-grid" style="height: 100%;">
            <div class="grid-cell grid-header">
                <i class="fas fa-calculator"></i>
                <span data-i18n="totals">Yhteenveto</span>
            </div>
            <div class="grid-cell grid-calories">
                <i class="fas fa-fire"></i>
                <span data-i18n="calories">Kalorit</span>
                <div class="grid-value" id="grid-calories">{{ totals.calories | round(1) }}</div>
            </div>
            <div class="grid-cell grid-proteins">
                <i class="fas fa-drumstick-bite"></i>
                <span data-i18n="proteins">Proteiini</span>
                <div class="grid-value" id="grid-proteins">{{ totals.proteins | round(1) }}g</div>
            </div>
            <div class="grid-cell grid-carbs">
                <i class="fas fa-bread-slice"></i>
                <span data-i18n="carbs">Hiilari</span>
                <div class="grid-value" id="grid-carbs">{{ totals.carbs | round(1) }}g</div>
            </div>
            <div class="grid-cell grid-fats">
                <i class="fas fa-oil-can"></i>
                <span data-i18n="fats">Rasva</span>
                <div class="grid-value" id="grid-fats">{{ totals.fats | round(1) }}g</div>
            </div>
            <div class="grid-cell grid-saturated">
                <i class="fas fa-bacon"></i>
                <span data-i18n="saturated">Tyydyttynyt</span>
                <div class="grid-value" id="grid-saturated">{{ totals.saturated | round(1) }}g</div>
            </div>
            <div class="grid-cell grid-sugars">
                <i class="fas fa-candy-cane"></i>
                <span data-i18n="sugars">Sokeri</span>
                <div class="grid-value" id="grid-sugars">{{ totals.sugars | round(1) }}g</div>
            </div>
            <div class="grid-cell grid-fiber">
                <i class="fas fa-apple-alt"></i>
                <span data-i18n="fiber">Kuitu</span>
                <div class="grid-value" id="grid-fiber">{{ totals.fiber | round(1) }}g</div>
            </div>
            <div class="grid-cell grid-salt">
                <i class="fas fa-mortar-pestle"></i>
                <span data-i18n="salt">Suola</span>
                <div class="grid-value" id="grid-salt">{{ totals.salt | round(1) }}g</div>
            </div>
        </div>
    </div>
        
        <!-- Edit Grams Modal -->
        <div class="modal fade" id="editGramsModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content bg-dark">
                    <div class="modal-header bg-black py-1">
                        <h5 class="modal-title">Edit Grams</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <label class="form-label">Grams</label>
                            <input type="number" id="edit-grams-input" class="form-control bg-secondary text-light" min="0" step="0.1">
                        </div>
                        <input type="hidden" id="edit-grams-id">
                    </div>
                    <div class="modal-footer bg-black py-1">
    <button type="button" class="btn modal-btn" data-bs-dismiss="modal">Cancel</button>
    <button type="button" id="save-grams" class="btn modal-btn">Save</button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Move Items Modal -->
    <div class="modal fade" id="moveItemsModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content bg-dark">
                <div class="modal-header bg-black py-1">
                    <h5 class="modal-title" data-i18n="move_or_copy_items">Move or Copy Items</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label" data-i18n="select_date">Select Date</label>
                        <select id="target-date" class="form-select bg-secondary text-light">
                            {% for date_str, formatted in dates %}
                                <option value="{{ date_str }}" {% if date_str == current_date %}selected{% endif %}>{{ formatted }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label" data-i18n="select_meal_group">Select Meal Group</label>
                        <select id="target-group" class="form-select bg-secondary text-light">
                            <option data-i18n="breakfast" value="breakfast">Aamiainen</option>
                            <option data-i18n="lunch" value="lunch">Lounas</option>
                            <option data-i18n="dinner" value="dinner">Päivällinen</option>
                            <option data-i18n="snack" value="snack">Välipala</option>
                            <option data-i18n="other" value="other">Muu</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label" data-i18n="action">Action</label>
                        <div class="btn-group w-100" role="group">
                            <button type="button" id="action-move" class="btn btn-secondary" data-i18n="move">Move</button>
                            <button type="button" id="action-copy" class="btn btn-light" data-i18n="copy">Copy</button>
                        </div>
                    </div>
                </div>
                <div class="modal-footer bg-black py-1">
                    <button type="button" class="btn modal-btn" data-bs-dismiss="modal" data-i18n="cancel">Cancel</button>
    <button type="button" id="confirm-action" class="btn modal-btn" data-i18n="confirm">Confirm</button>
                </div>
            </div>
        </div>
    </div>
        
        <!-- Recipe Modal -->
        <div class="modal fade" id="recipeModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content bg-dark">
                    <div class="modal-header bg-black py-1">
                        <h5 class="modal-title">Create Recipe</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div id="recipe-confirm">
                            <p>Do you wish to create a new recipe from the selected items?</p>
                        </div>
                        <div id="recipe-name-input" class="d-none">
                            <div class="mb-3">
                                <label class="form-label">Recipe Name</label>
                                <input type="text" id="recipe-name" class="form-control bg-secondary text-light" placeholder="Enter recipe name">
                            </div>
                        </div>
                    </div>
    <!-- <div class="modal-footer bg-black py-1">
        <button type="button" class="btn modal-btn" data-bs-dismiss="modal">Cancel</button>
        <button type="button" id="recipe-yes" class="btn modal-btn">Yes</button>
        <button type="button" id="recipe-save" class="btn modal-btn d-none">Save Recipe</button>
    </div> -->
                </div>
            </div>
        </div>
        
        <!-- Camera Modal -->
    <div class="modal fade" id="cameraModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg"> <!-- Added modal-dialog -->
            <div class="modal-content bg-dark"> <!-- Added modal-content -->
                <div class="modal-header bg-black">
                    <h5 class="modal-title" data-i18n="scan_barcode">Scan Barcode</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body d-flex flex-column align-items-center justify-content-center">
                    <!-- Camera status indicator -->
                    <div id="camera-status" class="text-center mb-2" 
                        style="color: white; z-index: 1000; position: relative;"></div>
                    
                    <!-- Camera preview container -->
                    <div id="camera-preview" class="position-relative" style="width: 100%;">
                        <video id="camera-video" style="width:100%; height:auto;"></video>
                        <!-- Scanner overlay -->
                        <div id="scanner-overlay" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%;">
                            <div class="scanning-text"><span data-i18n="position_barcode_in_the_scan_area">Laita viivakoodi skannaus alueelle</span></div>
                            <div class="scan-guide"></div>
                            <div class="scan-line"></div>
                            <div id="scanned-result" class="scanned-result"></div>
                        </div>
                    </div>
                    
                    <!-- Buttons container -->
                    <div class="mt-3 text-center d-flex flex-wrap justify-content-center" 
                        style="z-index: 1000; position: relative; width: 100%;">
                        <button id="toggle-camera" class="btn btn-sm me-2" style="background: #333; color: white;">
                            <i class="fas fa-sync-alt"></i><span data-i18n="Vaihda kamera">vaihda kamera</span>
                        </button>
                        <button id="resume-scan" class="btn btn-sm" style="background: #333; color: white;">
                            <i class="fas fa-redo"></i><span data-i18n="Jatka skannausta">Jatka skannausta</span>
                        </button>
                    </div>
                </div>
                <div class="modal-footer bg-black">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" data-i18n="close">Close</button>
                </div>
            </div>
        </div>
    </div>
    <div class="modal fade" id="saveTemplateModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content bg-dark">
                <div class="modal-header bg-black py-1">
                    <h5 class="modal-title" data-i18n="save_food_template">Save Food Template</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label" data-i18n="template_name">Template Name</label>
                        <input type="text" id="template-name" class="form-control bg-secondary text-light" data-i18n="enter_template_name" placeholder="Enter template name">
                    </div>
                </div>
                <div class="modal-footer bg-black py-1">
                    <button type="button" class="btn modal-btn" data-bs-dismiss="modal" data-i18n="cancel">Cancel</button>
                    <button type="button" id="confirm-save-template" class="btn modal-btn" data-i18n="save">Save</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="applyTemplateModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content bg-dark">
                <div class="modal-header bg-black py-1">
                    <h5 class="modal-title" data-i18n="apply_food_template">Apply Food Template</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label" data-i18n="select_template">Select Template</label>
                        <select id="template-select" class="form-select bg-secondary text-light">
                            <!-- Templates will be loaded here -->
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label" data-i18n="select_meal_group">Select Meal Group</label>
                        <select id="template-meal-group" class="form-select bg-secondary text-light">
                            <option value="breakfast" data-i18n="breakfast">Breakfast</option>
                            <option value="lunch" data-i18n="lunch">Lunch</option>
                            <option value="dinner" data-i18n="dinner">Dinner</option>
                            <option value="snack" data-i18n="snack">Snack</option>
                            <option value="other" data-i18n="other">Other</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer bg-black py-1">
                    <button type="button" class="btn modal-btn" data-bs-dismiss="modal" data-i18n="cancel">Cancel</button>
                    <button type="button" id="confirm-apply-template" class="btn modal-btn" data-i18n="confirm">Confirm</button>
                </div>
            </div>
        </div>
    </div>    
        <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
        <script>
    // CSRF TOKEN //
    $.ajaxSetup({
        beforeSend: function(xhr, settings) {
            let token = $('meta[name="csrf-token"]').attr('content');
            if (token) {
                xhr.setRequestHeader("X-CSRFToken", token);
            }
        }
    });
    const csrfToken = $('meta[name="csrf-token"]').attr('content');
    function initializeIcons() {
        if (window.FontAwesome) {
            FontAwesome.dom.i2svg();
        }
    }

    // Font Awesome watcher (from the separate script)
    document.addEventListener('DOMContentLoaded', function() {
        if (window.FontAwesome) {
            FontAwesome.dom.watch();
        }
    });
    </script>
    <script>

            $(document).ready(function() {
                // ===== CONSTANTS AND CONFIGURATION =====
                const DATES = {{ dates | tojson }};
                const CURRENT_DATE = "{{ current_date }}";
                const SAVE_TEMPLATE_URL = "{{ url_for('save_template_food') }}";
                const APPLY_TEMPLATE_URL = "{{ url_for('apply_template_food') }}";
                const ADMIN_KEY_COMBO = ['i', 'd', 'd', 'q', 'd'];
                
                // ===== STATE VARIABLES =====
                let isLoadingDates = false;
                let currentDates = DATES;
                let currentSelectedDate = CURRENT_DATE;
                let codeReader = null;
                let currentFood = null;
                let selectedItems = [];
                let selectedItemsForRecipe = [];
                let gridVisible = true;
                let isAdminMode = false;
                let keySequence = [];
                let currentCamera = localStorage.getItem('cameraPreference') || 'user';
                let scanningActive = false;
                let lastScannedCode = null;
                let collapseAllGroups = false;
                let currentSearchRequest = null;
                let searchTimeout = null;
                
                // ===== MODAL INSTANCES =====
                const editGramsModal = new bootstrap.Modal(document.getElementById('editGramsModal'));
                const moveItemsModal = new bootstrap.Modal(document.getElementById('moveItemsModal'));
                const recipeModal = new bootstrap.Modal(document.getElementById('recipeModal'));
                const cameraModal = new bootstrap.Modal(document.getElementById('cameraModal'));
                const collapseStates = loadCollapseStates();
                const LS_KEY = 'collapseStates';
                
                // ===== INITIALIZATION =====
                function initializeApp() {
                    initGramsInputReset();
                    updateCalorieDifference();
                    updateTemplateButtonState();
                    loadTopFoods();
                    positionNutritionGrid();
                    initPortionControls();

                    
                    // If we have a current food, update portion buttons
                    if (currentFood) {
                        updatePortionButtons(currentFood, favouriteGrams);
                    }
                    
                    // Also update when language is changed
                function changeLanguage(lang) {
                localStorage.setItem("lang", lang);
                currentLang = lang;
                applyTranslations();
                
                // Refresh portion buttons if we have a current food
                if (typeof currentFood !== 'undefined' && currentFood) {
                    updatePortionButtons(currentFood, favouriteGrams);
                }
                
                // Update progress bars if visible
                if ($('#nutrition-panel').hasClass('active')) {
                    updateNutritionProgressBars();
                }
            }


                                        // Mobile button linking
                    $('#move-items-mobile').click(() => $('#move-items').click());
                    $('#apply-template-btn-mobile').click(() => $('#apply-template-btn').click());
                    $('#clear-session-mobile').click(() => $('#clear-session').click());

                    $(document).on('click', '#save-template-btn-mobile', function() {
                if (selectedItems.length === 0) {
                            alert('Please select at least one food item to save as template');
                            return;
                        }
                        showSaveTemplateModal();
                    });
                    $(document).on('click', '#apply-template-btn-mobile', showApplyTemplateModal);        
                    // Initial grid state
                    $('#toggle-grid-btn').addClass('active');
                    updateGridVisibility();
                }
                    // Update when nutrition data changes
                $(document).on('sessionUpdated', function() {
                    updateNutritionProgressBars();
                });

                // Initial update
                $(document).ready(function() {
                    setTimeout(updateNutritionProgressBars, 1000);
                });
                        // ===== EVENT HANDLERS =====
                $('#date-selector').val(currentSelectedDate);
                initializeApp();
                setTimeout(() => {
            $('#date-selector').trigger('change');
                }   , 100);

                // Admin mode
                $(document).keydown(handleAdminKeyCombo);
                $('#admin-toggle').click(toggleAdminMode);
                
                // Grid toggle
                $('#toggle-grid-btn').click(toggleGridVisibility);
                
                // Food search
                $('#food-search').on('input', function() {
                    clearTimeout(searchTimeout);
                    searchTimeout = setTimeout(() => {
                        handleFoodSearch.call(this);
                    }, 300); // 300ms delay
                });
                $('#clear-search').click(clearSearch);            
                
                // Portion controls
                $(document).on('click', '.portion-btn', handlePortionClick);
                $('#grams').on('input', handleGramsInput);
                
                // Add food
                $('#add-food').click(addFoodToLog);
                $('#grams').on('keypress', handleGramsEnterKey);
                // Food groups
                $(document).on('click', '.toggle-group', toggleFoodGroup);
                $(document).on('dblclick', '.group-header', toggleFoodGroup);
                
                // Edit grams
                $(document).on('click', '.edit-grams', handleEditGrams);
                
                // Delete items
                $(document).on('click', '.delete-food-btn', handleAdminFoodDelete);
                $(document).on('click', '.delete-item', handleFoodItemDelete);
                
                // Session management
                $('#clear-session').click(clearSession);
                $('#date-selector').on('change', handleDateSelectorChange);
                
                // Item selection
                $(document).on('click', '.group-items .list-group-item', handleItemSelection);
                updateTemplateButtonState();
                
                // Move/copy functionality
                $('#move-items').click(showMoveItemsModal);
                $('#action-move, #action-copy').click(handleActionSelection);
                $('#confirm-action').click(confirmMoveCopyAction);
                
                // Recipe functionality
                $('#create-recipe').click(showRecipeModal);
                $('#recipe-yes').click(showRecipeNameInput);
                $('#recipe-save').click(saveRecipe);
                
                // Templates
                $('#save-template-btn').click(showSaveTemplateModal);
                $('#confirm-save-template').click(saveTemplate);
                $('#apply-template-btn').click(showApplyTemplateModal);
                $('#confirm-apply-template').click(applyTemplate);
                
                // Camera functionality
                $('#scan-ean').click(showCameraModal);
                $('#toggle-camera').click(toggleCamera);
                $('#resume-scan').click(resumeScanning);
                $('#cameraModal').on('show.bs.modal', prepareCameraModal);
                $('#cameraModal').on('shown.bs.modal', initializeCamera);
                $('#cameraModal').on('hidden.bs.modal', stopCamera);
                
                // Mobile navigation
                $('.mobile-tab-btn').click(handleMobileTabSwitch);
                
                // Window events
                $(window).resize(handleWindowResize);
                
                // ===== HELPER FUNCTIONS =====
                // Enhanced change handler that pre-loads dates
                function handleSmartDateChange() {
                    const selector = $('#date-selector');
                    const selectedIndex = selector.prop('selectedIndex');
                    const totalOptions = selector.find('option').length;
                    
                    // Pre-load more dates when user gets close to edges (within 2 positions)
                    if (selectedIndex <= 2 && !isLoadingDates) {
                        loadMoreDates('past');
                    } else if (selectedIndex >= totalOptions - 3 && !isLoadingDates) {
                        loadMoreDates('future');  
                    }
                    
                    // Handle the actual date change
                    handleDateChange.call(this);
                }
                function handleDateSelectorChange() {
                const selector = $('#date-selector');
                const selectedIndex = selector.prop('selectedIndex');
                const totalOptions = selector.find('option').length;
                
                // Check if user selected first option (need to load past dates)
                if (selectedIndex === 0 && !isLoadingDates) {
                    loadMoreDates('past');
                }
                // Check if user selected last option (need to load future dates)  
                else if (selectedIndex === totalOptions - 1 && !isLoadingDates) {
                    loadMoreDates('future');
                }
                
                // Handle the actual date change
                handleDateChange.call(this);
            }

            // New function to load more dates
            function loadMoreDates(direction) {
                if (isLoadingDates) return;
                
                isLoadingDates = true;
                const selector = $('#date-selector');
                const currentSelectedValue = selector.val();
                
                // Show loading indicator
                selector.prop('disabled', true);
                
                // Get current dates from the selector
                const currentDatesArray = [];
                selector.find('option').each(function() {
                    const value = $(this).val();
                    const text = $(this).text();
                    currentDatesArray.push([value, text]);
                });
                
                $.ajax({
                    url: '/load_more_dates',
                    method: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({
                        direction: direction,
                        current_dates: currentDatesArray
                    }),
                    success: function(response) {
                        if (response.success && response.new_dates) {
                            updateDateSelector(response.new_dates, response.position, currentSelectedValue);
                            currentDates = getCurrentDatesFromSelector(); // Update our state
                        }
                    },
                    error: function(xhr, status, error) {
                        console.error('Failed to load more dates:', error);
                        console.error('Response:', xhr.responseText);
                    },
                    complete: function() {
                        isLoadingDates = false;
                        selector.prop('disabled', false);
                    }
                });
            }

            //  Function to update the date selector with new dates
           function updateDateSelector(newDates, position, selectedValue) {
    const selector = $('#date-selector');
    
    if (position === 'prepend') {
        newDates.forEach(dateInfo => {
            const option = $('<option></option>')
                .attr('value', dateInfo[0])  // Use dateInfo[0] for value
                .text(dateInfo[1]);         // Use dateInfo[1] for text
            selector.prepend(option);
        });
    } else if (position === 'append') {
        newDates.forEach(dateInfo => {
            const option = $('<option></option>')
                .attr('value', dateInfo[0])  // Use dateInfo[0] for value  
                .text(dateInfo[1]);         // Use dateInfo[1] for text
            selector.append(option);
        });
    }
    
    selector.val(selectedValue);
}

            // Helper function to get current dates from selector
               function getCurrentDatesFromSelector() {
    const dates = [];
    $('#date-selector option').each(function() {
        const $option = $(this);
        dates.push([$option.val(), $option.text()]);  // Separate val() and text()
    });
    return dates;
}
                            
                function handleWindowResize() {
                    positionNutritionGrid();
                    updateGridFontSizes();
                    adjustGridScale();
                    
                    if (currentFood) {
                        updateRealTimeBreakdownFromForm();
                    }
                }
                    function updateNutritionTotalsOnly(totals) {
                // Update nutrition grids without full DOM refresh
                    updateNutritionGrid(totals);
                    updateMobileNutrition(totals);
                    updateCalorieDifference();
                    updateNutritionProgressBars();
                    applyTranslations();
                    updateNutritionAbbreviations();
                    

                    
                    // Trigger session updated event for other components
                    $(document).trigger('sessionUpdated');
                }
           function updateItemInDOM(itemData) {
    const itemElement = $(`.list-group-item[data-id="${itemData.id}"]`);
    if (itemElement.length) {
        // Update grams display
        itemElement.find('.edit-grams, .edit-grams-btn')
            .text(`${parseFloat(itemData.grams).toFixed(1)}${t("grams")}`);

        // Update nutrition values
        itemElement.find('.nutrition-calories span')
            .text(`${itemData.calories.toFixed(1)} ${t("kcal")}`);
        itemElement.find('.nutrition-value-xxs:contains("P") span, .nutrition-value-xxs:contains("p") span')
            .text(`${itemData.proteins.toFixed(1)}${t("grams")} ${t("p")}`);
        itemElement.find('.nutrition-value-xxs:contains("C") span, .nutrition-value-xxs:contains("HH") span')
            .text(`${itemData.carbs.toFixed(1)}${t("grams")} ${t("c")}`);
        itemElement.find('.nutrition-value-xxs:contains("F") span, .nutrition-value-xxs:contains("R") span')
            .text(`${itemData.fats.toFixed(1)}${t("grams")} ${t("f")}`);
    }
}


function removeItemFromDOM(itemId) {
    const itemElement = $(`.list-group-item[data-id="${itemId}"]`);
    const groupElement = itemElement.closest('.food-group');
    const groupName = groupElement.data('group');
    
    // Animate removal
    itemElement.fadeOut(300, function() {
        $(this).remove();
        
        // Check if group is now empty
        const remainingItems = groupElement.find('.list-group-item:not(.empty-state)').length;
        if (remainingItems === 0) {
            // Hide empty group after delay
            setTimeout(() => {
                hideEmptyGroups();
            }, 100);
        }
    });
}

function updateGroupTotals(groupName, groupData) {
    const groupElement = $(`.food-group[data-group="${groupName}"]`);
    if (groupElement.length) {
        const groupNutrition = groupElement.find('.group-nutrition');
        groupNutrition.find('.nutrition-calories span')
            .text(`${groupData.calories.toFixed(1)} ${t("kcal")}`);
        groupNutrition.find('.nutrition-value-xxs:contains("P") span, .nutrition-value-xxs:contains("p") span')
            .text(`${groupData.proteins.toFixed(1)}${t("grams")} ${t("p")}`);
        groupNutrition.find('.nutrition-value-xxs:contains("C") span, .nutrition-value-xxs:contains("HH") span')
            .text(`${groupData.carbs.toFixed(1)}${t("grams")} ${t("c")}`);
        groupNutrition.find('.nutrition-value-xxs:contains("F") span, .nutrition-value-xxs:contains("R") span')
            .text(`${groupData.fats.toFixed(1)}${t("grams")} ${t("f")}`);
    }
}


function calculateItemNutrition(foodData, grams) {
    // Calculate nutrition for a specific amount
    const factor = grams / 100;
    return {
        calories: foodData.calories * factor,
        proteins: foodData.proteins * factor,
        carbs: foodData.carbs * factor,
        fats: foodData.fats * factor,
        saturated: foodData.saturated * factor,
        fiber: foodData.fiber * factor,
        sugars: foodData.sugars * factor,
        salt: foodData.salt * factor
    };
}

function recalculateGroupTotalsFromDOM(groupName) {
  const groupElement = $(`.food-group[data-group="${groupName}"]`);
  let totals = { calories: 0, proteins: 0, carbs: 0, fats: 0 };

  groupElement.find('.list-group-item').each(function() {
    if (!$(this).hasClass('empty-state')) {
      const calories = parseFloat(
        $(this).find('.nutrition-calories span').text()
          .replace(` ${t("kcal")}`, '')
      ) || 0;
      const proteins = parseFloat(
        $(this).find('.nutrition-value-xxs:contains("P") span').text()
          .replace(`${t("grams")} ${t("P")}`, '')
      ) || 0;
      const carbs = parseFloat(
        $(this).find('.nutrition-value-xxs:contains("C") span').text()
          .replace(`${t("grams")} ${t("C")}`, '')
      ) || 0;
      const fats = parseFloat(
        $(this).find('.nutrition-value-xxs:contains("F") span').text()
          .replace(`${t("grams")} ${t("F")}`, '')
      ) || 0;

      totals.calories += calories;
      totals.proteins += proteins;
      totals.carbs += carbs;
      totals.fats += fats;
    }
  });

  updateGroupTotals(groupName, totals);
  return totals;
}


function recalculateAllTotalsFromDOM() {
    // Recalculate all totals from DOM
    let grandTotals = { 
        calories: 0, proteins: 0, carbs: 0, fats: 0,
        saturated: 0, fiber: 0, sugars: 0, salt: 0
    };
    
    $('.food-group').each(function() {
        const groupName = $(this).data('group');
        const groupTotals = recalculateGroupTotalsFromDOM(groupName);
        
        grandTotals.calories += groupTotals.calories;
        grandTotals.proteins += groupTotals.proteins;
        grandTotals.carbs += groupTotals.carbs;
        grandTotals.fats += groupTotals.fats;
    });
    
    // For other nutrients, we'd need to sum from individual items
    // This is a simplified version focusing on main macros
    
    return grandTotals;
}     
function addNewFoodToGroup(groupName, newItem, groupTotals) {
    let groupElement = $(`.food-group[data-group="${groupName}"]`);
    
    // If group doesn't exist, create it
    if (groupElement.length === 0) {
        groupElement = createGroupElement(groupName, groupTotals);
        
        // Insert group in correct order (breakfast, lunch, dinner, snack, other)
        const groupOrder = ['breakfast', 'lunch', 'dinner', 'snack', 'other'];
        const targetIndex = groupOrder.indexOf(groupName);
        let inserted = false;
        
        $('.food-group').each(function() {
            const existingGroup = $(this).data('group');
            const existingIndex = groupOrder.indexOf(existingGroup);
            
            if (targetIndex < existingIndex) {
                $(this).before(groupElement);
                inserted = true;
                return false; // break loop
            }
        });
        
        if (!inserted) {
            $('#food-log .empty-state').remove();
            $('#food-log').append(groupElement);
        }
    }
    
    const groupItemsList = groupElement.find('.group-items');
    
    // Remove empty state if present
    groupItemsList.find('.empty-state').remove();
    
    // Add new item with animation
    const itemHtml = createItemHtml(newItem);
    const $newItem = $(itemHtml);
    $newItem.hide().appendTo(groupItemsList).fadeIn(300);
    
    // Update group totals
    updateGroupTotals(groupName, groupTotals);
    
    // Expand the target group to show the new item
    expandTargetGroup(groupName);
    
    return $newItem;
}

function expandTargetGroup(groupName) {
    const groupElement = $(`.food-group[data-group="${groupName}"]`);
    const groupItems = groupElement.find('.group-items');
    
    if (!groupItems.is(':visible')) {
        groupItems.slideDown(300);
        groupElement.find('.toggle-group').text('−');
        groupElement.removeClass('collapsed-group');
        
        // Update collapse state in localStorage
        const collapseStates = loadCollapseStates();
        collapseStates[groupName] = false;
        localStorage.setItem('mealGroupCollapseStates', JSON.stringify(collapseStates));
    }
}

function hideEmptyGroups() {
  $('.food-group').each(function() {
    const $group = $(this);
    const $items = $group.find('.list-group-item:not(.empty-state)');

    if ($items.length === 0) {
      $group.fadeOut(300, function() {
        $(this).remove();
        $('.empty-state').remove();
        if ($('.food-group').length === 0) {
          $('#food-log').html(`<div class="empty-state">${t("no_food_message")}</div>`);
        }
      });
    }
  });
}
                function addEmptyState() {
                $('#food-log').html(`<div class="empty-state">${t("no_food_message")}</div>`);
            }
                function toggleAdminMode() {
                    isAdminMode = !isAdminMode;
                    $('#admin-toggle').toggle(isAdminMode);
                    $('body').toggleClass('admin-active', isAdminMode);
                    $('.delete-food-btn').toggle(isAdminMode);
                    
                    alert(`Admin mode ${isAdminMode ? 'ENABLED' : 'DISABLED'}`);
                }
    
                $('#saveTemplateModal').on('show.bs.modal', function() {
        setTimeout(debugTemplateItems, 500);
    });
                function handleAdminKeyCombo(e) {
                    keySequence.push(e.key);
                    if (keySequence.length > ADMIN_KEY_COMBO.length) {
                        keySequence.shift();
                    }
                    
                    if (keySequence.join('') === ADMIN_KEY_COMBO.join('')) {
                        toggleAdminMode();
                        keySequence = [];
                    }
                }
                
                function toggleGridVisibility() {
                    gridVisible = !gridVisible;
                    updateGridVisibility();
                    $(this).toggleClass('active', gridVisible);
                }
                
                function updateGridVisibility() {
                    gridVisible ? $('.nutrition-grid-container').show() : $('.nutrition-grid-container').hide();
                }
                
                function handleFoodSearch() {
                const query = $(this).val().trim();
                
                if (query.length === 0) {
                    loadTopFoods();
                    return;
                }
                
                // Cancel previous request if it's still pending
                if (currentSearchRequest) {
                    currentSearchRequest.abort();
                }
                
                // Show loading indicator
                $('#search-results').html('<div class="text-center p-2 small">Searching...</div>');
                
                // Make the AJAX request and store the reference
                currentSearchRequest = $.post('/search_foods', { query }, data => {
                    let resultsHtml = '';
                    const seenIds = new Set(); // Track unique IDs to prevent duplicates
                    
                    if (data && data.length > 0) {
                        resultsHtml = '<div class="list-group">';
                        
                        // Filter out duplicates by food ID
                        data.forEach(food => {
                            if (!seenIds.has(food.id)) {
                                seenIds.add(food.id);
                                resultsHtml += createFoodItemHtml(food);
                            }
                        });
                        
                        resultsHtml += '</div>';
                        
                        if (seenIds.size === 0) {
                            resultsHtml = '<div class="text-center p-2 small">No results found</div>';
                        }
                    } else {
                        resultsHtml = '<div class="text-center p-2 small">No results found</div>';
                    }
                    
                    $('#search-results').html(resultsHtml);
                }).fail(function(xhr, status) {
                    if (status !== 'abort') {
                        $('#search-results').html('<div class="text-center p-2 small">Search failed. Please try again.</div>');
                    }
                }).always(function() {
                    currentSearchRequest = null;
                });
}
                
                function clearSearch() {
                    $('#food-search').val('');
                    loadTopFoods();
                    $('#food-details').addClass('d-none');
                    currentFood = null;
                    $('#rt-breakdown-container').addClass('d-none');
                }
                
               $(document).on('click', '.food-item', async function() {
    const foodId = $(this).data('id');

    // Build food object directly from data attributes
    const food = {
        serving_size: $(this).data('serving'),
        half_size: $(this).data('half'),
        entire_size: $(this).data('entire'),
        bigserving_size: $(this).data('bigserving')
    };

    // Get favourite grams from backend
    const favouriteGrams = await getFavouriteGrams(foodId);

    // Update portion buttons with both food + favourite
    updatePortionButtons(food, favouriteGrams);

    // Update search input + clear results
    $('#food-search').val($(this).find('.food-name').text().trim());
    $('#search-results').empty();

    // Fetch actual food data from server
    $.post('/get_food_details', { food_id: foodId }, function(foodData) {
        if (foodData && foodData.success) {
            // Store current food with actual nutrition data
            currentFood = {
                id: foodId,
                serving_size: food.serving_size,   // ✅ use food object
                half_size: food.half_size,
                entire_size: food.entire_size,
                bigserving_size: food.bigserving_size,
                calories: parseFloat(foodData.calories) || 0,
                proteins: parseFloat(foodData.proteins) || 0,
                carbs: parseFloat(foodData.carbs) || 0,
                fats: parseFloat(foodData.fats) || 0,
                saturated: parseFloat(foodData.saturated) || 0,
                fiber: parseFloat(foodData.fiber) || 0,
                sugars: parseFloat(foodData.sugars) || 0,
                salt: parseFloat(foodData.salt) || 0
            };
            
            $('#food-details').removeClass('d-none');
            $('#grams').val(""); // Default to 100g
            $('#add-food').data('id', foodId);
            
            updatePortionButtons(currentFood, favouriteGrams); // ✅ pass favourite too
            $('#rt-breakdown-container').removeClass('d-none');
            updateRealTimeBreakdownFromForm();
            
            setTimeout(function() {
                $('#grams').trigger('focus').trigger('select');
            }, 100);
        } else {
            alert('Error loading food details');
        }
    }).fail(function() {
        alert('Failed to fetch food details');
    });
});

                
function handlePortionClick(e) {
    e.stopPropagation();
    
    // Reset all OTHER buttons except this one
    $('.portion-btn').not(this).each(function() {
        const baseSize = parseFloat($(this).data('portion-size'));
        const portionType = $(this).data('portion-type');
        const label = t(portionType); // Use translation function
        $(this).text(`${label} (${baseSize}${t("grams")})`);
        $(this).data('multiple', 0);
        $(this).removeClass('active');
    });

    let multiple = parseInt($(this).data('multiple')) || 0;
    const baseSize = parseFloat($(this).data('portion-size'));
    const portionType = $(this).data('portion-type');
    const label = t(portionType); // Use translation function

    // Increment multiple (first click = 1)
    multiple++;

    const totalGrams = baseSize * multiple;

    $(this).text(`${multiple} ${label} (${totalGrams}${t("grams")})`);
    $(this).data('multiple', multiple);

    // Update grams input WITHOUT focusing it
    const $gramsInput = $('#grams');
    $gramsInput.val(totalGrams);

    // Temporary highlight to show value changed
    $gramsInput.addClass('highlight-temp');
    setTimeout(() => $gramsInput.removeClass('highlight-temp'), 500);

    updateRealTimeBreakdownFromForm();
    $(this).addClass('active');
}

                
                function handleGramsInput() {
                    resetPortionButtons();
                    updateRealTimeBreakdownFromForm();
                }
                
// Modified addFoodToLog function
function addFoodToLog() {
    const foodId = $(this).data('id');
    const grams = parseFloat($('#grams').val()) || 0;
    const mealGroup = $('#meal-group').val();
    
    if (!foodId || grams <= 0) {
        alert('Please select a food and enter a valid amount');
        return;
    }
    
    // Show loading state
    const $button = $(this);
    const originalText = $button.html();
    $button.prop('disabled', true).html(`<i class="fas fa-spinner fa-spin"></i> ${t('adding')}`);
    
    $.post('/log_food', {
        food_id: foodId,
        unit_type: 'grams',
        units: grams,
        meal_group: mealGroup,
        date: currentSelectedDate
    }, response => {
        // Instead of full session refresh, just add the new item
        if (response.new_item && response.breakdown) {
            // Update totals first
            updateNutritionTotalsOnly(response.totals);
            
            // Add new item to specific group
            const newItem = response.new_item;
            const groupData = response.breakdown[mealGroup];
            
            addNewFoodToGroup(mealGroup, newItem, groupData);
            
            // Update calorie difference
            updateCalorieDifference();
            applyTranslations();
            updateNutritionAbbreviations();
            
            // Reset form
            resetFoodForm();
            
            // Switch to food log on mobile
            if (response.is_mobile) {
                $('.mobile-tab-btn[data-panel="food-log-panel"]').click();
            }
        } else {
            // Fallback to full refresh if needed
            updateSessionDisplay(response.session, response.totals, response.breakdown);
            updateCalorieDifference();
            resetFoodForm();
            applyTranslations();
            updateNutritionAbbreviations();
        }
    }).fail(error => {
        console.error('Error adding food:', error);
        alert('Failed to add food. Please try again.');
    }).always(() => {
        $button.prop('disabled', false).html(originalText);
    });
}
                
                function handleGramsEnterKey(e) {
                if (e.which === 13) { // Enter key
                    e.preventDefault(); // Prevent default form submission or next field focus
                    $('#add-food').click();
                    }
                }
                
                            function toggleFoodGroup(e) {
                    // Prevent double-click from triggering two click events
                    if (e.type === 'dblclick') {
                        e.stopPropagation();
                        e.preventDefault();
                    }
                    
                    const groupHeader = $(this).closest('.group-header');
                    const groupContainer = groupHeader.closest('.food-group');
                    const groupItems = groupHeader.next('.group-items');
                    const isExpanded = groupItems.is(':visible');
                    
                    if (isExpanded) {
                        groupItems.slideUp(1);
                        groupContainer.find('.toggle-group').text('+');
                        groupContainer.addClass('collapsed-group');
                    } else {
                        groupItems.slideDown(1);
                        groupContainer.find('.toggle-group').text('−');
                        groupContainer.removeClass('collapsed-group');
                    }
                    saveCollapseStates();
                }
                
                function handleEditGrams(e) {
    e.stopPropagation();
    
    const $button = $(this);
    const originalGrams = $button.text().replace('g', '').trim();
    const id = $button.data('id');
    const key = $button.data('key');

    // Create styled input (mimics button)
    const $input = $(`
        <input type="number" 
            class="edit-grams-input" 
            value="${originalGrams}" 
            min="0.1" step="0.1">
    `);

    // Replace button with input
    $button.replaceWith($input);
    $input.focus().select();

    // Handle save action
    function saveValue(newVal) {
        const date = $('#date-selector').val();
        if (!newVal || isNaN(newVal) || parseFloat(newVal) < 1) {
            newVal = 1;
        }

        // Recreate button with both data-id and data-key
        const $newButton = $(`
            <span class="edit-grams badge edit-grams-btn mx-1" 
                data-id="${id}" 
                data-key="${key}">
                ${parseFloat(newVal).toFixed(1)}g
            </span>
        `);
        $input.replaceWith($newButton);
        $newButton.blur();

        if (parseFloat(newVal) === 0) {
            // Delete item - use optimized delete
            optimizedDeleteItem(id, date);
        } else {
            // Update grams - use optimized update
            optimizedUpdateGrams(id, key, newVal, date, $newButton);
        }
    }

    // Save value on blur or Enter
    $input.on('blur', () => saveValue($input.val()));
    $input.on('keypress', e => {
        if (e.key === 'Enter') {
            saveValue($input.val());
        }
    });
}

function optimizedUpdateGrams(itemId, foodKey, newGrams, date, buttonElement) {
    $.post('/update_grams', {
        item_id: itemId,
        food_key: foodKey,
        new_grams: newGrams,
        date: date
    }, response => {
        // Instead of full refresh, just update the specific item and totals
        if (response.totals) {
            console.log("Updated totals:", response.totals);
            updateNutritionTotalsOnly(response.totals);
        }
        
        // Update the specific item in DOM if we have the item data
        const itemElement = buttonElement.closest('.list-group-item');
        const groupElement = itemElement.closest('.food-group');
        const groupName = groupElement.data('group');
        
        // Get updated item data from response
        if (response.breakdown && response.breakdown[groupName]) {
            const updatedItem = response.breakdown[groupName].items.find(item => item.id === itemId);
            if (updatedItem) {
                updateItemInDOM(updatedItem);
                updateGroupTotals(groupName, response.breakdown[groupName]);
            }
        }
    }).fail(() => {
        alert('Failed to update grams. Please try again.');
        // Revert button on failure
        buttonElement.text(originalGrams + 'g');
    });
}

                
                function handleAdminFoodDelete(e) {
                    e.stopPropagation();
                    const foodId = $(this).data('id');
                    
                    if (!confirm('Are you sure you want to permanently delete this food from the database?')) {
                        return;
                    }
                    
                    // Show processing indicator
                    const button = $(this);
                    const originalHTML = button.html();
                    button.html('<div class="spinner-delete"></div>');
                    
                    // Send delete request
                    $.post('/delete_food', { 
                        food_id: foodId 
                    }, response => {
                        if (response.success) {
                            // Remove the food item from search results
                            $(`a.food-item[data-id="${foodId}"]`).remove();
                            
                            // If we're viewing the food details, reset the form
                            if (currentFood && currentFood.id === foodId) {
                                resetFoodForm();
                            }
                        } else {
                            alert('Error: ' + (response.error || 'Failed to delete food'));
                        }
                    }).fail(() => {
                        alert('Failed to delete food. Please try again.');
                    }).always(() => {
                        button.html(originalHTML);
                    });
                }
                
               function handleFoodItemDelete(e) {
    e.stopPropagation();
    const button = $(this);
    const itemId = button.data('id');
    const date = $('#date-selector').val();
    
    // Store original content and get group info before deletion
    const originalHTML = button.html();
    const itemElement = button.closest('.list-group-item');
    const groupElement = itemElement.closest('.food-group');
    const groupName = groupElement.data('group');
    
    // Show spinner and disable button
    button.prop('disabled', true);
    button.html('<div class="spinner-delete"></div>');
    
    optimizedDeleteItem(itemId, date, itemElement, groupName);
}

function optimizedDeleteItem(itemId, date, itemElement = null, groupName = null) {
    // If elements not provided, find them
    if (!itemElement) {
        itemElement = $(`.list-group-item[data-id="${itemId}"]`);
        groupName = itemElement.closest('.food-group').data('group');
    }
    
    $.post('/delete_item', {
        item_id: itemId,
        date: date
    }, response => {
        // Update totals only
        if (response.totals) {
            updateNutritionTotalsOnly(response.totals);
        }
        
        // Remove item from DOM
        removeItemFromDOM(itemId);
        
        // Update group totals if we have breakdown data
        if (response.breakdown && response.breakdown[groupName]) {
            updateGroupTotals(groupName, response.breakdown[groupName]);
        } else {
            // Fallback: recalculate from DOM
            setTimeout(() => {
                recalculateGroupTotalsFromDOM(groupName);
            }, 350); // After fade out animation
        }
        
    }).fail(() => {
        // Revert button on failure
        const button = itemElement.find('.delete-item');
        button.html('<i class="fa-solid fa-circle-xmark"></i>');
        button.prop('disabled', false);
        alert('Failed to delete item. Please try again.');
    });
}
                
    let isClearingSession = false;

function clearSession() {
    if (isClearingSession) return; // already running

    if (!confirm(t("confirm_clear_session"))) return;

    isClearingSession = true;
    const $btn = $('#clear-session');
    $btn.prop('disabled', true); // optional: disable while running

    $.post('/clear_session', { date: currentSelectedDate }, response => {
        updateSessionDisplay(response.session, response.totals, response.breakdown);
        updateCalorieDifference();
        applyTranslations();
        updateNutritionAbbreviations();
    }).always(() => {
        isClearingSession = false;
        $btn.prop('disabled', false); // re-enable after done
    });
}
                
                function handleDateChange() {
                const date = $(this).val();
                currentSelectedDate = date; // Update the global date variable
                console.log("Date changed to:", date);
                    // Reset collapse states for the new date
                const collapseStates = {
                    breakfast: true,
                    lunch: true,
                    dinner: true,
                    snack: true,
                    other: true
                };
    localStorage.setItem(`mealGroupCollapseStates_${currentSelectedDate}`, JSON.stringify(collapseStates));
                    $.post('/update_session', { date })
                        .done(response => {
                            console.log("Date change response:", response);
                            if (response.session && response.totals && response.breakdown) {
                                updateSessionDisplay(response.session, response.totals, response.breakdown);
                                updateCalorieDifference();
                                applyTranslations();
                                updateNutritionAbbreviations();
                                if (response.current_date_formatted) {
                                    $('.card-header h6:contains("Food Log")').text(`Food Log (${response.current_date_formatted})`);
                                }
                            } else {
                                console.error("Invalid response format from server");
                            }
                        })
                        .fail((xhr, status, error) => {
                            console.error('Date change failed:', error);
                            alert('Failed to change date. Please try again.');
                        });
                }
                
            function handleItemSelection(e) {
                if ($(e.target).is('button') || $(e.target).is('.edit-grams')) {
                    return;
                }
                
                const itemId = $(this).data('id');
                const isSelected = $(this).hasClass('selected');
                
                if (isSelected) {
                    $(this).removeClass('selected');
                    selectedItems = selectedItems.filter(id => id !== itemId);
                } else {
                    $(this).addClass('selected');
                    selectedItems.push(itemId);
                }
                
                // Enable/disable buttons based on selection
                $('#move-items, #move-items-mobile').prop('disabled', selectedItems.length === 0);
                
                // Show recipe button if at least 2 items selected
                $('#create-recipe').toggleClass('d-none', selectedItems.length < 2);
                $('#create-recipe').prop('disabled', selectedItems.length < 2);
                updateTemplateButtonState();
            }
                
                function showMoveItemsModal() {
                    $('#moveItemsModal').modal('show');
                }
                
                function handleActionSelection() {
                    selectedAction = $(this).attr('id') === 'action-move' ? 'move' : 'copy';
                    
                    if (selectedAction === 'move') {
                        $('#action-move').addClass('active').addClass('btn-danger').removeClass('btn-outline-danger');
                        $('#action-copy').removeClass('active').removeClass('btn-success').addClass('btn-outline-success');
                    } else {
                        $('#action-copy').addClass('active').addClass('btn-success').removeClass('btn-outline-success');
                        $('#action-move').removeClass('active').removeClass('btn-danger').addClass('btn-outline-danger');
                    }
                }
                      function confirmMoveCopyAction() {
    const targetDate = $('#target-date').val();
    const targetGroup = $('#target-group').val();
    const currentDate = currentSelectedDate;

    // Store current collapse states before any DOM changes
    const beforeCollapseStates = {};
    $('.food-group').each(function() {
        const groupName = $(this).data('group');
        beforeCollapseStates[groupName] = $(this).hasClass('collapsed-group');
    });

    // Show loading state
    const confirmBtn = $('#confirm-action');
    const originalText = confirmBtn.html();
    confirmBtn.html(`<span class="spinner-border spinner-border-sm" role="status"></span> ${t('processing')}`);

    // Keep a copy of selectedItems for removal
    const itemsToRemove = [...selectedItems];

    $.post('/' + selectedAction + '_items', {
        date: currentDate,
        item_ids: JSON.stringify(selectedItems),
        new_group: targetGroup,
        target_date: targetDate
    }, response => {
        if (response.success) {
            // Update nutrition totals
            updateNutritionTotalsOnly(response.totals);
            updateNutritionProgressBars();
            updateCalorieDifference();

            if ($('#nutrition-panel').hasClass('active')) {
                updateMobileNutrition(response.totals);
            }

            // Handle DOM updates
            if (response.same_date_operation) {
                handleSameDateMoveCopy(response, targetGroup, beforeCollapseStates, itemsToRemove);
            } else {
                if (targetDate === currentSelectedDate) {
                    handleDifferentDateMoveCopy(response, targetGroup);
                } else {
                    // Different date → remove from current view if moving
                    if (response.action === 'move') {
                        removeMovedItems(response, itemsToRemove);
                    }
                    showToast('Operaatio onnistui! tuotteet siirretty ' + targetDate, 'success');
                }
            }

            // Clear selection state AFTER removing items
            selectedItems = [];
            $('#move-items, #move-items-mobile').prop('disabled', true);
            $('#create-recipe').addClass('d-none').prop('disabled', true);
            $('#moveItemsModal').modal('hide');

            // Apply translations and update abbreviations
            applyTranslations();
            updateNutritionAbbreviations();
        } else {
            alert('Error: ' + (response.error || 'Operation failed'));
        }
    }).fail(function(xhr, status, error) {
        console.error('Move/Copy error:', error);
        alert('Siirto ei onnistunut. Yritä uudelleen!');
    }).always(() => {
        confirmBtn.html(originalText);
    });
}

// Updated helper: accepts items array to remove
function removeMovedItems(response, items) {
    items.forEach(itemId => {
        const $item = $(`.list-group-item[data-id="${itemId}"]`);
        const $group = $item.closest('.food-group'); // Get parent group

        $item.addClass('removing-item');
        $item.fadeOut(300, function() {
            $(this).remove();

            // Update source group totals
            const sourceGroup = $group.data('group');
            if (response.breakdown[sourceGroup]) {
                updateGroupTotals(sourceGroup, response.breakdown[sourceGroup]);
            }

            // If the group has no more items, remove or hide the header
            if ($group.find('.list-group-item').length === 0) {
                $group.fadeOut(200, function() {
                    $(this).remove(); // or $(this).hide(); if you prefer just hiding
                });
            }
        });
    });
}

function handleSameDateMoveCopy(response, targetGroup, beforeCollapseStates, items) {
    // Remove moved items
    if (response.action === 'move') {
        removeMovedItems(response, items);
    }

    // Add items to target group with animation
    if (response.transferred_items && response.transferred_items.length > 0) {
        addItemsToGroupWithAnimation(targetGroup, response.transferred_items, response.breakdown[targetGroup]);
    }

    // Update all group totals
    for (const group in response.breakdown) {
        updateGroupTotals(group, response.breakdown[group]);
    }

    // Restore collapse states
    setTimeout(() => {
        restoreCollapseStates(beforeCollapseStates);
        saveCollapseStates();
    }, 500);
}

function handleDifferentDateMoveCopy(response, targetGroup) {
    // We're viewing the target date, so update the UI
    updateSessionDisplay(response.session, response.totals, response.breakdown);
    updateCalorieDifference();

    // Highlight the target group
    const $targetGroup = $(`.food-group[data-group="${targetGroup}"]`);
    if ($targetGroup.length) {
        $targetGroup.addClass('group-highlight');
        setTimeout(() => {
            $targetGroup.removeClass('group-highlight');
        }, 1000);
    }
}



    function addItemsToGroupWithAnimation(groupName, newItems, groupData) {
    let groupElement = $(`.food-group[data-group="${groupName}"]`);
    
    // If group doesn't exist, create it
    if (groupElement.length === 0) {
        groupElement = createGroupElement(groupName, groupData);
        insertGroupInCorrectOrder(groupElement, groupName);
    }
    
    const groupItemsList = groupElement.find('.group-items');
    
    // Remove empty state if present
    groupItemsList.find('.empty-state').remove();
    
    // Add new items directly without animation
    newItems.forEach(item => {
        const itemHtml = createItemHtml(item);
        $(itemHtml).appendTo(groupItemsList);
    });
    
    // Update group totals
    updateGroupTotals(groupName, groupData);
    
    // Ensure target group is expanded to show new items
    expandTargetGroupSmooth(groupName);
    
    // Remove global empty state if present
    $('.empty-state').remove();
}
    

function createItemHtmlFromData(item) {
    // Create item HTML using server-provided data (more reliable than DOM extraction)
    return `
        <li class="list-group-item bg-dark text-light d-flex justify-content-between align-items-center" 
            data-id="${item.id}" data-key="${item.key}">
            
            <div class="food-item-container">
                <span class="edit-grams badge edit-grams-btn mx-1"
                    data-id="${item.id}" 
                    data-key="${item.key}">
                    ${item.grams.toFixed(1)}${t("grams")}
                </span>
                <div class="food-name">
                    <strong>${item.name}</strong>
                </div>
            </div>

            <div class="nutrition-and-actions d-flex align-items-center">
                <div class="nutrition-values-container d-flex">
                    <div class="nutrition-value-xxs d-inline-block mx-1 nutrition-calories" style="background-color: #ffffff;color: black;">
                        <span>${item.calories.toFixed(1)} ${t("kcal")}</span>
                    </div>
                    <div class="nutrition-value-xxs d-inline-block mx-1" style="background-color: #b61336; color: black;">
                        <span>${item.proteins.toFixed(1)}${t("grams")} ${t("p")}</span>
                    </div>
                    <div class="nutrition-value-xxs d-inline-block mx-1" style="background-color: #b61336;color: black;">
                        <span>${item.carbs.toFixed(1)}${t("grams")} ${t("c")}</span>
                    </div>
                    <div class="nutrition-value-xxs d-inline-block mx-1" style="background-color: #b61336;color: black;">
                        <span>${item.fats.toFixed(1)}${t("grams")} ${t("f")}</span>
                    </div>
                </div>
                <button class="btn delete-item ms-2" data-id="${item.id}">
                    <i class="fa-solid fa-circle-xmark"></i>
                </button>
            </div>
        </li>
    `;
}

function insertGroupInCorrectOrder(groupElement, groupName) {
    const groupOrder = ['breakfast', 'lunch', 'dinner', 'snack', 'other'];
    const targetIndex = groupOrder.indexOf(groupName);
    let inserted = false;
    
    $('.food-group').each(function() {
        const existingGroup = $(this).data('group');
        const existingIndex = groupOrder.indexOf(existingGroup);
        
        if (targetIndex < existingIndex) {
            $(this).before(groupElement);
            inserted = true;
            return false;
        }
    });
    
    if (!inserted) {
        $('#food-log .empty-state').remove();
        $('#food-log').append(groupElement);
    }
    
    // Add entrance animation to the new group
    groupElement.hide().fadeIn(400);
}

function expandTargetGroupSmooth(groupName) {
    const groupElement = $(`.food-group[data-group="${groupName}"]`);
    const groupItems = groupElement.find('.group-items');
    const toggleButton = groupElement.find('.toggle-group');
    
    if (!groupItems.is(':visible')) {
        groupItems.slideDown(250);
        toggleButton.text('−');
        groupElement.removeClass('collapsed-group');
        
        // Update localStorage
        const collapseStates = loadCollapseStates();
        collapseStates[groupName] = false;
        localStorage.setItem('mealGroupCollapseStates', JSON.stringify(collapseStates));
    }
}

function restoreCollapseStates(collapseStates) {
    Object.keys(collapseStates).forEach(groupName => {
        const groupElement = $(`.food-group[data-group="${groupName}"]`);
        if (!groupElement.length) return;
        
        const groupItems = groupElement.find('.group-items');
        const toggleButton = groupElement.find('.toggle-group');
        const shouldBeCollapsed = collapseStates[groupName];
        
        if (shouldBeCollapsed && groupItems.is(':visible')) {
            // Collapse instantly (no animation to avoid jumps)
            groupItems.hide();
            toggleButton.text('+');
            groupElement.addClass('collapsed-group');
        } else if (!shouldBeCollapsed && !groupItems.is(':visible')) {
            // Expand instantly (no animation to avoid jumps)
            groupItems.show();
            toggleButton.text('−');
            groupElement.removeClass('collapsed-group');
        }
    });
}
      
                
                function showRecipeModal() {
                    selectedItemsForRecipe = selectedItems.map(itemId => itemId);
                    
                    $('#recipe-confirm').removeClass('d-none');
                    $('#recipe-name-input').addClass('d-none');
                    $('#recipe-yes').removeClass('d-none');
                    $('#recipe-save').addClass('d-none');
                    recipeModal.show();
                }
                
                function showRecipeNameInput() {
                    $('#recipe-confirm').addClass('d-none');
                    $('#recipe-name-input').removeClass('d-none');
                    $('#recipe-yes').addClass('d-none');
                    $('#recipe-save').removeClass('d-none');
                }
                
                function saveRecipe() {
                    const recipeName = $('#recipe-name').val().trim();
                    const date = $('#date-selector').val();
                    
                    if (!recipeName) {
                        alert('Please enter a recipe name');
                        return;
                    }
                    
                    $.post('/save_recipe', {
                        recipe_name: recipeName,
                        selected_ids: JSON.stringify(selectedItemsForRecipe),
                        date: date
                    }, response => {
                        if (response.success) {
                            alert('Recipe saved successfully!');
                            recipeModal.hide();
                            resetRecipeSelection();
                            loadTopFoods();
                        } else {
                            alert('Error: ' + (response.error || 'Failed to save recipe'));
                        }
                    }).fail(xhr => {
                        alert('Error: ' + (xhr.responseJSON?.error || 'Failed to save recipe'));
                    });
                }
                function adjustMobileFontSize(){}
                function showSaveTemplateModal() {
                    if (selectedItems.length === 0) return;
                    $('#saveTemplateModal').modal('show');
                }
                
    function saveTemplate() {
        const templateName = $('#template-name').val().trim();
        if (!templateName) {
            alert('Please enter a template name');
            return;
        }

        const itemsWithData = [];
        const isMobile = $(window).width() < 992;
        const itemSelector = '.list-group-item'; // works for both desktop & mobile

        $(itemSelector).each(function() {
            const itemId = $(this).data('id');

            // Primary: data-key on the <li>
            let foodKey = $(this).data('key');

            // Fallback 1: attribute directly
            if (!foodKey) foodKey = $(this).attr('data-key');

            // Fallback 2: child element with data-key
            if (!foodKey) {
                foodKey = $(this).find('.edit-grams, .edit-grams-btn').data('key');
            }

            // Fallback 3: hidden input or .food-key span
            if (!foodKey) {
                foodKey = $(this).find('.food-key').text().trim() || 
                        $(this).find('input.food-key').val();
            }

            // Get grams safely
            let gramsElement = $(this).find('.edit-grams');
            if (isMobile && gramsElement.length === 0) {
                gramsElement = $(this).find('.edit-grams-btn');
            }

            let gramsText = gramsElement.text().trim();
            if (gramsText.endsWith('g')) gramsText = gramsText.slice(0, -1);

            const grams = parseFloat(gramsText);

            console.log(`Item: id=${itemId}, key=${foodKey}, grams=${grams}`);

            if (!isNaN(grams) && grams > 0 && foodKey) {
                itemsWithData.push({
                    id: itemId,
                    food_key: foodKey,
                    grams: grams
                });
            }
        });

        console.log('Items to save:', itemsWithData);

        if (itemsWithData.length === 0) {
            alert('No valid items to save as template. Please make sure you have food items with valid quantities.');
            return;
        }

        const saveBtn = $('#confirm-save-template');
        const originalText = saveBtn.html();
        saveBtn.html('<span class="spinner-border spinner-border-sm" role="status"></span> Saving...');

        $.ajax({
            url: SAVE_TEMPLATE_URL,
            method: 'POST',
            data: {
                name: templateName,
                items: JSON.stringify(itemsWithData)
            },
            success: function(response) {
                saveBtn.html(originalText);
                if (response.success) {
                    showToast('Pohja tallennettu onnistuneesti!!', 'success');
                    $('#saveTemplateModal').modal('hide');
                    $('#template-name').val('');
                } else {
                    showToast('Virhe: ' + (response.error || 'Pohjan tallentaminen epäonnistui!'), 'error');
                }
            },
            error: function(xhr, status, error) {
                saveBtn.html(originalText);
                console.error('Template error:', error, xhr.responseText);
                showToast('Tallennus epäonnistui. Tarkista yhteys ja yritä uudelleen.', 'error');
            }
        });
    }
    function debugTemplateItems() {
        console.log("=== DEBUG TEMPLATE ITEMS ===");
        
        // Check mobile state
        const isMobile = $(window).width() < 992;
        console.log("Is mobile:", isMobile);
        
        // Count all items
        const allItems = $('.list-group-item');
        console.log("Total items found:", allItems.length);
        
        // Check each item
        allItems.each(function(index) {
            const item = $(this);
            const id = item.data('id');
            const key = item.data('key');
            const gramsText = item.find('.edit-grams').text() || item.find('.edit-grams-btn').text();
            const grams = parseFloat(gramsText.replace('g', ''));
            
            console.log(`Item ${index}: id=${id}, key=${key}, grams=${grams}, valid=${!isNaN(grams) && grams > 0 && key}`);
            
        });
        
        console.log("=== END DEBUG ===");
    }           
                function showApplyTemplateModal() {
                    loadTemplates();
                    $('#applyTemplateModal').modal('show');
                }
                
function applyTemplate() {
    const templateId = $('#template-select').val();
    const mealGroup = $('#template-meal-group').val();
    
    if (!templateId) return;
    
    const applyBtn = $('#confirm-apply-template');
    const originalText = applyBtn.html();
    applyBtn.html(`<span class="spinner-border spinner-border-sm" role="status"></span> ${t('applying')}`);

    // find target group and collapse element BEFORE AJAX
    const targetGroup = $(`.food-group[data-group="${mealGroup}"]`);
    // common cases:
    // - Bootstrap: a .collapse element inside the group
    // - Toggle button: button or a that has aria-expanded
    // - fallback: check visibility of .group-items
    const collapseEl = targetGroup.find('.collapse').first();
    let isExpanded = false;
    if (collapseEl.length) {
        isExpanded = collapseEl.hasClass('show') || collapseEl.is(':visible');
    } else {
        // try to find a toggle with aria-expanded
        const toggle = targetGroup.find('[data-toggle="collapse"], [data-bs-toggle="collapse"]').first();
        if (toggle.length) {
            // aria-expanded is string "true"/"false" or absent
            const aria = toggle.attr('aria-expanded');
            isExpanded = aria === 'true' || aria === true;
        } else {
            // fallback: check if .group-items are visible
            const items = targetGroup.find('.group-items').first();
            isExpanded = items.length ? items.is(':visible') : false;
        }
    }

    $.post(APPLY_TEMPLATE_URL, {
        template_id: templateId,
        meal_group: mealGroup,
        date: currentSelectedDate
    }, response => {
        applyBtn.html(originalText);
        
        if (response.success) {
            // Update totals only
            if (response.totals) {
                updateNutritionTotalsOnly(response.totals);
                applyTranslations();
                updateNutritionAbbreviations();
            }

            // Load previous states
            const collapseStates = loadCollapseStates();

            // If currently expanded, keep it expanded (false = not collapsed)
            // Otherwise, default to collapsed (true)
            collapseStates[mealGroup] = !isExpanded;
            localStorage.setItem('mealGroupCollapseStates', JSON.stringify(collapseStates));

            // Clear existing items before adding new ones
            if (targetGroup.length) {
                targetGroup.find('.group-items').empty();
            }

            // Add items to the correct group
            if (response.breakdown && response.breakdown[mealGroup]) {
                const groupData = response.breakdown[mealGroup];
                addItemsToGroup(mealGroup, groupData.items, groupData);
            }

            // Force UI to match the desired state (this prevents auto-collapse)
            // Use Bootstrap collapse API if available
            try {
                if (collapseEl.length && typeof collapseEl.collapse === 'function') {
                    collapseEl.collapse(isExpanded ? 'show' : 'hide');
                } else {
                    // fallback: toggle visibility of .group-items
                    const items = targetGroup.find('.group-items').first();
                    if (items.length) {
                        if (isExpanded) items.show();
                        else items.hide();
                    }
                    // also fix toggle aria-expanded if present
                    const toggle = targetGroup.find('[data-toggle="collapse"], [data-bs-toggle="collapse"]').first();
                    if (toggle.length) toggle.attr('aria-expanded', isExpanded ? 'true' : 'false');
                }
            } catch (e) {
                // if anything goes wrong, log but continue
                console.warn('Could not force-collapse state:', e);
            }

            hideEmptyGroups();
            $('#applyTemplateModal').modal('hide');
        
        } else {
            alert(t('error_apply_template' + (response.error || 'failed_to_apply_template')));
        }
    }).fail((xhr, status, error) => {
        applyBtn.html(originalText);
        console.error('Template application error:', error);
        alert(t('failed_to_apply_template_retry'));
    });
}


 function addItemsToGroup(groupName, newItems, groupData) {
    let groupElement = $(`.food-group[data-group="${groupName}"]`);
    
    // If group doesn't exist, create it
    if (groupElement.length === 0) {
        groupElement = createGroupElement(groupName, groupData);
        $('#food-log').append(groupElement);
    }
    
    const groupItemsList = groupElement.find('.group-items');
    
    // Remove empty state if present
    groupItemsList.find('.empty-state').remove();
    
    // Add new items
    newItems.forEach(item => {
        const itemHtml = createItemHtml(item);
        groupItemsList.append(itemHtml);
    });
    
    // Update group totals
    updateGroupTotals(groupName, groupData);
        $('.empty-state').remove();
    
    // Apply collapse state
    const collapseStates = loadCollapseStates();
    if (collapseStates[groupName]) {
        groupItemsList.hide();
        groupElement.find('.toggle-group').text('+');
        groupElement.addClass('collapsed-group');
    }
}

function createGroupElement(groupName, groupData) {
    const icons = {
        breakfast: 'fas fa-sun',
        lunch: 'fas fa-utensils', 
        dinner: 'fas fa-moon',
        snack: 'fas fa-apple-alt',
        other: 'fas fa-question'
    };

    return $(`
        <div class="food-group ${groupName}" data-group="${groupName}">
            <div class="group-header d-flex justify-content-between align-items-center">
                <div class="d-flex align-items-center">
                    <div class="group-icon">
                        <i class="${icons[groupName] || 'fas fa-question'}"></i>
                    </div>
                    <span class="group-title">${t(groupName)}</span>
                </div>
                <div class="group-nutrition-container">
                    <div class="group-nutrition">
                        <div class="nutrition-value-xxs d-inline-block m-1 nutrition-calories">
                            <span>${groupData.calories.toFixed(1)} ${t("kcal")}</span>
                        </div>
                        <div class="nutrition-value-xxs d-inline-block m-1">
                            <span>${groupData.proteins.toFixed(1)}${t("grams")} ${t("p")}</span>
                        </div>
                        <div class="nutrition-value-xxs d-inline-block m-1">
                            <span>${groupData.carbs.toFixed(1)}${t("grams")} ${t("c")}</span>
                        </div>
                        <div class="nutrition-value-xxs d-inline-block m-1">
                            <span>${groupData.fats.toFixed(1)}${t("grams")} ${t("f")}</span>
                        </div>
                    </div>
                    <button class="btn btn-sm toggle-group ms-1">−</button>
                </div>
            </div>
            <ul class="group-items list-group list-group-flush"></ul>
        </div>
    `);
}


function createItemHtml(item) {
    return $(`
        <li class="list-group-item bg-dark text-light d-flex justify-content-between align-items-center" 
            data-id="${item.id}" data-key="${item.key}">
            
            <div class="food-item-container">
                <span class="edit-grams badge edit-grams-btn mx-1"
                    data-id="${item.id}" 
                    data-key="${item.key}">
                    ${item.grams.toFixed(1)}${t("grams")}
                </span>
                <div class="food-name">
                    <strong>${item.name}</strong>
                </div>
            </div>

            <div class="nutrition-and-actions d-flex align-items-center">
                <div class="nutrition-values-container d-flex">
                    <div class="nutrition-value-xxs d-inline-block mx-1 nutrition-calories">
                        <span>${item.calories.toFixed(1)} ${t("kcal")}</span>
                    </div>
                    <div class="nutrition-value-xxs d-inline-block mx-1">
                        <span>${item.proteins.toFixed(1)}${t("grams")} ${t("p")}</span>
                    </div>
                    <div class="nutrition-value-xxs d-inline-block mx-1">
                        <span>${item.carbs.toFixed(1)}${t("grams")} ${t("c")}</span>
                    </div>
                    <div class="nutrition-value-xxs d-inline-block mx-1">
                        <span>${item.fats.toFixed(1)}${t("grams")} ${t("f")}</span>
                    </div>
                </div>
                <button class="btn delete-item ms-2" data-id="${item.id}">
                    <i class="fa-solid fa-circle-xmark"></i>
                </button>
            </div>
        </li>
    `);
}
   
                function showCameraModal() {
                    cameraModal.show();
                }
                
                function toggleCamera() {
                    currentCamera = currentCamera === 'environment' ? 'user' : 'environment';
                    localStorage.setItem('cameraPreference', currentCamera);
                    stopCamera();
                    
                    // Update status
                    const cameraType = currentCamera === 'environment' ? 'back' : 'front';
                    $('#camera-status').text(`Switching to ${cameraType} camera...`);
                    
                    setTimeout(startCamera, 500);
                }
                
                function resumeScanning() {
                    lastScannedCode = null;
                    $('#scanned-result').text('');
                    startCamera();
                }
                
                function prepareCameraModal() {
                    // Recreate overlay elements
                    $('#scanner-overlay').html(`
                        <div class="scanning-text"><span data-i18n="position_barcode_in_the_scan_area">Laita viivakoodi skannaus alueelle</span></div>
                        <div class="scan-guide"></div>
                        <div class="scan-line"></div>
                        <div id="scanned-result" class="scanned-result"></div>
                    `);
                }
                
                function initializeCamera() {
                    setTimeout(startCamera, 300);
                }
                
                function handleMobileTabSwitch() {
                    const panelId = $(this).data('panel');
                    
                    // Hide all panels
                    $('.mobile-panel').removeClass('active');
                    
                    // Show selected panel
                    $('#' + panelId).addClass('active');
                    
                    // Update active button
                    $('.mobile-tab-btn').removeClass('active');
                    $(this).addClass('active');
                    
                    // Close modals if open
                    $('.modal').modal('hide');
                }
                
                // ===== UTILITY FUNCTIONS =====
                
                function loadTopFoods() {
                    $.post('/search_foods', { query: '' }, data => {
                        let resultsHtml = '';
                        if (data.length > 0) {
                            resultsHtml = '<div class="list-group">';
                            data.forEach(food => resultsHtml += createFoodItemHtml(food));
                            resultsHtml += '</div>';
                        } else {
                            resultsHtml = '<div class="text-center p-2 small">No foods available</div>';
                        }
                        $('#search-results').html(resultsHtml);
                    });
                }
                
                function createFoodItemHtml(food) {
                    const displayCalories = formatCalories(food.calories) + ' kcal';
                    
                    return `
                        <a class="list-group-item list-group-item-action food-item small text-start" 
                        data-id="${food.id}" }"
                        data-entire="${food.entire_size || ''}"
                        data-half="${food.half_size || ''}"
                        data-serving="${food.serving_size || ''}"
                        data-bigserving="${food.bigserving_size || ''}">
                            <div class="d-flex justify-content-between align-items-center">
                                <span class="food-name">${food.name}</span>
                                <div>
                                    <span class="calorie-badge">${displayCalories}</span>
                                    <button class="delete-food-btn" data-id="${food.id}">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </a>
                    `;
                }
                
                function formatCalories(calories) {
                    const num = parseFloat(calories);
                    if (isNaN(num)) return "0";
                    
                    const formatted = num.toFixed(2);
                    return formatted.length > 5 ? num.toFixed(1) : formatted;
                }
                
                function updatePortionButtons(food, favouriteGrams) {    
    const container = $('#portion-buttons');
    container.empty();

    const portionTypes = [
        { type: 'entire', size: food.entire_size },            
        { type: 'half', size: food.half_size },
        { type: 'serving', size: food.serving_size },
        { type: 'bigserving', size: food.bigserving_size }  
    ];     

    portionTypes.forEach(portion => {
        if (portion.size) {
            const button = $(`
                <button type="button" class="btn portion-btn" 
                        data-portion-type="${portion.type}" 
                        data-portion-size="${portion.size}"
                        data-multiple="0">
                ${t(portion.type)} (${portion.size}${t("grams")})
                </button>
            `);
            container.append(button);
        }
    });

    if (favouriteGrams) {
        const favouriteButton = $(`
            <button type="button" class="btn portion-btn favourite-btn" 
                    data-portion-type="favourite" 
                    data-portion-size="${favouriteGrams}">
                ${t("Suosikki")} (${favouriteGrams}g)
            </button>
        `);
        container.append(favouriteButton);
    }
}
function getFavouriteGrams(foodId) {
    return new Promise((resolve) => {
        $.post('/get_favourite_grams', { food_id: foodId }, response => {
                console.log("Favourite response:", response);
            resolve(response.last_grams !== undefined ? response.last_grams : null);
        }).fail(() => {
            resolve(null);
        });
    });
}
                   function initPortionControls() {
                    // Document click handler to reset portion buttons
                    $(document).on('click', function(e) {
                        const target = $(e.target);
                        
                        // Check if click is inside whitelisted elements
                        const isWhitelisted = target.closest('#meal-group').length > 0 || 
                                            target.is('#grams') || 
                                            target.closest('#add-food').length > 0 ||
                                            target.closest('.portion-btn').length > 0 ||
                                            target.is('#date-selector, #date-selector option');                  
                        // If click is outside whitelisted elements, reset the portion buttons
                        if (!isWhitelisted) {
                            resetPortionButtons();
                            updateRealTimeBreakdownFromForm();
                        }
                    });
                }
                
                function resetPortionButtons() {
    $('.portion-btn').each(function() {
        const baseSize = parseFloat($(this).data('portion-size'));
        const portionType = $(this).data('portion-type');
        const label = t(portionType); // Use translation function
        $(this).text(`${label} (${baseSize}${t("grams")})`);
        $(this).data('multiple', 0);
        $(this).removeClass('active');
    });

    if (!$('#grams').is(':focus')) {
        setTimeout(() => {
            $('#grams').trigger('focus').trigger('select');
        }, 50);
    }
}
                            
                        
                function initGramsInputReset() {
                    // Define whitelisted elements that should NOT trigger reset
                    const whitelist = [
                        '#meal-group',
                        '#grams',
                        '#add-food',
                        '.portion-btn',
                        '#portion-buttons',
                        '.modal',
                        '.btn-close'
                    ];
                    
                    const whitelistSelector = whitelist.join(', ');
                    
                    $(document).on('click', function(e) {
                        const $target = $(e.target);
                        
                        // Check if click is inside whitelisted elements
                        const isWhitelisted = $target.is(whitelistSelector) || 
                                            $target.closest(whitelistSelector).length > 0;
                        
                        // Reset grams input if click is outside whitelisted elements
                        if (!isWhitelisted) {
                            resetGramsInput();
                        }
                    });
                }
                
                function resetGramsInput() {
                    $('#grams').val('');
                    if (currentFood) {
                        updateRealTimeBreakdown({
                            calories: 0,
                            proteins: 0,
                            carbs: 0,
                            fats: 0,
                            grams: 0
                            });
                        }
                            if (!$('#grams').is(':focus')) {
                            setTimeout(() => {
                                $('#grams').trigger('focus').trigger('select');
                            }, 50);
                                }
                            }
                            
                        function updateRealTimeBreakdownFromForm() {
                    if (!currentFood) return;
                    
                    const grams = parseFloat($('#grams').val()) || 0;
                    const factor = grams / 100;
                    
                    const updatedData = {
                        calories: (currentFood.calories * factor),
                        proteins: (currentFood.proteins * factor),
                        carbs: (currentFood.carbs * factor),
                        fats: (currentFood.fats * factor),
                        saturated: (currentFood.saturated * factor),
                        fiber: (currentFood.fiber * factor),
                        sugars: (currentFood.sugars * factor),
                        salt: (currentFood.salt * factor),
                        grams: grams
                    };
                    
                    updateRealTimeBreakdown(updatedData);
                }

                // Enhanced function to handle decimal values properly + mobile scaling
                function updateRealTimeBreakdown(data) {
                    if (!$('#rt-breakdown-container').is(':visible')) return;
                    
                    const formatValue = (value) => {
                        if (value < 0.1) return value.toFixed(2);
                        if (value < 1) return value.toFixed(1);
                        return value.toFixed(0);
                    };
                    
                    // Update values
                    $('#rt-calories').text(formatValue(data.calories));
                    $('#rt-proteins').text(formatValue(data.proteins) + 'g');
                    $('#rt-carbs').text(formatValue(data.carbs) + 'g');
                    $('#rt-fats').text(formatValue(data.fats) + 'g');
                    $('#rt-grams').text(formatValue(data.grams) + 'g');
                    
                    // Mobile-specific font adjustments
                    if ($(window).width() < 992) {
                        const isOldPhone = window.innerWidth <= 360;
                        const baseSize = isOldPhone ? 12 : 14;
                        
                        adjustMobileFontSize($('#rt-calories')[0], baseSize);
                        adjustMobileFontSize($('#rt-proteins')[0], baseSize);
                        adjustMobileFontSize($('#rt-carbs')[0], baseSize);
                        adjustMobileFontSize($('#rt-fats')[0], baseSize);
                    }
                }
                
function loadCollapseStates() {
    const storedStates = localStorage.getItem('mealGroupCollapseStates');
    if (storedStates) {
        return JSON.parse(storedStates);
    }
    return {};
}
function saveCollapseStates() {
    const collapseStates = {};
    $('.food-group').each(function() {
        const group = $(this).data('group');
        const isCollapsed = $(this).hasClass('collapsed-group');
        collapseStates[group] = isCollapsed;
    });
    localStorage.setItem('mealGroupCollapseStates', JSON.stringify(collapseStates));
}


function updateSessionDisplay(session, totals, breakdown) {
    console.log("Updating session display:", totals, breakdown);
    updateNutritionGrid(totals);
    updateMobileNutrition(totals);
    updateCalorieDifference();
    applyTranslations();
    updateNutritionAbbreviations();
    
    // Load saved collapse states
    const collapseStates = loadCollapseStates();
    
    let logHtml = '';
    
    if (breakdown) {
        for (const group in breakdown) {
            const groupData = breakdown[group];
            // Check if this group should be collapsed based on saved state
            const isCollapsed = collapseStates[group] !== undefined ? collapseStates[group] : false;
            
            logHtml += `
                <div class="food-group ${group} ${isCollapsed ? 'collapsed-group' : ''}" data-group="${group}">
                    <div class="group-header d-flex justify-content-between align-items-center">
                        <div class="d-flex align-items-center">
                            <div class="group-icon">
                                ${group === 'breakfast' ? '<i class="fas fa-sun"></i>' : 
                                group === 'lunch' ? '<i class="fas fa-utensils"></i>' : 
                                group === 'dinner' ? '<i class="fas fa-moon"></i>' : 
                                group === 'snack' ? '<i class="fas fa-apple-alt"></i>' : 
                                '<i class="fas fa-question"></i>'}
                            </div>
                            <span class="group-title" data-i18n="${group}">${t(group)}</span>
                        </div>
                        <div class="group-nutrition-container">
                            <div class="group-nutrition">
                                <div class="nutrition-value-xxs d-inline-block m-1 nutrition-calories" style="background-color: #ffffff;color: black;">
                                    <span>${groupData['calories'].toFixed(1)} kcal</span>
                                </div>
                                <div class="nutrition-value-xxs d-inline-block m-1" style="background-color: #b61336; color: black;">
                                    <span>${groupData['proteins'].toFixed(1)}g P</span>
                                </div>
                                <div class="nutrition-value-xxs d-inline-block m-1" style="background-color: #b61336;color: black;">
                                    <span>${groupData['carbs'].toFixed(1)}g C</span>
                                </div>
                                <div class="nutrition-value-xxs d-inline-block m-1" style="background-color: #b61336;color: black;">
                                    <span>${groupData['fats'].toFixed(1)}g F</span>
                                </div>
                            </div>
                            <button class="btn btn-sm toggle-group ms-1">${isCollapsed ? '+' : '−'}</button>
                        </div>
                    </div>
                    <ul class="group-items list-group list-group-flush" ${isCollapsed ? 'style="display: none;"' : ''}>
            `;
            
            groupData['items'].forEach((item, index) => {
                logHtml += `
                    <li class="list-group-item bg-dark text-light d-flex justify-content-between align-items-center" 
                        data-id="${item.id}" data-key="${item.key}">
                        
                        <!-- left section: grams + food name -->
                        <div class="food-item-container">
                            <span class="edit-grams badge edit-grams-btn mx-1"
                                data-id="${item.id}" 
                                data-key="${item.key}">
                                ${item.grams.toFixed(1)}g
                            </span>
                            <div class="food-name">
                                <strong>${item.name}</strong>
                            </div>
                        </div>

                        <!-- right section: nutrition + delete -->
                        <div class="nutrition-and-actions d-flex align-items-center">
                            <div class="nutrition-values-container d-flex">
                                <div class="nutrition-value-xxs d-inline-block mx-1 nutrition-calories" style="background-color: #ffffff;color: black;">
                                    <span>${item.calories.toFixed(1)} kcal</span>
                                </div>
                                <div class="nutrition-value-xxs d-inline-block mx-1" style="background-color: #b61336; color: black;">
                                    <span>${item.proteins.toFixed(1)}g P</span>
                                </div>
                                <div class="nutrition-value-xxs d-inline-block mx-1" style="background-color: #b61336;color: black;">
                                    <span>${item.carbs.toFixed(1)}g C</span>
                                </div>
                                <div class="nutrition-value-xxs d-inline-block mx-1" style="background-color: #b61336;color: black;">
                                    <span>${item.fats.toFixed(1)}g F</span>
                                </div>
                            </div>
                            <button class="btn delete-item ms-2" data-id="${item.id}">
                                <i class="fa-solid fa-circle-xmark"></i>
                            </button>
                        </div>
                    </li>
                `;
            });
            
            logHtml += `
                    </ul>
                </div>
            `;
        }
    }
    
    if (logHtml === '') {
        logHtml = '<div class="empty-state" data-i18n="no_food_message">No food logged yet</div>';
    }
    
    $('#food-log').html(logHtml);
}
              
                function updateNutritionGrid(totals) {
                    const safeParse = (value) => {
                        const num = parseFloat(value) || 0;
                        if (num < 0.1) return num.toFixed(2);
                        if (num < 1) return num.toFixed(1);
                        return num.toFixed(0);
                    };
                    
                    $('#grid-calories').text(safeParse(totals.calories));
                    $('#grid-proteins').text(safeParse(totals.proteins) + 'g');
                    $('#grid-carbs').text(safeParse(totals.carbs) + 'g');
                    $('#grid-fats').text(safeParse(totals.fats) + 'g');
                    $('#grid-saturated').text(safeParse(totals.saturated) + 'g');
                    $('#grid-sugars').text(safeParse(totals.sugars) + 'g');
                    $('#grid-fiber').text(safeParse(totals.fiber) + 'g');
                    $('#grid-salt').text(safeParse(totals.salt) + 'g');
                }
    $('#food-search').on('keypress', function(e) {
        if (e.which === 13) { // Enter key
            e.preventDefault();
            const query = $(this).val().trim();
            if (query.length > 0) {
                performFoodSearch(query);
            }
        }
    });
                function updateMobileNutrition(totals) {
                const safeParse = (value) => {
                    const num = parseFloat(value) || 0;
                    if (num < 0.1) return num.toFixed(2);
                    if (num < 1) return num.toFixed(1);
                    return num.toFixed(0);
                };
                
                 $('#mobile-calories-value').text(safeParse(totals.calories) + ' kcal');
                $('#mobile-proteins').text(safeParse(totals.proteins) + 'g');
                $('#mobile-carbs').text(safeParse(totals.carbs) + 'g');
                $('#mobile-fats').text(safeParse(totals.fats) + 'g');
                $('#mobile-sugars').text(safeParse(totals.sugars) + 'g');
                $('#mobile-fiber').text(safeParse(totals.fiber) + 'g');
                $('#mobile-salt').text(safeParse(totals.salt) + 'g');
                $('#mobile-saturated').text(safeParse(totals.saturated) + 'g');
            }
                                    
                function updateCalorieDifference() {
                const tdee = {% if current_tdee %}{{ current_tdee }}{% else %}0{% endif %};
                const loggedCalories = parseFloat($('#grid-calories').text()) || 0;
                const difference = tdee - loggedCalories;
                const absDiff = Math.abs(difference);

                let statusKey, statusClass;
                if (absDiff <= 50) {
                    statusKey = "maintaining";
                    statusClass = "status-maintain";
                } else if (difference > 0) {
                    statusKey = "calories_left";
                    statusClass = "status-loss";
                } else {
                    statusKey = "calories_over";
                    statusClass = "status-gain";
                }

                const translatedStatus = t(statusKey);
                $('#calorie-difference').text(absDiff.toFixed(0));
                $('#calorie-status').text(translatedStatus)
                    .removeClass('status-maintain status-loss status-gain')
                    .addClass(statusClass);
                $('#mobile-today-value').text(absDiff.toFixed(0));
                $('#mobile-status-text').text(translatedStatus)
                    .removeClass('status-maintain status-loss status-gain')
                    .addClass(statusClass);
        }

                
                function resetFoodForm() {
                    $('#food-search').val('');
                    $('#grams').val('');
                    $('#food-details').addClass('d-none');
                    $('#portion-buttons').empty();
                    currentFood = null;
                    $('#rt-breakdown-container').addClass('d-none');
                    loadTopFoods();
                    initializeIcons();
                }
                
                function resetRecipeSelection() {
                    selectedItems = [];
                    selectedItemsForRecipe = [];
                    $('.list-group-item.selected').removeClass('selected');
                    $('#move-items').prop('disabled', true);
                    $('#create-recipe').addClass('d-none').prop('disabled', true);
                }
                
                function refreshDateSelector() {
                    const currentDate = $('#date-selector').val();
                    
                    $.post('/update_session', { date: currentDate }, response => {
                        updateSessionDisplay(response.session, response.totals, response.breakdown);
                        updateCalorieDifference();
                        $('.card-header h6:contains("Food Log")').text(`Food Log (${response.current_date_formatted})`);
                    });
                }
                
            function loadTemplates() {
                // Show loading state
                const select = $('#template-select');
                select.html(`<option value="">${t('loading_templates')}</option>`);
                
                $.get('/get_templates_food', templates => {
                    select.empty();
                    
                    if (templates.length === 0) {
                        select.append(t('<option value="">no_template_available</option>'));
                        $('#confirm-apply-template').prop('disabled', true);
                    } else {
                        templates.forEach(template => {
                            select.append(`<option value="${template.id}">${template.name}</option>`);
                        });
                        $('#confirm-apply-template').prop('disabled', false);
                    }
                }).fail(() => {
                    select.html(t('<option value="">error_loading_template</option>'));
                });
            }
                
                function updateTemplateButtonState() {
                const hasSelection = selectedItems.length > 0;
                $('#save-template-btn, #save-template-btn-mobile').prop('disabled', !hasSelection);
            }
                
                function positionNutritionGrid() {
                    const navbarHeight = $('.navbar').outerHeight();
                    const container = $('.container-main');
                    const containerOffset = container.offset();
                    const containerWidth = container.width();
                    
                    // Calculate responsive position
                    const responsiveOffset = Math.min(40, window.innerWidth * 0.02);
                    const gridLeft = containerOffset.left + containerWidth + responsiveOffset;
                    
                    // Apply responsive sizing
                    const gridHeight = Math.min(900, window.innerHeight * 0.7);
                    
                    $('.nutrition-grid-container').css({
                        'top': navbarHeight + 20,
                        'left': gridLeft,
                        'height': gridHeight + 'px'
                    });
                }
                
                function updateGridFontSizes() {
                    const baseSize = Math.min(16, window.innerWidth * 0.012);
                    $('.grid-cell').css('font-size', baseSize + 'px');
                    $('.grid-value').css('font-size', (baseSize * 1.1) + 'px');
                    $('.grid-cell i').css('font-size', (baseSize * 1.4) + 'px');
                }
                
                function adjustGridScale() {
                    const grid = $('.nutrition-grid-container');
                    const windowHeight = window.innerHeight;
                    const gridHeight = grid.height();
                    
                    if (windowHeight < 900) {
                        const scale = Math.max(0.7, Math.min(1, windowHeight / 1000));
                        grid.css('transform', `scale(${scale})`);
                        
                        // Adjust cell padding dynamically
                        const cellPadding = Math.max(4, 8 * scale);
                        $('.grid-cell').css('padding', `${cellPadding}px 3px`);
                    }
                }
                function caloriesFromMacros(protein, carbs, fat) {
    return protein * 4 + carbs * 4 + fat * 9;
}
            function updateNutritionProgressBars() {
    $.get('/get_nutrition_targets', function(targets) {
        // Safely parse totals from DOM, strip non-numeric chars
        const parseValue = selector => parseFloat($(selector).text().replace(/[^\d.]/g, '')) || 0;

        const proteins = parseValue('#grid-proteins');
        const carbs    = parseValue('#grid-carbs');
        const fats     = parseValue('#grid-fats');
        const saturated = parseValue('#grid-saturated');
        const sugars   = parseValue('#grid-sugars');
        const fiber    = parseValue('#grid-fiber');
        const salt     = parseValue('#grid-salt');

        const totalCalories = caloriesFromMacros(proteins, carbs, fats);

        let progressHtml = '';

        // MACROS: protein, carbs, fats
        const macros = [
            {key: 'proteins', icon: 'fa-drumstick-bite', grams: proteins, target: targets.proteins || 0},
            {key: 'carbs',    icon: 'fa-bread-slice',   grams: carbs,    target: 0}, // carbs targets optional
            {key: 'fats',     icon: 'fa-oil-can',       grams: fats,     target: targets.fats || 0}
        ];

        macros.forEach(m => {
            const macroCalories = m.key === 'fats' ? m.grams * 9 : m.grams * 4;
            const caloriesPercent = totalCalories > 0 ? (macroCalories / totalCalories) * 100 : 0;

            // For carbs, we just display % calories
            const displayText = `${m.grams.toFixed(0)}g` +
                (m.target > 0 ? ` / ${m.target.toFixed(0)}g` : '');

            progressHtml += createProgressBarHtml(
                m.key,
                m.icon,
                m.key.toUpperCase(),
                caloriesPercent,
                100,
                `progress-${m.key}`,
                displayText
            );
        });

        // OTHER nutrients (target-based)
        progressHtml += createProgressBarHtml('saturated', 'fa-bacon', 'SATURATED', saturated, targets.saturated, 'progress-saturated');
        progressHtml += createProgressBarHtml('sugars', 'fa-candy-cane', 'SUGARS', sugars, targets.sugars, 'progress-sugars');
        progressHtml += createProgressBarHtml('fiber', 'fa-apple-alt', 'FIBER', fiber, targets.fiber, 'progress-fiber');
        progressHtml += createProgressBarHtml('salt', 'fa-mortar-pestle', 'SALT', salt, targets.salt, 'progress-salt');

        $('#nutrition-progress-bars').html(progressHtml);
    });
}

// Updated createProgressBarHtml with custom displayText
function createProgressBarHtml(id, icon, labelKey, current, target, cssClass, displayText) {
    current = current || 0;
    target = target || 0;
    const percentage = target > 0 ? Math.min(100, (current / target) * 100) : 0;

    // Use translation function for label
    const translatedLabel = t(labelKey.toLowerCase() + '_upper') || labelKey;

    return `
        <div class="progress-item ${cssClass}">
            <div class="progress-icon">
                <i class="fas ${icon}"></i>
            </div>
            <div class="progress-details">
                <div class="progress-info">
                    <span class="progress-label">${translatedLabel}</span>
                    <span class="progress-values">${displayText || `${current.toFixed(1)} / ${target.toFixed(1)}`}</span>
                </div>
                <div class="progress-bar-bg">
                    <div class="progress-bar-fill" style="width: ${percentage}%">
                        <span class="percentage-text">${percentage.toFixed(0)}%</span>
                    </div>
                </div>
            </div>
        </div>
    `;
}

// Trigger updates
$('.mobile-tab-btn[data-panel="nutrition-panel"]').click(updateNutritionProgressBars);
$(document).on('sessionUpdated', function() {
    if ($('#nutrition-panel').hasClass('active')) {
        updateNutritionProgressBars();
        applyTranslations();
        updateNutritionAbbreviations();
    }
});

                function initializeIcons() {
                if (window.FontAwesome) {
                    FontAwesome.dom.i2svg({
                        callback: function() {
                            console.log('Icons refreshed');
                        }
                        
                    });
                }
                
                // Ensure icons are properly rendered
                setTimeout(() => {
                    if (window.FontAwesome) {
                        FontAwesome.dom.watch();
                    }
                }, 100);
            }
                
                function startCamera() {
                    scanningActive = true;
                    $('#scanned-result').text('Initializing camera...').css('color', 'white');
                    
                    // Show the preview container
                    $('#camera-preview').css('visibility', 'visible');

                    // Initialize ZXing
                    if (!codeReader) {
                        codeReader = new ZXing.BrowserMultiFormatReader();
                    }

                    // Force back camera by default
                    currentCamera = 'environment';
                    
                    // List available cameras
                    codeReader.listVideoInputDevices()
                        .then(videoInputDevices => {
                            if (videoInputDevices.length === 0) {
                                $('#scanned-result').html('No cameras found');
                                return;
                            }
                            
                            let cameraId;
                            let cameraLabel = '';
                            let backCamera = null;
                            let frontCamera = null;
                            
                            // Classify cameras
                            videoInputDevices.forEach(device => {
                                if (/back|rear|environment|1|primary|main|wide/i.test(device.label.toLowerCase())) {
                                    backCamera = device;
                                } else if (/front|user|0|selfie|face/i.test(device.label.toLowerCase())) {
                                    frontCamera = device;
                                }
                            });
                            
                            // Select camera based on preference
                            if (currentCamera === 'environment' && backCamera) {
                                cameraId = backCamera.deviceId;
                                cameraLabel = 'back';
                            } else if (currentCamera === 'user' && frontCamera) {
                                cameraId = frontCamera.deviceId;
                                cameraLabel = 'front';
                            } else {
                                // Fallback to first available camera
                                cameraId = videoInputDevices[0].deviceId;
                                cameraLabel = videoInputDevices[0].label;
                            }

                            // Start decoding
                            codeReader.decodeFromVideoDevice(cameraId, 'camera-video', (result, err) => {
                                if (result) {
                                    const code = result.text;
                                    if (lastScannedCode === code) return;
                                    
                                    lastScannedCode = code;
                                    $('#scanned-result').html(`<strong>SCANNED:</strong> ${code}<br>Processing...`)
                                        .css('color', '#00ff00');
                                    
                                    handleScannedCode(code);
                                } 
                                
                                if (err && !(err instanceof ZXing.NotFoundException)) {
                                    console.error('ZXing error:', err);
                                    $('#scanned-result').text(`Error: ${err.message}`).css('color', 'red');
                                }
                            });
                            
                            $('#camera-status').text(`Using ${cameraLabel} camera`);
                        })
                        .catch(err => {
                            console.error('Camera error:', err);
                            $('#scanned-result').text(`Camera error: ${err.message}`).css('color', 'red');
                        });
                }
                
                function stopCamera() {
                    scanningActive = false;
                    if (codeReader) {
                        try {
                            codeReader.reset();
                            // Stop video tracks without removing elements
                            const videoElement = document.getElementById('camera-video');
                            if (videoElement && videoElement.srcObject) {
                                const tracks = videoElement.srcObject.getTracks();
                                tracks.forEach(track => track.stop());
                                videoElement.srcObject = null;
                            }
                            codeReader = null;
                        } catch (e) {
                            console.warn('Error stopping camera:', e);
                        }
                    }
                    
                    // Clear scanned result but preserve overlay
                    $('#scanned-result').text('');
                }
                
                function handleScannedCode(code) {
                    // Validate EAN code
                    if (!/^\d{8,13}$/.test(code)) {
                        $('#scanned-result').html(`<strong>Invalid barcode:</strong> ${code}<br>Only EAN-8/EAN-13 supported`)
                            .css('color', 'orange');
                        return;
                    }

                    // Close modal and process
                    cameraModal.hide();
                    stopCamera();
                    
                    // Set search field value
                    $('#food-search').val(code);
                    
                    // Highlight the search field
                    $('#food-search').addClass('highlight-search');
                    setTimeout(() => $('#food-search').removeClass('highlight-search'), 3000);
                    
                    // Trigger search
                    setTimeout(() => {
                        $('#food-search').focus();
                        const query = $('#food-search').val().trim();
                        if (query.length > 0) {
                            performFoodSearch(query);
                        }
                    }, 100);
                }
    
                function performFoodSearch(query) {
                    // Cancel previous request if it's still pending
                    if (currentSearchRequest) {
                        currentSearchRequest.abort();
                    }
                    
                    // Show loading indicator
                    $('#search-results').html('<div class="text-center p-2 small">Searching...</div>');
                    
                    currentSearchRequest = $.post('/search_foods', { query }, data => {
                        let resultsHtml = '';
                        const seenIds = new Set();
                        
                        if (data && data.length > 0) {
                            resultsHtml = '<div class="list-group">';
                            
                            data.forEach(food => {
                                if (!seenIds.has(food.id)) {
                                    seenIds.add(food.id);
                                    resultsHtml += createFoodItemHtml(food);
                                }
                            });
                            
                            resultsHtml += '</div>';
                            
                            if (seenIds.size === 0) {
                                resultsHtml = '<div class="text-center p-2 small">No results found</div>';
                            }
                            
                            // AUTO-SELECT THE FIRST RESULT AFTER RENDERING
                            setTimeout(() => {
                                if ($('.food-item').length > 0) {
                                    $('.food-item:first').trigger('click');
                                }
                            }, 300);
                        } else {
                            // Handle EAN barcode case
                            if (/^\d{8,13}$/.test(query)) {
                                resultsHtml = `
                                    <div id="ean-alert" 
                                        class="alert alert-warning alert-dismissible fade show text-center p-2 small" 
                                        role="alert">
                                        <span data-i18n="ean_not_found">Barcode</span> <strong>${query}</strong> <span data-i18n="in_data_base">not found in database</span><br>
                                        <button id="create-custom-food" class="btn portion-btn btn-primary mt-2" data-i18n="create_new_food">
                                            Create New Food
                                        </button>
                                    </div>
                                `;
                            } else {
                                resultsHtml = '<div class="text-center p-2 small">No results found</div>';
                            }
                        }
                        
                        $('#search-results').html(resultsHtml);
                        
                        // Attach event handler for creating custom food
                        $('#create-custom-food').off('click').on('click', () => {
                            window.location.href = '/custom_food?ean=' + encodeURIComponent(query);
                        });
                    }).fail(function(xhr, status) {
                        if (status !== 'abort') {
                            $('#search-results').html('<div class="text-center p-2 small">Search failed. Please try again.</div>');
                        }
                    }).always(function() {
                        currentSearchRequest = null;
                    });
                }
                // TOAST SYSTEM 
            function showToast(message, type = 'success') {
                const toastId = 'toast-' + Date.now();
                const icons = {
                    success: 'fa-check-circle',
                    error: 'fa-times-circle',
                    warning: 'fa-exclamation-triangle',
                    info: 'fa-info-circle'
                };

                const toastHtml = `
                    <div id="${toastId}" class="toast toast-${type}" role="alert" aria-live="assertive" aria-atomic="true" data-bs-delay="3500">
                        <div class="toast-body">
                            <i class="fas ${icons[type] || icons.info}"></i>
                            <span>${message}</span>
                            <button type="button" class="btn-close btn-close-white ms-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                        </div>
                    </div>
                `;

                const container = document.querySelector('.toast-container');
                container.insertAdjacentHTML('beforeend', toastHtml);

                const toastEl = document.getElementById(toastId);
                const bsToast = new bootstrap.Toast(toastEl);
                bsToast.show();

                toastEl.addEventListener('hidden.bs.toast', () => toastEl.remove());
            }
                // ===== INITIALIZE THE APP =====
                initializeApp();
            });
        </script>
    <script>
    // Initialize tooltips globally
    document.addEventListener("DOMContentLoaded", function () {
        const tooltipTriggerList = [].slice.call(
        document.querySelectorAll('[data-bs-toggle="tooltip"]')
        )
        tooltipTriggerList.map(el => new bootstrap.Tooltip(el))
    })
    </script>
    <div class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 2000">
</div>
<script>
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('/sw.js')
      .then((registration) => {
        console.log('ServiceWorker registered:', registration.scope);
      })
      .catch((error) => {
        console.log('ServiceWorker registration failed:', error);
      });
  });
}
</script>
    </body>
    </html>
