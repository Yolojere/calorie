<script>
    const current_user_role = "{{ current_user_role }}";
</script>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Workout Tracker</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Calibri&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
    /* ===== CSS VARIABLES ===== */
    :root {
        --group-color: #f78fb3; /* Default, overridden by specific classes */
        --bg-primary: #161616;
        --bg-secondary: #1d1d1d;
        --bg-tertiary: #222;
        --text-primary: #e0e0e0;
        --text-secondary: #aaa;
        --border-color: #444;
        --accent-color: #6dc0d5;
        --danger-color: #ff6b6b;
        --success-color: #7bc8a4;
    }

    /* ===== BASE STYLES ===== */
    body {
        font-family: 'Roboto', sans-serif;
        font-size: 12px;
        background-color: var(--bg-primary) !important;
        color: var(--text-primary);
    }

    /* ===== LAYOUT & CONTAINERS ===== */
    .workout-container {
        max-width: 1200px;
        margin: 20px auto;
        padding: 0 15px;
        padding-bottom: 70px;
    }

    .workout-header {
        background: linear-gradient(to right, #000, #222);
        border-radius: 8px;
        padding: 15px 20px;
        margin-bottom: 20px;
        border-bottom: 2px solid var(--border-color);
    }

    #workout-session-container, 
    #workout-session-container-mobile { 
        min-height: 200px; 
        height: auto;
        overflow: visible;
        padding-bottom: 70px;
    }

    /* ===== TYPOGRAPHY & TEXT ===== */
    .group-title {
        font-weight: bold;
        font-size: 16px;
        text-transform: uppercase;
        letter-spacing: 1px;
        color: white;
        text-shadow: 0 1px 3px rgba(0,0,0,0.3);
        min-width: 0;
    }

    .exercise-title {
        font-weight: bold;
        font-size: 14px;
        color: #f0f0f0;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        flex-shrink: 1;
        min-width: 0;
    }

    .exercise-summary-text {
        font-size: 12px !important;
        font-weight: bold !important;
        color: var(--text-secondary);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        flex-shrink: 0;
    }

    .summary-item {
        background: rgba(255, 255, 255, 0.15);
        padding: 2px 8px;
        border-radius: 12px;
        font-weight: bold;
        color: white;
        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        font-size: 12px;
    }

    .volume-display {
        height: 100%;
        align-items: center;
        text-align: center;
        font-weight: bold;
        color: #ffffff;
        padding-right: 12px;
        font-size: clamp(12px, 1.5vw, 14px);
        min-width: 60px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        font-size: 12px;
    }

    /* ===== FORM ELEMENTS ===== */
    .form-control, .form-select {
        background-color: #333;
        color: var(--text-primary);
        border: 1px solid #555;
        font-size: 14px;
        padding: 6px 8px;
        height: 36px;
    }

    .form-control:focus, .form-select:focus {
        background-color: #707070;
        color: #ffffff;
        border-color: #d1d1d1;
    }

    .set-input {
        width: 90%;
        height: 24px;
        padding: 0 4px;
        font-size: 11px;
        background-color: #444;
        border: 1px solid #666;
        color: white;
        text-align: center;
        margin: 0 auto;
    }

    .set-input:focus {
        background-color: #b4b4b4 !important;
        color: #000 !important;
        border-color: #d1d1d1 !important;
    }

    .invalid-input {
        border: 2px solid #ff5252 !important;
        background-color: #442222 !important;
        animation: shake 0.5s;
    }

    @keyframes shake {
        0%, 100% { transform: translateX(0); }
        20%, 60% { transform: translateX(-3px); }
        40%, 80% { transform: translateX(3px); }
    }

    /* ===== BUTTONS & CONTROLS ===== */
    .btn-jere {
        display: inline-block;
        background-color: #1b1b1b;
        color: #ffffff;
        border: 1px solid var(--border-color);
        border-radius: 20px;
        padding: 8px 12px;
        font-size: 12px;
        font-weight: 600;
        transition: all 0.1s ease;
    }

    .btn-jere:hover, .btn-jere:focus {
        background-color: #d4d4d4 !important;
        color: black !important;
        transform: scale(1.02);
    }

    .btn-jere.active {
        background: #858585 !important;
        color: #000000 !important;
    }

    .nav-link-box, .mobile-settings-btn {
             display: inline-block;
            background-color: #1b1b1b;
            color: #ffffff;
            border: 1px solid #444 !important;
            border-radius: 20px;
            padding: 15px !important;
            margin: 0 3px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 45px;
            height: 45px;
    }

    .nav-link-box:hover, .mobile-settings-btn:hover {
        background-color: #f0f0f0 !important;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            color: black !important;
    }

    .nav-link-box i, .mobile-settings-btn i {
        font-size: 17px;
        margin: 0;
    }

    .toggle-icon {
        background: none !important;
        border: none !important;
        color: #d0d0d0 !important;
        padding: 0 !important;
        width: 24px;
        height: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 14px;
        transition: all 0.2s ease;
        margin-left: 12px;
        cursor: pointer;
    }

    .toggle-icon:hover {
        color: #ffffff !important;
        transform: scale(1.15);
    }

    .toggle-icon i {
        transition: transform 0.2s ease;
    }

    .delete-item {
        background: rgba(255, 255, 255, 0.1) !important;
        border: 1px solid var(--border-color) !important;
        color: #ffffff !important;
        padding: 0;
        width: 24px;
        height: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 14px;
        transition: all 0.3s ease;
        border-radius: 4px;
        opacity: 0.7;
    }

    .delete-item i {
        color: var(--danger-color);
        font-size: 14px;
    }

    .delete-item:hover {
        color: #ff0000 !important;
        transform: scale(1.1);
        opacity: 1;
        background-color: rgba(255, 0, 0, 0.1) !important;
    }

    /* ===== CARDS & MODALS ===== */
    .card, .list-group-item, .modal-content {
        background-color: var(--bg-secondary);
        color: var(--text-primary);
        border: 1px solid var(--border-color);
    }

    .bg-black, .modal-header, .modal-footer {
         background-color: #0c0c0c !important;
            border-color: #444;
            }

    /* ===== TABLES ===== */
    .workout-table {
        width: 100%;
        border-collapse: collapse;
        border-spacing: 0 5px;
        table-layout: fixed;
        display: table !important;
        width: 100% !important;
        table-layout: fixed !important;
        border: 1px solid var(--border-color);
    }

    .workout-table th {
        vertical-align: middle !important;
        background-color: #000;
        font-size: 12 !important;
        padding: 6px 4px !important;
        text-align: center !important;
        top: 0;
        z-index: 10;
        height: 2px !important;
    }

    .workout-table td {
        text-align: center;
        padding: 4px;
        border: 1px solid #000000;
        vertical-align: middle;
        background-color: var(--bg-tertiary);
        color: var(--text-primary);
        height:36px;
    }
    .workout-table tr {
        height: 0px !important;
    }

    .workout-table tr, .workout-table td, .workout-table th {
        border: none !important;
        outline: none !important;
        box-shadow: none !important;
        vertical-align: middle !important;
        text-align: center !important;
        padding: 8px 4px !important;
    }


    .workout-table tbody tr:nth-child(odd) {
        background-color: #1a1a1a;
    }

    .workout-table tbody tr:last-child {
        border-bottom: none;
    }

    .workout-table tbody tr:hover {
        background-color: #2d2d2d;
        transform: translateY(-1px);
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .workout-table tbody tr, .workout-table tbody td {
        background: none !important;
    }

    .workout-table thead th:last-child {
        background-color: #000;
        color: transparent;
        position:relative;
    }

    .workout-table thead th:last-child::after {
        content: "\f142";
        font-family: "Font Awesome 5 Free";
        font-weight: 900;
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        color: var(--text-primary);
        font-size: 14px;
    }
    /* Complete exercise dropdown styles */
        .complete-exercise-dropdown {
            position: relative;
            display: inline-block;
            margin-right: 8px;
            z-index: 9998 !important;
        }

        .complete-exercise-icon {
            background: none;
            border: none;
            color: #d0d0d0;
            padding: 4px;
            cursor: pointer;
            border-radius: 3px;
            transition: all 0.2s ease;
        }

        .complete-exercise-icon:hover {
            color: #ffffff;
            background-color: rgba(255, 255, 255, 0.1);
        }

        .complete-exercise-icon i.completed {
            color: var(--success-color);
        }

        .complete-exercise-options {
            display: none;
            position: relative;
            background-color: #333;
            min-width: 140px;
            box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.5);
            z-index: 9999;
            border-radius: 5px;
            overflow: hidden;
            border: 1px solid #555;
            bottom: 100%;
            left: 0;
            margin-bottom: 5px;
        }

        .complete-option {
            color: var(--text-primary);
            padding: 8px 12px;
            text-decoration: none;
            display: block;
            cursor: pointer;
            text-align: left;
            border-bottom: 1px solid #444;
            font-size: 12px;
            z-index: 9999;
        }

        .complete-option:last-child {
            border-bottom: none;
        }

        .complete-option:hover {
            background-color: var(--accent-color);
            color: #fff;
        }

        .exercise-header.completed {
            background: rgba(32, 126, 82, 0.774) !important;
            
        }

        /* Adjust exercise header to accommodate new icon */
        .exercise-header-content {
            display: flex;
            align-items: center;
        }
    /* Column widths */
    .workout-table th:nth-child(1), .workout-table td:nth-child(1) { width: 25%; }
    .workout-table th:nth-child(2), .workout-table td:nth-child(2) { width: 20%; }
    .workout-table th:nth-child(3), .workout-table td:nth-child(3) { width: 20%; }
    .workout-table th:nth-child(4), .workout-table td:nth-child(4) { width: 25%; }
    .workout-table th:nth-child(5), .workout-table td:nth-child(5) { width: 10%; }

    /* ===== WORKOUT GROUP & EXERCISE STYLES ===== */
    /* Muscle Group Colors */
    .chest { --group-color: #f78fb3; }
    .back { --group-color: #6dc0d5; }
    .legs { --group-color: #b989f0; }
    .shoulders { --group-color: #ffd166; }
    .arms { --group-color: #7bc8a4; }
    .core { --group-color: #ff9e6d; }

    /* Group and Exercise Headers */
    .exercise-header, .group-header {
        -webkit-touch-callout: none;
        -webkit-user-select: none;
        -khtml-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        user-select: none;
        -webkit-tap-highlight-color: transparent;
        padding: 6px 8px !important;
        background: rgba(50, 50, 50, 0.7);
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.1s ease;
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-bottom: none !important;
        margin-bottom: 4px;
        width: 100%;
        flex-wrap: nowrap;
        gap: 2px;
    }

    .exercise-header-content {
        display: flex;
        align-items: center;
        flex: 1;
        min-width: 0;
        overflow: hidden;
        gap: 2px;
    }

    .exercise-header.expanded {
        background: color-mix(in srgb, var(--group-color) 50%, black);
        box-shadow: 0 2px 4px rgba(255, 255, 255, 0.1);
    }

    .exercise {
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        margin-bottom: 4px;
        padding-bottom: 4px;
    }
    .exercise:last-child {
        border-bottom: none;
        margin-bottom: 0;
        padding-bottom: 0;
    }

    .workout-group .group-header {
        background: linear-gradient(135deg, var(--group-color), rgba(0,0,0,0.8)) !important;
        padding: 12px 15px !important;
        border-radius: 8px 8px 0 0 !important;
        margin: 8px 0 0 0 !important;
        border: none !important;
        position: relative;
        z-index: 1;
    }

    .workout-group .group-header:hover {
        filter: brightness(1.15);
        box-shadow: 0 0 10px rgba(255,255,255,0.5);
        z-index: 2;
        border: px solid var(--group-color) !important;
        color: black;
        font-weight: bold;
    }

    .group-icon {
        border: 2px solid var(--group-color);
        box-shadow: 0 3px 6px rgba(0,0,0,0.2) inset, 0 0 0 1px rgba(0,0,0,0.3);
        flex-shrink: 0;
        width: 32px;
        height: 32px;
        background: rgba(255, 255, 255, 0.2);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 8px;
        font-size: 16px;
        color: white;
    }

    .group-items {
        background-color: var(--bg-tertiary);
        padding: 8px 10px;
        border-left: 3px solid var(--group-color);
        border-right: 3px solid var(--group-color);
        border-bottom: 3px solid var(--group-color);
        border-radius: 0 0 2px 2px;
        margin-bottom: 0;
    }

    .group-summary {
        display: flex;
        font-size: 11px;
        margin-left: auto;
        flex-direction: row !important;
        margin-left: 0;
        align-items: center;
        font: 11 px !important;
    }

    .group-actions {
        display: flex;
        align-items: center;
        gap: 2px;
    }

    .exercise-info {
        display: flex;
        align-items: center;
        gap: 15px;
        justify-content: space-between;
        min-width: 0;
        margin-top: 8px;
        flex: 1;
        flex-direction: row !important;
        justify-content: space-between !important;
        width: auto !important;
        margin-top: 0 !important;
        flex: 0 0 auto;
    }

    .set-number-cell {
        display:table-cell;
        align-items: center !important;
        justify-content: center !important;
        height: 100% !important;
        padding: 0 4px;
     }

    .set-details {
        display: flex;
        align-items: center;
        justify-content: center;
        margin-top: 2px;
        font-size: 12px;
        width: 100%;
        margin-top: 0 !important;
        margin-left: 6px;
        flex-wrap: nowrap;
    }
    .set-details > * {
        margin-right: 4px;
    }
    .actions-cell {
    background-color: var(--bg-tertiary) !important;
    padding: 0 !important;
    text-align: center;     /* horizontally center content */
    vertical-align: middle; /* vertically center content */
    }

    /* ===== BADGES & INDICATORS ===== */
    .rir-badge {
        display: inline-block;
        background-color: #8a2be2;
        color: white;
        padding: 1px 4px;
        border-radius: 2px;
        font-size: 10px;
        font-weight: bold;
        margin-right: 3px;
        white-space: nowrap;
        cursor: pointer;
        margin-bottom: 0;
    }

    .comment-icon {
        color: #dfdbdb;
        cursor: pointer;
        font-size: 14px;
        transition: all 0.3s ease;
    }

    .comment-icon:hover {
        color: #ffffff;
        transform: scale(1.2);
    }

    .fa-spinner {
        color: #4CAF50;
        font-size: 16px;
    }

    /* ===== TOOLTIPS ===== */
    .tooltip-inner {
        max-width: 250px;
        white-space: normal;
        word-wrap: break-word;
        text-align: left;
        padding: 8px 12px;
        background-color: #333 !important;
        color: #fff !important;
        border: 1px solid #555 !important;
        border-radius: 6px !important;
    }

    .tooltip.bs-tooltip-top .tooltip-arrow::before, 
    .tooltip.bs-tooltip-bottom .tooltip-arrow::before,
    .tooltip.bs-tooltip-start .tooltip-arrow::before, 
    .tooltip.bs-tooltip-end .tooltip-arrow::before {
        border-color: #555;
    }

    /* ===== DROPDOWNS & MODALS ===== */
    .rir-dropdown {
        position: relative;
        display: inline-block;
        z-index: 1;
    }

    .rir-options {
        display: none;
        position: absolute;
        background-color: #333;
        min-width: 80px;
        box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.5);
        z-index: 9999 !important;
        border-radius: 5px;
        overflow: visible;
        border: 1px solid #555;
        bottom: 100%;
        left: 50%;
        transform: translateX(-50%);
        margin-bottom: 5px;
    }

    .rir-option {
        color: var(--text-primary);
        padding: 8px 12px;
        text-decoration: none;
        display: block;
        cursor: pointer;
        text-align: center;
        border-bottom: 1px solid #444;
    }

    .rir-option:last-child {
        border-bottom: none;
    }

    .rir-option:hover {
        background-color: var(--accent-color);
        color: #fff;
    }

    .comment-tooltip {
        display: none;
        position: absolute;
        background-color: #333;
        padding: 15px;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.5);
        z-index: 1050;
        width: 250px;
        border: 1px solid #555;
    }

    .comment-tooltip textarea {
        width: 100%;
        background-color: #2a2a2a;
        border: 1px solid #555;
        color: var(--text-primary);
        border-radius: 5px;
        padding: 8px;
        margin-bottom: 10px;
        resize: vertical;
    }

    .comment-tooltip button {
        display: inline-block;
        background-color: #1b1b1b;
        color: #ffffff;
        border: 1px solid var(--border-color) !important;
        border-radius: 20px;
        padding: 8px 12px;
        font-size: 10px;
        font-weight: 600;
        transition: all 0.3s ease;
        cursor: pointer;
    }

    .ready-controls {
        display: flex;
        gap: 8px;
        margin-left: 10px;
        position: absolute;
        right: 10px;
        top: 50%;
        transform: translateY(-50%);
    }

    /* ===== MOBILE TOGGLE SECTIONS ===== */
    .mobile-toggle-section {
        margin-bottom: 15px;
        border: 1px solid var(--border-color);
        border-radius: 8px;
        overflow: hidden;
    }

    .mobile-toggle-header {
        background: linear-gradient(to right, #000, #222);
        padding: 12px 15px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        cursor: pointer;
        border-bottom: 1px solid var(--border-color);
    }

    .mobile-toggle-header h5 {
        margin: 0;
        font-size: 16px;
        color: var(--text-primary);
    }

    .mobile-toggle-content {
        padding: 15px;
        background-color: var(--bg-secondary);
    }

    .mobile-toggle-header .toggle-arrow {
        transition: transform 0.3s ease;
    }

    .mobile-toggle-header.collapsed .toggle-arrow {
        transform: rotate(180deg);
    }

    /* ===== MEDIA QUERIES ===== */
    @media (min-width: 768px) {
        #copy-workout-mobile-btn {
            position: absolute !important;
            bottom: 15px;
            left: 50%;
            transform: translateX(-50%);
            width: 90%;
            max-width: 200px;
            z-index: 5;
            margin: 0 !important;
        }
        
        .grid-add-set, .grid-log { 
            width: 100%; 
            margin-bottom: 15px; 
        }
        .grid-log {
            display: block !important; 
            max-height: calc(100vh - 150px);
            padding: 15px;
            overflow-y: auto !important;
            height: auto !important;
            min-height: 200px;
            }

        
        /* Desktop only comment tooltip */
        .comment-tooltip {
            position: absolute;
            top: 0;
            left: 0;
            width: 250px;
            transform: none;
        }
        
        .comment-tooltip.show {
            display: block;
        }
    }

    @media (max-width: 768px) {
        .workout-grid-container { 
            display: block !important; 
            padding: 15px;
            overflow-y: auto !important;
            height: auto !important;
            min-height: 200px;
 }
        
        #workout-log-tab .card-body {    
            position: relative;
            padding-bottom: 2px !important;
        }
        
        #workout-log-tab .group-title { 
            font-size: 13px !important; 
        }
        
        #workout-log-tab .exercise-title {
            font-size: 13px;
        }
        
        #workout-log-tab .workout-table th, 
        #workout-log-tab .workout-table td { 
            font-size: 11px; 
        }
        
        #workout-log-tab .summary-item, 
        #workout-log-tab .exercise-summary-text, 
        #workout-log-tab .set-details { 
            font-size: 11px; 
        }
        
        #workout-log-tab .rir-badge { 
            font-size: 10px; 
        }
        
        .mobile-date-header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            padding: 10px 15px; 
        }
        
        #copyWorkoutModal .modal-content { 
            background-color: #1b1b1b; 
            color: #ffffff; 
            border: 1px solid var(--border-color) !important; 
            border-radius: 20px; 
            padding: 8px 12px; 
            font-size: 12px; 
            font-weight: 600; 
            transition: all 0.3s ease; 
        }
        
        #copyWorkoutModal .modal-header { 
            border-bottom: 1px solid var(--border-color); 
        }
        
        #copyWorkoutModal .modal-footer { 
            border-top: 1px solid var(--border-color); 
        }
        
        #date-selection-container { 
            display: grid; 
            grid-template-columns: repeat(3, 1fr); 
            gap: 10px; 
            margin-top: 15px; 
        }
        
        .copy-date-btn { 
            background-color: #1b1b1b; 
            color: #ffffff; 
            border: 1px solid var(--border-color) !important; 
            border-radius: 20px; 
            padding: 8px 12px; 
            font-size: 12px; 
            font-weight: 600; 
            transition: all 0.3s ease; 
        }
        
        .copy-date-btn:hover:not(.disabled) { 
            background-color: var(--border-color) !important; 
            border-color: var(--accent-color) !important; 
            transform: translateY(-2px); 
            box-shadow: 0 2px 8px rgba(109, 192, 213, 0.4); 
        }
        
        .copy-date-btn:active:not(.disabled) { 
            transform: translateY(0); 
        }
        
        .copy-date-btn.disabled { 
            background-color: #1a1a1a !important; 
            color: #777 !important; 
            border-color: #333 !important; 
            cursor: not-allowed; 
            opacity: 0.7; 
        }
        
        #copy-workout-mobile-btn-container {
            position: fixed;
            bottom: 80px;
            left: 0; 
            right: 0;
            padding: 10px 15px;
            background: linear-gradient(to top, var(--bg-primary) 60%, transparent); 
            z-index: 100;
            display: flex;
            justify-content: center;
        }
        
        .dropdown-menu { 
            max-height: 300px; 
            overflow-y: auto; 
        }
        
        .workout-group .group-items { 
            padding: 15px 0; 
            border-left: none !important; 
            border-right: none !important; 
            border-bottom: none !important; 
        }
        
        .group-items { 
            padding-left: 0; 
            padding-right: 0; 
            border-left: none; 
            border-right: none; 
        }
        
        .workout-group .group-header {
            padding: 10px 15px !important;
            justify-content: space-between; 
            align-items: center;
            flex-direction: row; 
            display: flex;
            min-width: 0;
        }
        
        .group-header-content { 
            display: flex; 
            align-items: center; 
            flex: 1; 
            min-width: 0;
            overflow: hidden; 
        }
        
        .group-header, .exercise-header {
            overflow: hidden;
        }
        
        .exercise-header {
            padding: 6px 8px !important;
            
        }
        
        .exercise-header > * { 
            flex-shrink: 0;   
        }
        
        .group-title {
            font-size: 14px !important;
            white-space: nowrap;
            overflow: hidden; 
            text-align: right; 
        }
        
        .group-title, .exercise-title {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            transition: font-size 0.1s ease;
        }
        
        .workout-group .group-header:hover, 
        .exercise-header:hover { 
            border: none !important; 
            box-shadow: none !important; 
            filter: none !important; 
        }
        
        /* Mobile positioning for tooltips */
        .comment-tooltip { 
            position: fixed !important; 
            transform: translate(-50%, -50%) !important; 
            top: 50% !important; 
            left: 50% !important; 
            width: 80%; 
        }
        
        .rir-options { 
            position: fixed !important; 
            bottom: unset; 
            top: 50% !important; 
            left: 50% !important; 
            transform: translate(-80%, -50%) !important; 
            width: 40%; 
            max-width: 150px; 
            
        }
        
        
        /* FIX: Remove fixed positioning for mobile copy button */
        #copy-workout-mobile-btn {
            position: static !important;
            margin: 15px auto !important;
            width: 90% !important;
            max-width: 200px !important;
            transform: none !important;
            box-shadow: 0 2px 10px rgba(0,0,0,0.5) !important;
        }
        
        /* FIX: Adjust header toggle buttons for mobile */
        .workout-header .d-flex.justify-content-center {
            flex-wrap: wrap;
            justify-content: center !important;
        }

        .workout-header .btn-outline-secondary {
            flex: 0 0 auto;
            min-width: 40px;
            padding: 4px 6px;
            font-size: 11px;
        }
        
        .exercise-header .ready-controls { 
            position: static; 
            transform: none; 
            margin-left: auto; 
            padding-left: 0px; 
        }
    }

    /* ===== UTILITY CLASSES ===== */
</style>
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-black">
        <div class="container">
            <a class="navbar-brand" href="/" style="font-size: 26px;">Track You</a>
            <a class="navbar-brand d-none d-md-inline" href="/" style="font-size: 15px;color: #ffffff; ">
                - Track, lift, repeat -
            </a>
            
            <!-- Mobile Settings Dropdown -->
            <div class="ms-auto d-block d-lg-none position-static d-flex align-items-center">
                <button class="mobile-settings-btn" data-bs-toggle="dropdown" aria-expanded="false">
                    <i class="bi bi-wrench-adjustable"></i>
                </button>
                <ul class="dropdown-menu dropdown-menu-end" 
                    aria-labelledby="navbarDropdownMobile"
                    style="position: absolute; background-color: #222; border: 1px solid #ffffff; border-radius: 5px; z-index: 1050; right: 15px; left: auto;">
                    <li>
                        <a class="dropdown-item" href="/" style="color: #e0e0e0; padding: 8px 15px;">
                            <i class="fa-solid fa-house-chimney-window me-2"></i>Home
                        </a>
                    </li>
                    <li>
                        <a class="dropdown-item" href="{{ url_for('workout') }}" style="color: #e0e0e0; padding: 8px 15px;">
                            <i class="fas fa-dumbbell me-2"></i>Workouts
                        </a>
                    </li>
                    <li>
                        <a class="dropdown-item" href="/history" style="color: #e0e0e0; padding: 8px 15px;">
                            <i class="fas fa-chart-pie me-2"></i>History
                        </a>
                    </li>
                    <li>
                        <a class="dropdown-item" href="{{ url_for('activity') }}" style="color: #e0e0e0; padding: 8px 15px;">
                            <i class="fas fa-fire me-2"></i>Activity
                        </a>
                    </li>
                    <li>
                        <a class="dropdown-item" href="/custom_food" style="color: #e0e0e0; padding: 8px 15px;">
                            <i class="fas fa-file-circle-plus me-2"></i>Add Food
                        </a>
                    </li>
                    <li>
                        <a class="dropdown-item" href="{{ url_for('profile') }}" style="color: #e0e0e0; padding: 8px 15px; border-bottom: 1px solid #444;">
                            <i class="fas fa-user-circle me-2"></i>Profile
                        </a>
                    </li>
                    <li>
                        <a class="dropdown-item" href="{{ url_for('logout') }}" style="color: #e0e0e0; padding: 8px 15px;">
                            <i class="fas fa-sign-out-alt me-2"></i>Logout
                        </a>
                    </li>
                </ul>
            </div>
            
            <!-- Desktop Navigation -->
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link home-link nav-link-box" href="/" data-bs-toggle="tooltip" data-bs-placement="bottom" title="Home">
                            <i class="fa-solid fa-house-chimney-window"></i>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link workout-link nav-link-box" href="{{ url_for('workout') }}" data-bs-toggle="tooltip" data-bs-placement="bottom" title="Workouts">
                            <i class="fa-solid fa-dumbbell"></i>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link add-link nav-link-box" href="/custom_food" data-bs-toggle="tooltip" data-bs-placement="bottom" title="Add Food">
                            <i class="fa-solid fa-file-circle-plus"></i>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link history-link nav-link-box" href="/history" data-bs-toggle="tooltip" data-bs-placement="bottom" title="History">
                            <i class="fa-solid fa-chart-pie"></i>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link nav-link-box" href="/activity" data-bs-toggle="tooltip" data-bs-placement="bottom" title="Activity">
                            <i class="fas fa-fire"></i>
                        </a>
                    </li>
                    
                    {% if current_user.is_authenticated %}
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle nav-link-box" href="#" id="navbarDropdownDesktop" role="button" data-bs-toggle="dropdown" aria-expanded="false" data-bs-toggle="tooltip" data-bs-placement="bottom" title="Settings" style="position: relative;">
                            <i class="bi bi-wrench-adjustable"></i>
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="navbarDropdownDesktop" style="background-color: #222; border: 1px solid #ffffff; border-radius: 5px;">
                            <li>
                                <a class="dropdown-item" href="{{ url_for('profile') }}" style="color: #e0e0e0; padding: 8px 15px; border-bottom: 1px solid #444;">
                                    <i class="fas fa-user-circle me-2"></i>Profile
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item" href="{{ url_for('logout') }}" style="color: #e0e0e0; padding: 8px 15px;">
                                    <i class="fas fa-sign-out-alt me-2"></i>Logout
                                </a>
                            </li>
                        </ul>
                    </li>
                    {% endif %}
                </ul>
            </div>
        </div>
    </nav>

    <div class="workout-container">
        <!-- Workout Tracker Header -->
        <div class="workout-header d-none d-md-block">
            <div class="d-flex justify-content-between align-items-center">
                <h2>Workout Tracker</h2>
                <div>
                    <button id="prev-week-btn" class="btn btn-sm btn-secondary me-2">
                        <i class="fas fa-arrow-left me-1"></i> Prev
                    </button>
                    <span id="week-display" class="fw-bold">Loading...</span>
                    <button id="next-week-btn" class="btn btn-sm btn-secondary ms-2">
                        Next <i class="fas fa-arrow-right ms-1"></i>
                    </button>
                </div>
            </div>
            
            <!-- Week dates -->
            <div class="d-flex justify-content-center mt-3" id="week-dates-container">
                <!-- Dates will be populated by JavaScript -->
            </div>
        </div>
        
        <!-- Desktop and Mobile Layout -->
        <div class="workout-grid-container">
            <!-- Add Set Panel -->
            <div class="grid-add-set">
                <!-- Toggle button for mobile -->
                <div class="mobile-toggle-section d-md-none">
                    <div class="mobile-toggle-header" data-bs-toggle="collapse" data-bs-target="#add-set-body" aria-expanded="false">
                        <h5>Add New Set</h5>
                        <span class="toggle-arrow"><i class="fas fa-chevron-down"></i></span>
                    </div>
                    
                    <div class="mobile-toggle-content collapse" id="add-set-body">
                        <!-- Add set form content -->
                        <div class="row g-3">
                            <div class="col-12">
                                <label class="form-label">Muscle Group</label>
                                <select id="muscle-group-select-mobile" class="form-select">
                                    <option value="Chest">Chest</option>
                                    <option value="Back">Back</option>
                                    <option value="Legs">Legs</option>
                                    <option value="Shoulders">Shoulders</option>
                                    <option value="Arms">Arms</option>
                                    <option value="Core">Core</option>
                                </select>
                            </div>
                            <div class="col-12">
                                <label class="form-label">Exercise</label>
                                <div class="input-group">
                                    <select id="exercise-select-mobile" class="form-select">
                                        <!-- Populated by JavaScript -->
                                    </select>
                                    <button class="btn btn-outline-secondary" type="button" data-bs-toggle="modal" data-bs-target="#addExerciseModal">
                                        <i class="fas fa-plus"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="col-4">
                                <label class="form-label">Sets</label>
                                <select id="sets-input-mobile" class="form-select">
                                    <option value="1">1</option>
                                    <option value="2">2</option>
                                    <option value="3">3</option>
                                    <option value="4">4</option>
                                    <option value="5">5</option>
                                    <option value="6">6</option>
                                    <option value="7">7</option>
                                    <option value="8">8</option>
                                    <option value="9">9</option>
                                    <option value="10">10</option>
                                </select>
                            </div>
                            <div class="col-4">
                                <label class="form-label">Reps</label>
                                <input type="number" id="reps-input-mobile" class="form-control" min="1" value="">
                            </div>
                            <div class="col-4">
                                <label class="form-label">Weight (kg)</label>
                                <input type="number" id="weight-input-mobile" class="form-control" min="0.5" step="0.5" value="">
                            </div>
                        </div>
                        <div class="row g-3 mt-2">
                            <div class="col-12">
                                <label class="form-label">RiR (Reps in Reserve)</label>
                                <select id="rir-input-mobile" class="form-select">
                                    <option value="">None</option>
                                    <option value="Failure">Failure (0 RiR)</option>
                                    <option value="1">1</option>
                                    <option value="2">2</option>
                                    <option value="3">3</option>
                                    <option value="4">4</option>
                                    <option value="5">5</option>
                                    <option value="6">6</option>
                                    <option value="7">7</option>
                                    <option value="8">8</option>
                                    <option value="9">9</option>
                                    <option value="10">10</option>
                                </select>
                            </div>
                            <div class="col-12">
                                <label class="form-label">Comments</label>
                                <input type="text" id="comments-input-mobile" class="form-control" placeholder="Optional notes about the set">
                            </div>
                            <div class="col-12 d-flex align-items-end">
                                <button id="save-set-btn-mobile" class="btn btn-success w-100">
                                    <i class="fas fa-plus me-1"></i> Add Set
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="card d-none d-md-block">
                    <div class="card-header">
                        <h5>Add New Set</h5>
                    </div>
                    
                    <div class="card-body">
                        <!-- Add set form content -->
                        <div class="row g-3">
                            <div class="col-md-3">
                                <label class="form-label">Muscle Group</label>
                                <select id="muscle-group-select" class="form-select">
                                    <option value="Chest">Chest</option>
                                    <option value="Back">Back</option>
                                    <option value="Legs">Legs</option>
                                    <option value="Shoulders">Shoulders</option>
                                    <option value="Arms">Arms</option>
                                    <option value="Core">Core</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Exercise</label>
                                <div class="input-group">
                                    <select id="exercise-select" class="form-select">
                                        <!-- Populated by JavaScript -->
                                    </select>
                                    <button class="btn btn-outline-secondary" type="button" data-bs-toggle="modal" data-bs-target="#addExerciseModal">
                                        <i class="fas fa-plus"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <label class="form-label">Sets</label>
                                <select id="sets-input" class="form-select">
                                    <option value="1">1</option>
                                    <option value="2">2</option>
                                    <option value="3">3</option>
                                    <option value="4">4</option>
                                    <option value="5">5</option>
                                    <option value="6">6</option>
                                    <option value="7">7</option>
                                    <option value="8">8</option>
                                    <option value="9">9</option>
                                    <option value="10">10</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <label class="form-label">Reps</label>
                                <input type="number" id="reps-input" class="form-control" min="1" value="">
                            </div>
                            <div class="col-md-2">
                                <label class="form-label">Weight (kg)</label>
                                <input type="number" id="weight-input" class="form-control" min="0.5" step="0.5" value="">
                            </div>
                        </div>
                        <div class="row g-3 mt-2">
                            <div class="col-md-3">
                                <label class="form-label">RiR (Reps in Reserve)</label>
                                <select id="rir-input" class="form-select">
                                    <option value="">None</option>
                                    <option value="Failure">Failure (0 RiR)</option>
                                    <option value="1">1</option>
                                    <option value="2">2</option>
                                    <option value="3">3</option>
                                    <option value="4">4</option>
                                    <option value="5">5</option>
                                    <option value="6">6</option>
                                    <option value="7">7</option>
                                    <option value="8">8</option>
                                    <option value="9">9</option>
                                    <option value="10">10</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Comments</label>
                                <input type="text" id="comments-input" class="form-control" placeholder="Optional notes about the set">
                            </div>
                            <div class="col-md-3 d-flex align-items-end">
                                <button id="save-set-btn" class="btn btn-success w-100">
                                    <i class="fas fa-plus me-1"></i> Add Set
                                </button>
                            </div>
                        </div>
                        
                        <!-- Extras section for desktop -->
                        <div class="row mt-3 d-none d-md-block">
                            <div class="col-12">
                                <div class="dropdown">
                                    <button class="btn btn-primary dropdown-toggle w-100" type="button" id="templateDropdown" data-bs-toggle="dropdown">
                                        <i class="fas fa-clipboard-list me-1"></i> Apply Template
                                    </button>
                                    {% if current_user_role == 'admin' %}
                                    <div class="col-12 mt-2">
                                        <button class="btn btn-info w-100" id="save-template-btn">
                                            <i class="fas fa-save me-1"></i> Save Template
                                        </button>
                                    </div>
                                    {% endif %}
                                    <ul class="dropdown-menu dropdown-menu-end w-100" id="template-list-desktop">
                                        <li><a class="dropdown-item" href="#">Loading templates...</a></li>
                                    </ul>
                                </div>
                            </div>
                            <div class="col-12 mt-2">
                                <button class="btn btn-secondary w-100" id="copy-workout-btn">
                                    <i class="fas fa-copy me-1"></i> Copy Workout
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Extras section for mobile -->
                <div class="mobile-toggle-section d-md-none mt-3">
                    <div class="mobile-toggle-header collapsed" data-bs-toggle="collapse" data-bs-target="#extras-body" aria-expanded="false">
                        <h5>Extras</h5>
                        <span class="toggle-arrow"><i class="fas fa-chevron-down"></i></span>
                    </div>
                    
                    <div class="mobile-toggle-content collapse" id="extras-body">
                        <div class="extras-buttons">
                            <div class="dropdown mb-2">
                                <button class="btn btn-primary extras-btn w-100" type="button" id="templateDropdownMobile" data-bs-toggle="dropdown">
                                    <i class="fas fa-clipboard-list me-1"></i> Apply Template
                                </button>
                                {% if current_user_role == 'admin' %}
                                <button class="btn btn-info extras-btn w-100 mt-2" id="save-template-mobile-btn">
                                    <i class="fas fa-save me-1"></i> Save Template
                                </button>
                                {% endif %}
                                <ul class="dropdown-menu dropdown-menu-end w-100" id="template-list-mobile">
                                    <li><a class="dropdown-item" href="#">Loading templates...</a></li>
                                </ul>
                            </div>
                            <button class="btn btn-secondary extras-btn w-100" id="copy-workout-mobile-btn">
                                <i class="fas fa-copy me-1"></i> Copy Workout
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Workout Session Container -->
            <div class="grid-log">
                <div class="card">
                    <!-- Card Header -->
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">Workout Log</h5>
                        
                        <!-- Mobile-only date selector with spacing -->
                        <div class="d-block d-lg-none ms-2">
                            <select id="mobile-date-selector" class="form-select bg-dark text-light border-secondary" style="font-size: 14px; width: auto; min-width: 140px; max-width: 180px;">
                                <!-- Dates will be populated here -->
                            </select>
                        </div>
                    </div>

                    <!-- Card Body -->
                    <div class="card-body p-0">
                        <div id="workout-session-container" class="p-2">
                            <!-- Initial loading message -->
                            <div class="text-center py-4 text-muted">
                                <i class="fas fa-spinner fa-spin me-2"></i> Loading workout data...
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Exercise Modal -->
    <div class="modal fade" id="addExerciseModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-black">
                    <h5 class="modal-title">Add New Exercise</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form>
                        <div class="mb-3">
                            <label class="form-label">Exercise Name</label>
                            <input type="text" id="new-exercise-name" class="form-control" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Muscle Group</label>
                            <select id="new-muscle-group" class="form-select" required>
                                <option value="Chest">Chest</option>
                                <option value="Back">Back</option>
                                <option value="Legs">Legs</option>
                                <option value="Shoulders">Shoulders</option>
                                <option value="Arms">Arms</option>
                                <option value="Core">Core</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Description (Optional)</label>
                            <textarea id="new-exercise-desc" class="form-control" rows="3"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer bg-black">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button id="save-exercise-btn" type="button" class="btn btn-primary">Save Exercise</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Template Preview Modal -->
    <div class="modal fade" id="templatePreviewModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-black">
                    <h5 class="modal-title">Template Preview: <span id="template-preview-name"></span></h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <table class="table table-dark">
                        <thead>
                            <tr>
                                <th>Exercise</th>
                                <th>Muscle Group</th>
                                <th>Reps</th>
                                <th>Weight</th>
                            </tr>
                        </thead>
                        <tbody id="template-preview-body">
                            <!-- Preview will be populated here -->
                        </tbody>
                    </table>
                </div>
                <div class="modal-footer bg-black">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="apply-template-btn">Apply Template</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Copy Workout Modal -->
    <div class="modal fade" id="copyWorkoutModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-black">
                    <h5 class="modal-title">Copy Workout</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>Copy current workout to:</p>
                    <div class="d-flex flex-wrap" id="date-selection-container">
                        <!-- Dates will be populated here -->
                    </div>
                </div>
                <div class="modal-footer bg-black">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Comment Tooltip (hidden by default) -->
    <div class="comment-tooltip" id="comment-tooltip">
        <textarea placeholder="Add your comment here..." rows="3"></textarea>
        <button id="save-comment-btn">Save Comment</button>
    </div>
    
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Global variables
        let isApplyingTemplate = false;
        let currentSelectedDate = new Date().toISOString().split('T')[0];
        let currentDate = new Date();
        let exercises = [];
        let collapseState = {
            groups: {},
            exercises: {}
        };
        let savedScrollPosition = { desktop: 0, mobile: 0 };
        let currentCommentSetId = null;
        // Store completed exercises state
        let completedExercises = {};

        // Initialize workout page
        $(document).ready(function() {
            loadCollapseState();
            loadCurrentWeek();
            loadExercises();
            setupEventListeners();
            initTooltips();
            loadTemplates();
            setupMobileDateSelector();
            populateMobileDateSelector(new Date().toISOString().split('T')[0]);
            
            // Set initial date display
            const weekDates = getWeekDates(new Date());
            renderWeekDates(weekDates);
            loadWorkoutSession(currentSelectedDate);
            
            // Setup RiR and comment functionality
            setupRirDropdowns();
            setupCommentTooltips();
            // Setup exercise completion functionality
            setupExerciseCompletion();
            attachTemplateEventHandlers();
        });

        // ===== INITIALIZATION FUNCTIONS =====
        function loadCollapseState() {
            const savedState = localStorage.getItem('workoutCollapseState');
            if (savedState) {
                collapseState = JSON.parse(savedState);
            }
            
            // Load completed exercises state
            const savedCompleted = localStorage.getItem('completedExercises');
            if (savedCompleted) {
                completedExercises = JSON.parse(savedCompleted);
            }
        }
        
        function saveCollapseState() {
            localStorage.setItem('workoutCollapseState', JSON.stringify(collapseState));
            localStorage.setItem('completedExercises', JSON.stringify(completedExercises));
        }
        
        function initTooltips() {
            // Initialize Bootstrap tooltips
            $('[data-bs-toggle="tooltip"]').tooltip();
            
            // Mobile-specific tooltip tap handling
            $('body').on('touchstart', '.comment-icon', function(e) {
                e.stopPropagation();
                e.preventDefault();

                // Hide all others first
                $('.comment-icon').not(this).tooltip('hide');
                $(this).tooltip('show');

                // Auto-hide after 10s
                setTimeout(() => {
                    $(this).tooltip('hide');
                }, 10000);
            });

            // Hide tooltips when clicking/tapping elsewhere
            $(document).on('touchstart click', function(e) {
                if (!$(e.target).hasClass('comment-icon') && 
                    !$(e.target).closest('.tooltip').length) {
                    $('.comment-icon').tooltip('hide');
                }
            });
        }

        
        function setupEventListeners() {
            // Setup muscle group change listener
            $("#muscle-group-select, #muscle-group-select-mobile").change(renderExerciseOptions);
            
            // Save set listeners
            $("#save-set-btn").click(() => saveSet(false));
            $("#save-set-btn-mobile").click(() => saveSet(true));
            
            // Add exercise
            $("#save-exercise-btn").click(addExercise);
            
            // Week navigation
            $("#prev-week-btn").click(() => navigateWeek('prev'));
            $("#next-week-btn").click(() => navigateWeek('next'));
            
            // Enter key submit
            $("#comments-input, #comments-input-mobile").keypress(function(e) {
                if (e.which === 13) {
                    saveSet($(this).attr('id') === 'comments-input-mobile');
                }
            });

            // Template handling
            $("#save-template-btn").click(saveTemplate);
            $("#apply-template-btn").click(function() {
                const templateId = $(this).data('template-id');
                applyTemplate(templateId);
                const modal = bootstrap.Modal.getInstance(document.getElementById('templatePreviewModal'));
                if (modal) modal.hide();
            });
            $(document).on("click", ".template-item", function(e) {
                e.preventDefault();
                previewTemplate($(this).data('id'));
            });
    
            
            // Copy workout
            $("#copy-workout-btn, #copy-workout-mobile-btn").click(function() {
                populateDateOptions();
                $("#copyWorkoutModal").modal("show");
            });
            
            $(document).on("click", ".date-option", function() {
                copyWorkoutToDate($(this).data("date"));
            });
            
            // Admin-only events
            if (current_user_role === 'admin') {
                $("#save-template-btn").click(saveTemplate);
                $("#save-template-mobile-btn").click(saveTemplate);
            }
        }
        
        function setupRirDropdowns() {
            // Hide dropdown when clicking elsewhere
            $(document).click(function() {
                $('.rir-options').hide();
                $('.complete-exercise-options').hide();
            });
            
            // RiR badge click
            $(document).on('click', '.rir-badge', function(e) {
                e.stopPropagation();
                // Hide any other open dropdowns
                $('.rir-options').hide();
                $('.complete-exercise-options').hide();
                
                // Show this dropdown
                $(this).siblings('.rir-options').toggle();
            });
            
            // RiR option selection
            $(document).on('click', '.rir-option', function(e) {
                e.stopPropagation();
                const value = $(this).data('value');
                const badge = $(this).closest('.rir-dropdown').find('.rir-badge');
                const setId = $(this).closest('.set-row').data('set-id');
                
                // Update badge text
                if (value === 'Failure') {
                    badge.text('Failure');
                } else {
                    badge.text(value + ' RiR');
                }
                
                // Hide dropdown
                $(this).closest('.rir-options').hide();
                
                // Update the RiR value in the database
                updateRir(setId, value);
            });
        }
        // Reattach when workout content changes (for mobile/desktop switching)
        $(document).on('workoutContentChanged', function() {
            attachTemplateEventHandlers();
        });

        function setupExerciseCompletion() {
            // Complete exercise icon click
            $(document).on('click', '.complete-exercise-icon', function(e) {
                e.stopPropagation();
                // Hide any other open dropdowns
                $('.rir-options').hide();
                
                // Show this dropdown
                $(this).siblings('.complete-exercise-options').toggle();
            });
            
            // Complete option selection
            $(document).on('click', '.complete-option', function(e) {
                e.stopPropagation();
                const value = $(this).data('value');
                const exerciseId = $(this).closest('.exercise').data('exercise-id');
                const groupName = $(this).closest('.workout-group').data('group');
                const date = $(".workout-date.active").data("date");
                
                // Update completed state
                if (value === 'yes') {
                    markExerciseCompleted(exerciseId, groupName, date);
                } else {
                    markExerciseNotCompleted(exerciseId, groupName, date);
                }
                
                // Hide dropdown
                $(this).closest('.complete-exercise-options').hide();
            });
        }
        
        function markExerciseCompleted(exerciseId, groupName, date) {
            // Store completed state
            if (!completedExercises[date]) completedExercises[date] = {};
            completedExercises[date][exerciseId] = true;
            
            // Update UI
            const $exercise = $(`.exercise[data-exercise-id="${exerciseId}"]`);
            $exercise.find('.exercise-header').addClass('completed');
            $exercise.find('.complete-exercise-icon i').addClass('completed');
            
            // Move to end of group
            const $groupItems = $exercise.closest('.group-items');
            $exercise.detach().appendTo($groupItems);
            
            // Save state
            saveCollapseState();
            
            // Collapse the exercise
            const exerciseCollapsed = collapseState.exercises[date] && collapseState.exercises[date][exerciseId];
            if (!exerciseCollapsed) {
                $exercise.find('.toggle-exercise').click();
            }
            
            // Send to server
            $.post("/workout/mark_exercise_completed", {
                exercise_id: exerciseId,
                date: date,
                completed: true
            }, function(response) {
                if (!response.success) {
                    console.error('Error updating exercise completion status');
                }
            });
        }
        
        function markExerciseNotCompleted(exerciseId, groupName, date) {
            // Remove completed state
            if (completedExercises[date] && completedExercises[date][exerciseId]) {
                delete completedExercises[date][exerciseId];
            }
            
            // Update UI
            const $exercise = $(`.exercise[data-exercise-id="${exerciseId}"]`);
            $exercise.find('.exercise-header').removeClass('completed');
            $exercise.find('.complete-exercise-icon i').removeClass('completed');
            
            // Move back to original position (first in group)
            const $groupItems = $exercise.closest('.group-items');
            const $firstExercise = $groupItems.find('.exercise').first();
            
            if ($firstExercise.length && !$firstExercise.is($exercise)) {
                $exercise.detach().insertBefore($firstExercise);
            }
            
            // Save state
            saveCollapseState();
            
            // Send to server
            $.post("/workout/mark_exercise_completed", {
                exercise_id: exerciseId,
                date: date,
                completed: false
            }, function(response) {
                if (!response.success) {
                    console.error('Error updating exercise completion status');
                }
            });
        }
        
        function setupCommentTooltips() {
            // Comment icon click
            $(document).on('click', '.comment-icon', function(e) {
                e.stopPropagation();
                const tooltip = $('#comment-tooltip');
                const comment = $(this).data('comment') || '';
                const textarea = tooltip.find('textarea');
                
                // Set current comment
                textarea.val(comment);
                
                // Position tooltip near the cursor on desktop, centered on mobile
                if ($(window).width() > 768) {
                    tooltip.css({
                        top: e.pageY - tooltip.outerHeight() - 10,
                        left: e.pageX - (tooltip.outerWidth() / 2)
                    });
                } else {
                    tooltip.css({
                        top: '50%',
                        left: '50%',
                        transform: 'translate(-50%, -50%)'
                    });
                }
                
                // Show tooltip
                tooltip.show();
                textarea.focus();
            });
        
            // Save comment
            $('#save-comment-btn').click(function() {
                const tooltip = $('#comment-tooltip');
                const textarea = tooltip.find('textarea');
                const comment = textarea.val();
                
                // Update icon appearance based on whether there's a comment
                if (comment) {
                    $('.comment-icon').removeClass('far').addClass('fas');
                    $('.comment-icon').data('comment', comment);
                } else {
                    $('.comment-icon').removeClass('fas').addClass('far');
                    $('.comment-icon').data('comment', '');
                }
                
                // Hide tooltip
                tooltip.hide();
            });
        
            // Hide comment tooltip when clicking outside
            $(document).click(function(e) {
                if (!$(e.target).closest('.comment-icon, #comment-tooltip').length) {
                    $('#comment-tooltip').hide();
                }
            });
            
            // Prevent comment tooltip from closing when clicking inside it
            $('#comment-tooltip').click(function(e) {
                e.stopPropagation();
            });
        }
        
        function setupMobileDateSelector() {
            // Initialize with today
            populateMobileDateSelector(currentSelectedDate);
            
            $("#mobile-date-selector").change(function() {
                const selectedDate = $(this).val();
                currentSelectedDate = selectedDate;
                loadWorkoutSession(selectedDate);
                
                // Regenerate options with new center
                populateMobileDateSelector(selectedDate);
            });
        }

        // ===== DATA LOADING FUNCTIONS =====
        function loadCurrentWeek() {
            $.get("/workout/get_current_week", function(data) {
                currentSelectedDate = data.current_date;
                renderWeekDates(data.dates);
                loadWorkoutSession(currentSelectedDate);
            });
        }
        
        function loadExercises() {
            $.get("/workout/get_exercises", function(data) {
                exercises = data.exercises;
                renderExerciseOptions();
            });
        }
        
        function loadWorkoutSession(date) {
            saveScrollPosition(); // Save before loading new data
            
            $("#workout-session-container").html(
                '<div class="text-center py-4"><i class="fas fa-spinner fa-spin fa-2x"></i></div>'
            );
            
            $.post("/workout/get_session", { date: date }, function(data) {
                renderWorkoutSession(data.session, data.exercises);
                initTooltips();
                
                // Restore scroll position after rendering
                setTimeout(restoreScrollPosition, 100);
            });
        }
        
        function loadTemplates() {
    $.get("/workout/templates", function(data) {
        const $templateListDesktop = $("#template-list-desktop");
        const $templateListMobile = $("#template-list-mobile");
        $templateListDesktop.empty();
        $templateListMobile.empty();
        
        if (data.templates && data.templates.length > 0) {
            data.templates.forEach(template => {
                const item = `
                    <li><a class="dropdown-item template-item" href="#" 
                           data-id="${template.id}">${template.name}</a></li>
                `;
                $templateListDesktop.append(item);
                $templateListMobile.append(item);
            });
            
            // Reattach event handlers after populating the lists
            attachTemplateEventHandlers();
        } else {
            const noItem = '<li><a class="dropdown-item" href="#">No templates found</a></li>';
            $templateListDesktop.append(noItem);
            $templateListMobile.append(noItem);
        }
    })
    .fail(function() {
        const errorItem = '<li><a class="dropdown-item" href="#">Error loading templates</a></li>';
        $("#template-list-desktop").html(errorItem);
        $("#template-list-mobile").html(errorItem);
    });
}
// Add this function to properly attach event handlers
function attachTemplateEventHandlers() {
    // Remove any existing handlers to prevent duplication
    $(".template-item").off('click');
    
    // Attach new handlers
    $(".template-item").on('click', function(e) {
        e.preventDefault();
        previewTemplate($(this).data('id'));
    });
}

        // ===== RENDERING FUNCTIONS =====
        function renderWeekDates(dates) {
            const container = $("#week-dates-container");
            container.empty();
            
            dates.forEach(date => {
                const dateObj = new Date(date);
                const dayName = dateObj.toLocaleDateString('en-US', { weekday: 'short' });
                const dayNumber = dateObj.getDate();
                const isToday = date === new Date().toISOString().split('T')[0];
                
                const dateElement = `
                    <div class="workout-date btn btn-outline-secondary mx-1 ${isToday ? 'active' : ''}" 
                         data-date="${date}">
                        <div>${dayName}</div>
                        <div class="fw-bold">${dayNumber}</div>
                    </div>
                `;
                container.append(dateElement);
            });
            
            // Add click event to dates
            $(".workout-date").click(function() {
                $(".workout-date").removeClass("active");
                $(this).addClass("active");
                currentSelectedDate = $(this).data("date");
                loadWorkoutSession($(this).data("date"));
            });
            
            // Update week display
            const start = new Date(dates[0]);
            const end = new Date(dates[6]);
            const weekDisplay = `Week ${getWeekNumber(start)}: ${formatDate(start)} - ${formatDate(end)}`;
            $("#week-display").text(weekDisplay);
        }
        
        function renderExerciseOptions() {
            const muscleGroup = $("#muscle-group-select").val();
            const select = $("#exercise-select");
            const currentExercise = select.val();
            
            const muscleGroupMobile = $("#muscle-group-select-mobile").val();
            const selectMobile = $("#exercise-select-mobile");
            const currentExerciseMobile = selectMobile.val();
            
            // Clear both selects
            select.empty();
            selectMobile.empty();
            
            // Filter exercises by muscle group and populate both selects
            exercises
                .filter(ex => ex.muscle_group === muscleGroup)
                .forEach(exercise => {
                    select.append(`<option value="${exercise.id}">${exercise.name}</option>`);
                });
                
            exercises
                .filter(ex => ex.muscle_group === muscleGroupMobile)
                .forEach(exercise => {
                    selectMobile.append(`<option value="${exercise.id}">${exercise.name}</option>`);
                });
            
            // Restore previous selections if they still exist
            if (currentExercise && select.find(`option[value="${currentExercise}"]`).length) {
                select.val(currentExercise);
            }
            
            if (currentExerciseMobile && selectMobile.find(`option[value="${currentExerciseMobile}"]`).length) {
                selectMobile.val(currentExerciseMobile);
            }
        }
        
        function renderWorkoutSession(session, exercises) {
            const container = $("#workout-session-container");
            container.empty();
            
            if (!session || !exercises || exercises.length === 0) {
                const message = `
                    <div class="alert alert-info">
                        No workout recorded for this day. Add your first set below!
                    </div>
                `;
                container.html(message);
                return;
            }
            
            // Get current date for state tracking
            const currentDate = $(".workout-date.active").data("date");
            
            // Initialize state for current date if needed
            if (!collapseState.groups[currentDate]) {
                collapseState.groups[currentDate] = {};
            }
            if (!collapseState.exercises[currentDate]) {
                collapseState.exercises[currentDate] = {};
            }
            
            // Group exercises by muscle group
            const groups = {};
            exercises.forEach(exercise => {
                const group = exercise.muscle_group;
                if (!groups[group]) {
                    groups[group] = {
                        exercises: [],
                        totalSets: 0,
                        totalReps: 0,
                        totalVolume: 0
                    };
                }

                // Calculate exercise totals
                const exerciseVolume = exercise.sets.reduce((sum, set) => sum + set.volume, 0);
                const exerciseSets = exercise.sets.length;
                const exerciseReps = exercise.sets.reduce((sum, set) => sum + set.reps, 0);

                groups[group].exercises.push({...exercise, exerciseVolume, exerciseSets, exerciseReps});
                groups[group].totalSets += exerciseSets;
                groups[group].totalReps += exerciseReps;
                groups[group].totalVolume += exerciseVolume;
            });

            // Apply template collapse if needed
            if (isApplyingTemplate) {
                for (const groupName in groups) {
                    collapseState.groups[currentDate][groupName] = { collapsed: true };
                    groups[groupName].exercises.forEach(exercise => {
                        collapseState.exercises[currentDate][exercise.id] = true;
                    });
                }
                saveCollapseState();
                isApplyingTemplate = false;
            }

            // Render session
            let sessionHTML = '';

            for (const groupName in groups) {
                // Ensure group state exists
                if (!collapseState.groups[currentDate][groupName]) {
                    collapseState.groups[currentDate][groupName] = { collapsed: false };
                }

                const groupData = groups[groupName];
                const groupState = collapseState.groups[currentDate][groupName];
                const groupCollapsed = groupState.collapsed;

                let groupBlock = `
                    <div class="workout-group ${groupName.toLowerCase()}" data-group="${groupName}">
                        <div class="group-header">
                            <div class="d-flex align-items-center">
                                <div class="group-icon">
                                    <i class="fas fa-${getMuscleIcon(groupName)}"></i>
                                </div>
                                <span class="group-title">${groupName}</span>
                            </div>
                            <div class="d-flex align-items-center">
                                <div class="group-summary">
                                    <span class="summary-item">${groupData.totalSets} sets</span>
                                    <span class="summary-item">${groupData.totalVolume.toFixed(1)} kg</span>
                                </div>
                                <div class="group-actions">
                                    <button class="toggle-icon toggle-group" title="${groupCollapsed ? 'Expand' : 'Collapse'}">
                                        <i class="fas fa-${groupCollapsed ? 'plus' : 'minus'}"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="group-items" style="${groupCollapsed ? 'display: none;' : ''}">
                `;

                // Sort exercises: completed ones last
                groupData.exercises.sort((a, b) => {
                    const aCompleted = completedExercises[currentDate] && completedExercises[currentDate][a.id];
                    const bCompleted = completedExercises[currentDate] && completedExercises[currentDate][b.id];
                    
                    if (aCompleted && !bCompleted) return 1;
                    if (!aCompleted && bCompleted) return -1;
                    return 0;
                });

                // Render exercises
                groupData.exercises.forEach(exercise => {
                    const exerciseCollapsed = collapseState.exercises[currentDate][exercise.id] || false;
                    const expandedClass = exerciseCollapsed ? '' : 'expanded';
                    const isCompleted = completedExercises[currentDate] && completedExercises[currentDate][exercise.id];
                    const completedClass = isCompleted ? 'completed' : '';

                    groupBlock += `
                        <div class="exercise" data-exercise-id="${exercise.id}">
                            <div class="exercise-header ${expandedClass} ${completedClass}">
                                <div class="exercise-header-content">
                                    <div class="complete-exercise-dropdown">
                                        <button class="complete-exercise-icon">
                                            <i class="fas fa-check ${isCompleted ? 'completed' : ''}"></i>
                                        </button>
                                        <div class="complete-exercise-options">
                                            <div class="complete-option" data-value="yes">Yes</div>
                                            <div class="complete-option" data-value="no">No</div>
                                        </div>
                                    </div>
                                    <div class="exercise-title">${exercise.name}</div>
                                </div>
                                <div class="exercise-info">
                                    <div class="exercise-summary-text">
                                        ${exercise.exerciseSets} sets, ${exercise.exerciseVolume.toFixed(1)} kg
                                    </div>
                                    <button class="toggle-icon toggle-exercise" title="${exerciseCollapsed ? 'Expand' : 'Collapse'}">
                                        <i class="fas fa-${exerciseCollapsed ? 'plus' : 'minus'}"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="exercise-sets" style="${exerciseCollapsed ? 'display: none;' : ''}">
                                <table class="workout-table">
                                    <thead>
                                        <tr>
                                            <th class="text-center">Set</th>
                                            <th class="text-center">Reps</th>
                                            <th class="text-center">Weight</th>
                                            <th class="text-center">Volume</th>
                                            <th class="text-center">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                    `;

                    exercise.sets.forEach((set, index) => {
                        let rirDisplay = '';
                        if (set.rir !== null && set.rir !== undefined && set.rir !== "") {
                            let rirText = (set.rir === -1 || set.rir === "Failure" || set.rir === 0) ? 'Failure' : `${set.rir} RiR`;
                            rirDisplay = `
                                <div class="rir-dropdown">
                                    <span class="rir-badge">${rirText}</span>
                                    <div class="rir-options">
                                        <div class="rir-option" data-value="Failure">Failure</div>
                                        <div class="rir-option" data-value="1">1 RiR</div>
                                        <div class="rir-option" data-value="2">2 RiR</div>
                                        <div class="rir-option" data-value="3">3 RiR</div>
                                        <div class="rir-option" data-value="4">4 RiR</div>
                                        <div class="rir-option" data-value="5">5 RiR</div>
                                    </div>
                                </div>
                            `;
                        } else {
                            // If no RiR is set, show "None" and allow setting it
                            rirDisplay = `
                                <div class="rir-dropdown">
                                    <span class="rir-badge">None</span>
                                    <div class="rir-options">
                                        <div class="rir-option" data-value="Failure">Failure</div>
                                        <div class="rir-option" data-value="1">1 RiR</div>
                                        <div class="rir-option" data-value="2">2 RiR</div>
                                        <div class="rir-option" data-value="3">3 RiR</div>
                                        <div class="rir-option" data-value="4">4 RiR</div>
                                        <div class="rir-option" data-value="5">5 RiR</div>
                                    </div>
                                </div>
                            `;
                        }

                        const commentIcon = set.comments ? 
                            `<i class="fas fa-comment comment-icon" data-comment="${set.comments.replace(/"/g, '&quot;')}"></i>` :
                            `<i class="far fa-comment comment-icon" data-comment=""></i>`;

                        groupBlock += `
                            <tr class="set-row" data-set-id="${set.id}">
                                <td class="set-number-cell">
                                    <div class="d-flex align-items-center">
                                        <div class="me-2">${index + 1}</div>
                                        <div class="set-details">
                                            ${rirDisplay}
                                            ${commentIcon}
                                        </div>
                                    </div>
                                </td>
                                <td>
                                    <input type="number" class="form-control set-reps set-input" 
                                        value="${set.reps}" data-original="${set.reps}">
                                </td>
                                <td>
                                    <input type="number" class="form-control set-weight set-input" 
                                        value="${set.weight}" data-original="${set.weight}" step="0.5">
                                </td>
                                <td class="volume-display">${set.volume.toFixed(1)}</td>
                                <td class="actions-cell">
                                    <button class="btn delete-item">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </td>
                            </tr>
                        `;
                    });

                    groupBlock += `
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    `;
                });

                groupBlock += `
                        </div>
                    </div>
                `;

                sessionHTML += groupBlock;
            }

            container.html(sessionHTML);
            initTooltips();
            setTimeout(initTooltips, 100);
            
            // Setup the RiR dropdowns and comment tooltips
            setupRirDropdowns();
            setupCommentTooltips();
            setupExerciseCompletion();

            // Apply initial expanded class
            $(".exercise").each(function() {
                const exerciseId = $(this).data("exercise-id");
                const currentDate = $(".workout-date.active").data("date");
                const isCollapsed = collapseState.exercises[currentDate]?.[exerciseId] || false;
                const header = $(this).find(".exercise-header");
                if (!isCollapsed) {
                    header.addClass("expanded");
                }
            });

            // Group toggle
            $(".toggle-group").click(function() {
                const groupHeader = $(this).closest(".group-header");
                const groupContainer = groupHeader.closest(".workout-group");
                const groupItems = groupContainer.find(".group-items");
                const isExpanded = groupItems.is(":visible");
                const groupName = groupContainer.data("group");
                const currentDate = $(".workout-date.active").data("date");

                groupItems.toggle(!isExpanded);
                $(this).html(`<i class="fas fa-${isExpanded ? 'plus' : 'minus'}"></i>`);
                $(this).attr('title', isExpanded ? 'Expand' : 'Collapse');

                collapseState.groups[currentDate][groupName].collapsed = isExpanded;
                saveCollapseState();
            });

            // Exercise toggle
            $(".toggle-exercise").click(function() {
                const exerciseHeader = $(this).closest(".exercise-header");
                const exerciseContainer = exerciseHeader.closest(".exercise");
                const exerciseId = exerciseContainer.data("exercise-id");
                const exerciseSets = exerciseContainer.find(".exercise-sets");
                const isExpanded = exerciseSets.is(":visible");
                const currentDate = $(".workout-date.active").data("date");

                exerciseSets.toggle(!isExpanded);
                $(this).html(`<i class="fas fa-${isExpanded ? 'plus' : 'minus'}"></i>`);
                $(this).attr('title', isExpanded ? 'Expand' : 'Collapse');

                if (isExpanded) {
                    exerciseHeader.removeClass("expanded");
                } else {
                    exerciseHeader.addClass("expanded");
                }

                collapseState.exercises[currentDate][exerciseId] = isExpanded;
                saveCollapseState();
            });
            
            $(document).trigger('workoutContentChanged');
            $(document).trigger('workoutRendered');
        }
        
        function populateDateOptions() {
            const container = $("#date-selection-container");
            container.empty();
            
            const today = new Date();
            const currentDate = new Date(currentSelectedDate);
            
            for (let i = 0; i < 7; i++) {
                const date = new Date();
                date.setDate(today.getDate() + i);
                const dateString = date.toISOString().split('T')[0];
                const formattedDate = date.toLocaleDateString('en-US', { 
                    weekday: 'short', 
                    month: 'short', 
                    day: 'numeric' 
                });
                
                const isCurrent = dateString === currentDate.toISOString().split('T')[0];
                
                container.append(`
                    <div class="date-option btn btn-dark m-1 border-secondary ${isCurrent ? 'disabled' : ''}"
                         data-date="${dateString}"
                         ${isCurrent ? 'disabled' : ''}>
                        ${formattedDate}
                    </div>
                `);
            }
        }
        
        function populateMobileDateSelector(selectedDate) {
            const $selector = $("#mobile-date-selector");
            const dates = generateDateOptions(selectedDate);
            
            $selector.empty();
            dates.forEach(d => {
                const selected = d.date === selectedDate;
                $selector.append(`<option value="${d.date}" ${selected ? 'selected' : ''}>${d.formatted}</option>`);
            });
        }

        // ===== DATA OPERATION FUNCTIONS =====
        function saveSet(isMobile = false) {
            const repsInput = isMobile ? $("#reps-input-mobile") : $("#reps-input");
            const weightInput = isMobile ? $("#weight-input-mobile") : $("#weight-input");
            
            saveScrollPosition();
            
            const exerciseId = isMobile ? $("#exercise-select-mobile").val() : $("#exercise-select").val();
            const reps = isMobile ? $("#reps-input-mobile").val() : $("#reps-input").val();
            const weight = isMobile ? $("#weight-input-mobile").val() : $("#weight-input").val();
            const muscleGroup = isMobile ? $("#muscle-group-select-mobile").val() : $("#muscle-group-select").val();
            const setsCount = isMobile ? $("#sets-input-mobile").val() : $("#sets-input").val();
            const rirRaw = isMobile ? $("#rir-input-mobile").val() : $("#rir-input").val();
            const comments = isMobile ? $("#comments-input-mobile").val() : $("#comments-input").val();
            const date = $(".workout-date.active").data("date");
            const rir = rirRaw === "Failure" ? -1 : 
                   (rirRaw === "" ? null : Number(rirRaw));
            
            $.post("/workout/save_set", {
                date: date,
                exercise_id: exerciseId,
                reps: reps,
                weight: weight,
                muscle_group: muscleGroup,
                sets_count: setsCount,
                rir: rir,
                comments: comments
            }, function(response) {
                if (response.success) {
                    loadWorkoutSession(date);
                    resetSetForm(isMobile);
                } else {
                    alert("Error: " + response.error);
                }
            });
        }
        
        function deleteSet(setId, $button) {
            saveScrollPosition(); // Save before making changes
            
            $.post("/workout/delete_set", { set_id: setId }, function(response) {
                if (response.success) {
                    const date = $(".workout-date.active").data("date");
                    loadWorkoutSession(date);
                } else {
                    alert("Error: " + response.error);
                    $button.prop('disabled', false).html('<i class="fas fa-trash"></i>');
                }
            }).fail(function() {
                alert("Network error. Please try again.");
                $button.prop('disabled', false).html('<i class="fas fa-trash"></i>');
            });
        }
        
        function addExercise() {
            const name = $("#new-exercise-name").val();
            const muscleGroup = $("#new-muscle-group").val();
            const description = $("#new-exercise-desc").val();
            
            // Validate input
            if (!name || !muscleGroup) {
                alert("Exercise name and muscle group are required!");
                return;
            }
            
            $.post("/workout/add_exercise", {
                name: name,
                muscle_group: muscleGroup,
                description: description
            }, function(response) {
                if (response.success) {
                    loadExercises();
                    $("#addExerciseModal").modal("hide");
                    resetExerciseForm();
                    alert("Exercise added successfully!");
                } else {
                    alert("Error: " + response.error);
                }
            }).fail(function() {
                alert("Network error. Please try again.");
            });
        }
        
        function updateRir(setId, rirValue) {
            $.ajax({
                url: "/workout/update_rir",
                method: "POST",
                contentType: "application/json",
                data: JSON.stringify({ set_id: setId, rir: rirValue }),
                success: function(response) {
                    if (!response.success) {
                        alert('Error updating RiR');
                        loadWorkoutSession(currentSelectedDate);
                    }
                }
            });
        }
        
        function updateComment(setId, comment) {
            $.ajax({
                url: "/workout/update_comment",
                method: "POST",
                contentType: "application/json",
                data: JSON.stringify({ set_id: setId, comment: comment }),
                success: function(response) {
                    if (!response.success) {
                        alert('Error updating comment');
                        loadWorkoutSession(currentSelectedDate);
                    }
                }
            });
        }
        
        function saveTemplate() {
            const templateName = prompt("Enter a name for this template:");
            if (!templateName) return;
            
            const $btn = $("#save-template-btn");
            const originalContent = $btn.html();
            $btn.html('<i class="fas fa-spinner fa-spin me-1"></i> Saving...');
            $btn.prop('disabled', true);
            
            const currentDate = $(".workout-date.active").data("date");
            
            // Send as form data
            const formData = new FormData();
            formData.append('name', templateName);
            formData.append('date', currentDate);
            
            fetch("/workout/save_template", {
                method: "POST",
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                $btn.html(originalContent);
                $btn.prop('disabled', false);
                
                if (data.success) {
                    alert("Template saved successfully!");
                    loadTemplates();
                } else {
                    alert("Error: " + data.error);
                }
            })
            .catch(error => {
                $btn.html(originalContent);
                $btn.prop('disabled', false);
                alert("Error: " + error.message);
            });
        }
        
        function previewTemplate(templateId) {
    // Show loading state
    $("#template-preview-body").html(
        '<tr><td colspan="4" class="text-center py-3">' +
        '<i class="fas fa-spinner fa-spin me-2"></i>Loading template...' +
        '</td></tr>'
    );
    
    $("#templatePreviewModal").modal('show');
    
    fetch(`/workout/templates/${templateId}`)
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            $("#template-preview-name").text(data.template.name);
            const $previewBody = $("#template-preview-body");
            $previewBody.empty();
            
            if (data.exercises && data.exercises.length > 0) {
                data.exercises.forEach(ex => {
                    $previewBody.append(`
                        <tr>
                            <td>${ex.name}</td>
                            <td>${ex.muscle_group}</td>
                            <td>${ex.reps}</td>
                            <td>${ex.weight} kg</td>
                        </tr>
                    `);
                });
            } else {
                $previewBody.append(
                    '<tr><td colspan="4" class="text-center py-3">No exercises in this template</td></tr>'
                );
            }
            
            // Store template ID on the button
            $("#apply-template-btn").data('template-id', templateId);
        } else {
            alert("Error: " + (data.error || "Template not found"));
            $("#templatePreviewModal").modal('hide');
        }
    })
    .catch(error => {
        alert("Error loading template: " + error.message);
        $("#templatePreviewModal").modal('hide');
    });
}
        
         function applyTemplate(templateId) {
    const currentDate = $(".workout-date.active").data("date");
    isApplyingTemplate = true; // Set flag before loading session
    
    // Send as JSON instead of form data
    $.ajax({
        url: "/workout/apply_template",
        method: "POST",
        contentType: "application/json",
        data: JSON.stringify({
            template_id: templateId,
            date: currentDate
        }),
        success: function(response) {
            if (response.success) {
                $("#templatePreviewModal").modal('hide');
                loadWorkoutSession(currentDate);
            } else {
                alert("Error: " + (response.error || "Failed to apply template"));
                isApplyingTemplate = false; // Reset flag on failure
            }
        },
        error: function(xhr, status, error) {
            alert("Network error. Please try again.");
            isApplyingTemplate = false; // Reset flag on failure
            console.error("Error applying template:", error);
        }
    });
}
        
        function copyWorkoutToDate(targetDate) {
            const sourceDate = currentSelectedDate;
            
            if (sourceDate === targetDate) {
                alert("Cannot copy to the same date!");
                return;
            }
            
            // Show loading state
            const $btn = $("#copy-workout-btn, #copy-workout-mobile-btn");
            const originalContent = $btn.html();
            $btn.html('<i class="fas fa-spinner fa-spin me-1"></i> Copying...');
            $btn.prop('disabled', true);
            
            $.post("/workout/copy_session", {
                source_date: sourceDate,
                target_date: targetDate
            }, function(response) {
                $btn.html(originalContent);
                $btn.prop('disabled', false);
                
                if (response.success) {
                    alert("Workout copied successfully!");
                    $("#copyWorkoutModal").modal("hide");
                } else {
                    alert("Error: " + response.error);
                }
            }).fail(function() {
                $btn.html(originalContent);
                $btn.prop('disabled', false);
                alert("Network error. Please try again.");
            });
        }
        
        function navigateWeek(direction) {
            const days = direction === 'prev' ? -7 : 7
            currentDate.setDate(currentDate.getDate() + days);
            const weekDates = getWeekDates(currentDate);
            renderWeekDates(weekDates);
        }

        // ===== HELPER FUNCTIONS =====
        function resetSetForm(isMobile = false) {
            if (isMobile) {
                $("#sets-input-mobile").val("1");
                $("#reps-input-mobile").val("");
                $("#weight-input-mobile").val("");
                $("#rir-input-mobile").val("");
                $("#comments-input-mobile").val("");
            } else {
                $("#sets-input").val("1");
                $("#reps-input").val("");
                $("#weight-input").val("");
                $("#rir-input").val("");
                $("#comments-input").val("");
            }
        }
        
        function resetExerciseForm() {
            $("#new-exercise-name").val("");
            $("#new-exercise-desc").val("");
        }
        
        function getMuscleIcon(muscleGroup) {
            const icons = {
                'Chest': 'heart',
                'Back': 'user-shield',
                'Legs': 'running',
                'Shoulders': 'mountain',
                'Arms': 'hand-fist',
                'Core': 'apple-alt'
            };
            return icons[muscleGroup] || 'dumbbell';
        }
        
        function getWeekDates(date) {
            const dates = [];
            const d = new Date(date);
            const day = d.getDay();
            const diff = d.getDate() - day + (day === 0 ? -6 : 1); // adjust when Sunday
            const monday = new Date(d.setDate(diff));
            
            for (let i = 0; i < 7; i++) {
                const newDate = new Date(monday);
                newDate.setDate(monday.getDate() + i);
                dates.push(newDate.toISOString().split('T')[0]);
            }
            return dates;
        }
        
        function formatDate(date) {
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        }
        
        function getWeekNumber(date) {
            const firstDayOfYear = new Date(date.getFullYear(), 0, 1);
            const pastDaysOfYear = (date - firstDayOfYear) / 86400000;
            return Math.ceil((pastDaysOfYear + firstDayOfYear.getDay() + 1) / 7);
        }
        
        function saveScrollPosition() {
            savedScrollPosition = {
                desktop: $('#workout-session-container').scrollTop()
            };
        }
        
        function restoreScrollPosition() {
            // Desktop restoration
            if ($('#workout-session-container').is(':visible')) {
                $('#workout-session-container').scrollTop(savedScrollPosition.desktop);
            }
        }
        
        function generateDateOptions(centerDate) {
            const dates = [];
            const center = new Date(centerDate);
            
            // Generate -3 to +3 days from center date
            for (let i = -3; i <= 3; i++) {
                const date = new Date(center);
                date.setDate(center.getDate() + i);
                const dateStr = date.toISOString().split('T')[0];
                dates.push({
                    date: dateStr,
                    formatted: formatDateForSelector(date)
                });
            }
            return dates;
        }
        
        function formatDateForSelector(date) {
            const today = new Date();
            today.setHours(0,0,0,0);
            const yesterday = new Date(today);
            yesterday.setDate(today.getDate() - 1);
            const tomorrow = new Date(today);
            tomorrow.setDate(today.getDate() + 1);

            let dateString = date.toLocaleDateString('en-US', { 
                weekday: 'short', 
                month: 'short', 
                day: 'numeric' 
            });

            if (date.toDateString() === today.toDateString()) {
                return "Today - " + dateString;
            } else if (date.toDateString() === yesterday.toDateString()) {
                return "Yesterday - " + dateString;
            } else if (date.toDateString() === tomorrow.toDateString()) {
                return "Tomorrow - " + dateString;
            } else {
                return dateString;
            }
        }

        // ===== EVENT HANDLERS =====
        $(document).on('blur', '.set-input', handleSetUpdate);
        $(document).on('keyup', '.set-input', function(e) {
            if (e.key === 'Enter') {
                handleSetUpdate.call(this);
            }
        });
        
        $(document).on("click", ".delete-item", function() {
            const $button = $(this);
            const row = $button.closest("tr");
            const setId = row.data("set-id");
            
            if (!confirm("Are you sure you want to delete this set?")) return;
            
            // Disable button & show spinner
            $button.prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i>');
            
            // Call delete with button reference
            deleteSet(setId, $button);
        });
        
        function handleSetUpdate() {
            const row = $(this).closest("tr");
            const repsInput = row.find(".set-reps");
            const weightInput = row.find(".set-weight");

            // Validate input
            const repsVal = repsInput.val().trim();
            const weightVal = weightInput.val().trim();

            if (repsVal === "" || weightVal === "" || isNaN(repsVal) || isNaN(weightVal)) {
                // Reset back to original values if invalid
                repsInput.val(repsInput.data("original"));
                weightInput.val(weightInput.data("original"));
                return; 
            }

            const setId = row.data("set-id");
            const reps = parseFloat(repsVal);
            const weight = parseFloat(weightVal);
            const date = $(".workout-date.active").data("date");

            if (reps != repsInput.data("original") || weight != weightInput.data("original")) {
                const volumeDisplay = row.find(".volume-display");
                volumeDisplay.html('<i class="fas fa-spinner fa-spin"></i>');

                $.post("/workout/update_set", {
                    set_id: setId,
                    reps: reps,
                    weight: weight
                }, function(response) {
                    if (response.success) {
                        const volume = (reps * weight).toFixed(1);
                        volumeDisplay.text(volume);
                        repsInput.data("original", reps);
                        weightInput.data("original", weight);
                        saveScrollPosition();  
                        loadWorkoutSession(date);
                    } else {
                        alert("Error: " + response.error);
                        repsInput.val(repsInput.data("original"));
                        weightInput.val(weightInput.data("original"));
                        volumeDisplay.text(
                            (repsInput.data("original") * weightInput.data("original")).toFixed(1)
                        );
                    }
                });
            }
        }
    </script>
</div>
</body>
</html>
